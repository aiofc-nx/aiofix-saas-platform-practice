# SAASå¹³å°å®‰å…¨æ¶æ„ä¸æ•°æ®éš”ç¦»

## ğŸ” å®‰å…¨æ¶æ„ä¸æ•°æ®éš”ç¦»è®¾è®¡

### æ•°æ®éš”ç¦»ç­–ç•¥

#### 4.1 å¤šå±‚çº§æ•°æ®éš”ç¦»

```
æ•°æ®éš”ç¦»å±‚çº§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Platform Level                       â”‚
â”‚                 (å¹³å°çº§æ•°æ®éš”ç¦»)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     Tenant Level                        â”‚
â”‚                  (ç§Ÿæˆ·çº§æ•°æ®éš”ç¦»)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Organization Level                     â”‚
â”‚                 (ç»„ç»‡çº§æ•°æ®éš”ç¦»)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Department Level                     â”‚
â”‚                  (éƒ¨é—¨çº§æ•°æ®éš”ç¦»)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     User Level                         â”‚
â”‚                   (ç”¨æˆ·çº§æ•°æ®éš”ç¦»)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2 æ•°æ®éšç§çº§åˆ«

```
æ•°æ®éšç§çº§åˆ«ï¼š
1. PUBLICï¼ˆå…¬å¼€æ•°æ®ï¼‰
   - å¯ä»¥è¢«ä»»ä½•äººè®¿é—®
   - é€‚ç”¨äºå…¬å¼€ä¿¡æ¯

2. SHAREDï¼ˆå…±äº«æ•°æ®ï¼‰
   - å¯ä»¥åœ¨æŒ‡å®šèŒƒå›´å†…å…±äº«
   - é€‚ç”¨äºå†…éƒ¨å…±äº«ä¿¡æ¯

3. PROTECTEDï¼ˆå—ä¿æŠ¤æ•°æ®ï¼‰
   - éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½è®¿é—®
   - é€‚ç”¨äºæ•æ„Ÿä¿¡æ¯

4. PRIVATEï¼ˆç§æœ‰æ•°æ®ï¼‰
   - åªæœ‰æ‰€æœ‰è€…å¯ä»¥è®¿é—®
   - é€‚ç”¨äºä¸ªäººéšç§ä¿¡æ¯
```

### æ•°æ®éš”ç¦»ä¸è®¿é—®æ§åˆ¶æ¶æ„

#### æ•°æ®éš”ç¦»çº§åˆ«

```typescript
export enum DataIsolationLevel {
  /** å¹³å°çº§éš”ç¦» */
  PLATFORM = 'platform',
  /** ç§Ÿæˆ·çº§éš”ç¦» */
  TENANT = 'tenant',
  /** ç»„ç»‡çº§éš”ç¦» */
  ORGANIZATION = 'organization',
  /** éƒ¨é—¨çº§éš”ç¦» */
  DEPARTMENT = 'department',
  /** å­éƒ¨é—¨çº§éš”ç¦» */
  SUB_DEPARTMENT = 'sub_department',
  /** ç”¨æˆ·çº§éš”ç¦» */
  USER = 'user',
}

export enum DataPrivacyLevel {
  /** å¯å…±äº« */
  SHARED = 'shared',
  /** å—ä¿æŠ¤ */
  PROTECTED = 'protected',
}
```

#### æ•°æ®éš”ç¦»å±‚æ¬¡ç»“æ„

```
å¹³å° (Platform)
â”œâ”€â”€ å¹³å°çº§æ•°æ® (Platform Data)
â”‚   â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
â”‚   â”‚   â”œâ”€â”€ å¹³å°å…¬å‘Š
â”‚   â”‚   â”œâ”€â”€ ç³»ç»Ÿé€šçŸ¥
â”‚   â”‚   â”œâ”€â”€ å…¬å…±APIæ–‡æ¡£
â”‚   â”‚   â””â”€â”€ å¹³å°ç‰ˆæœ¬ä¿¡æ¯
â”‚   â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
â”‚       â”œâ”€â”€ å¹³å°é…ç½®
â”‚       â”œâ”€â”€ ç³»ç»Ÿæ—¥å¿—
â”‚       â”œâ”€â”€ ç®¡ç†å‘˜æ•°æ®
â”‚       â””â”€â”€ ç³»ç»Ÿç»´æŠ¤é…ç½®
â””â”€â”€ ç§Ÿæˆ· (Tenant)
    â”œâ”€â”€ ç§Ÿæˆ·çº§æ•°æ® (Tenant Data)
    â”‚   â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
    â”‚   â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
    â”œâ”€â”€ ç»„ç»‡ (Organization)
    â”‚   â”œâ”€â”€ ç»„ç»‡çº§æ•°æ® (Organization Data)
    â”‚   â”‚   â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
    â”‚   â”‚   â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
    â”‚   â”œâ”€â”€ éƒ¨é—¨ (Department)
    â”‚   â”‚   â”œâ”€â”€ éƒ¨é—¨çº§æ•°æ® (Department Data)
    â”‚   â”‚   â”‚   â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
    â”‚   â”‚   â”‚   â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
    â”‚   â”‚   â””â”€â”€ å­éƒ¨é—¨ (Sub-Department)
    â”‚   â”‚       â””â”€â”€ å­éƒ¨é—¨çº§æ•°æ® (Sub-Department Data)
    â”‚   â””â”€â”€ ç”¨æˆ·çº§æ•°æ® (User Data)
    â”‚       â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
    â”‚       â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
    â””â”€â”€ ç”¨æˆ·çº§æ•°æ® (User Data)
        â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
        â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
```

#### å®ä½“åŸºç±»è®¾è®¡

```typescript
// å¹³å°æ„ŸçŸ¥å®ä½“åŸºç±»
export abstract class PlatformAwareEntity extends BaseEntity {
  protected _dataPrivacyLevel: DataPrivacyLevel;

  constructor(
    id?: Uuid,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
  ) {
    super(id ?? Uuid.generate());
    this._dataPrivacyLevel = dataPrivacyLevel;
  }

  public canAccess(target: PlatformAwareEntity): boolean {
    try {
      // å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯å¯å…±äº«æ•°æ®ï¼Œåˆ™å…è®¸è®¿é—®
      if (target._dataPrivacyLevel === DataPrivacyLevel.SHARED) {
        return true;
      }

      // å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯å—ä¿æŠ¤æ•°æ®ï¼Œåˆ™éœ€è¦å¹³å°ç®¡ç†å‘˜æƒé™
      if (target._dataPrivacyLevel === DataPrivacyLevel.PROTECTED) {
        return this.isPlatformAdmin();
      }

      return false;
    } catch {
      return false;
    }
  }

  protected abstract isPlatformAdmin(): boolean;

  public isSharedData(): boolean {
    return this._dataPrivacyLevel === DataPrivacyLevel.SHARED;
  }

  public isProtectedData(): boolean {
    return this._dataPrivacyLevel === DataPrivacyLevel.PROTECTED;
  }

  protected assertPlatformAccess(target: PlatformAwareEntity): void {
    if (!this.canAccess(target)) {
      throw new PlatformAccessDeniedError(
        `å¹³å°çº§è®¿é—®è¢«æ‹’ç»: ç›®æ ‡å¯¹è±¡éšç§çº§åˆ«ä¸º${target._dataPrivacyLevel}`,
      );
    }
  }
}

// æ•°æ®éš”ç¦»æ„ŸçŸ¥å®ä½“åŸºç±»
export abstract class DataIsolationAwareEntity extends BaseEntity {
  protected readonly _tenantId: Uuid;
  protected _organizationId?: Uuid;
  protected _departmentIds: Uuid[] = [];
  protected _userId?: Uuid;
  protected _dataIsolationLevel: DataIsolationLevel;
  protected _dataPrivacyLevel: DataPrivacyLevel;

  constructor(
    tenantId: Uuid,
    dataIsolationLevel: DataIsolationLevel = DataIsolationLevel.TENANT,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid,
    organizationId?: Uuid,
    departmentIds: Uuid[] = [],
    userId?: Uuid,
  ) {
    super(id ?? Uuid.generate());
    this._tenantId = tenantId;
    this._dataIsolationLevel = dataIsolationLevel;
    this._dataPrivacyLevel = dataPrivacyLevel;
    this._organizationId = organizationId;
    this._departmentIds = [...departmentIds];
    this._userId = userId;
  }

  public canAccess(target: DataIsolationAwareEntity): boolean {
    try {
      // å¹³å°çº§æ•°æ®è®¿é—®æ§åˆ¶
      if (target._dataIsolationLevel === DataIsolationLevel.PLATFORM) {
        return this.canAccessPlatformData(target);
      }

      // ç”¨æˆ·çº§æ•°æ®è®¿é—®æ§åˆ¶ï¼ˆè·¨å±‚çº§å­˜åœ¨ï¼‰
      if (target._dataIsolationLevel === DataIsolationLevel.USER) {
        return this.canAccessUserData(target);
      }

      // å…¶ä»–çº§åˆ«çš„è®¿é—®æ§åˆ¶
      return this.canAccessByLevel(target, target._dataIsolationLevel);
    } catch {
      return false;
    }
  }

  private canAccessPlatformData(target: DataIsolationAwareEntity): boolean {
    if (target._dataPrivacyLevel === DataPrivacyLevel.SHARED) {
      return true; // å¯å…±äº«çš„å¹³å°æ•°æ®ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å¯è®¿é—®
    }
    return this.isPlatformAdmin();
  }

  private canAccessUserData(target: DataIsolationAwareEntity): boolean {
    if (target._dataPrivacyLevel === DataPrivacyLevel.SHARED) {
      return this.isInSameOrganization(target);
    }
    return this._userId?.equals(target._userId) ?? false;
  }

  private canAccessByLevel(
    target: DataIsolationAwareEntity,
    level: DataIsolationLevel,
  ): boolean {
    // é¦–å…ˆæ£€æŸ¥ç§Ÿæˆ·æ˜¯å¦åŒ¹é…
    if (!this._tenantId.equals(target.tenantId)) {
      return false;
    }

    // å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯ç§Ÿæˆ·çº§å…¬å…±æ•°æ®ï¼Œåˆ™å…è®¸è®¿é—®
    if (target._dataIsolationLevel === DataIsolationLevel.TENANT) {
      return true;
    }

    switch (level) {
      case DataIsolationLevel.TENANT:
        return true; // ç§Ÿæˆ·çº§è®¿é—®å…è®¸è®¿é—®æ‰€æœ‰åŒç§Ÿæˆ·æ•°æ®
      case DataIsolationLevel.ORGANIZATION:
        this.assertSameOrganization(target);
        return true;
      case DataIsolationLevel.DEPARTMENT:
        this.assertSameDepartment(target);
        return true;
      case DataIsolationLevel.SUB_DEPARTMENT:
        this.assertSameDepartment(target);
        return true;
      default:
        return false;
    }
  }

  protected assertSameTenant(other: DataIsolationAwareEntity): void {
    if (!this._tenantId.equals(other.tenantId)) {
      throw new TenantAccessDeniedError(
        `æ“ä½œç¦æ­¢: å®ä½“å±äºç§Ÿæˆ·${this._tenantId.toString()}ï¼Œç›®æ ‡å±äº${other.tenantId.toString()}`,
      );
    }
  }

  protected assertSameOrganization(other: DataIsolationAwareEntity): void {
    this.assertSameTenant(other);
    if (this._organizationId && other.organizationId) {
      if (!this._organizationId.equals(other.organizationId)) {
        throw new TenantAccessDeniedError(
          `æ“ä½œç¦æ­¢: å®ä½“å±äºç»„ç»‡${this._organizationId.toString()}ï¼Œç›®æ ‡å±äº${other.organizationId.toString()}`,
        );
      }
    }
  }

  protected assertSameDepartment(other: DataIsolationAwareEntity): void {
    this.assertSameOrganization(other);
    const commonDepartments = this._departmentIds.filter(deptId =>
      other.departmentIds.some(otherDeptId => deptId.equals(otherDeptId)),
    );
    if (commonDepartments.length === 0) {
      throw new TenantAccessDeniedError(
        `æ“ä½œç¦æ­¢: å®ä½“ä¸ç›®æ ‡å¯¹è±¡æ²¡æœ‰å…±åŒçš„éƒ¨é—¨å½’å±`,
      );
    }
  }
}
```

#### æ•°æ®éš”ç¦»å®ç°ç¤ºä¾‹

```typescript
// ç”¨æˆ·å®ä½“ - æ”¯æŒè·¨å±‚çº§å­˜åœ¨
export class User extends DataIsolationAwareEntity {
  private _username: string;
  private _email: string;
  private _status: UserStatus;

  constructor(
    tenantId: Uuid,
    username: string,
    email: string,
    organizationId?: Uuid,
    departmentIds: Uuid[] = [],
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid,
  ) {
    super(
      tenantId,
      DataIsolationLevel.USER,
      dataPrivacyLevel,
      id,
      organizationId,
      departmentIds,
      id, // userId ä¸å®ä½“IDç›¸åŒ
    );
    this._username = username;
    this._email = email;
    this._status = UserStatus.ACTIVE;
  }

  // é™æ€å·¥å‚æ–¹æ³• - åˆ›å»ºç§Ÿæˆ·çº§ç”¨æˆ·ï¼ˆæ— ç»„ç»‡å½’å±ï¼‰
  static createTenantUser(
    tenantId: Uuid,
    username: string,
    email: string,
  ): User {
    return new User(tenantId, username, email);
  }

  // é™æ€å·¥å‚æ–¹æ³• - åˆ›å»ºç»„ç»‡çº§ç”¨æˆ·
  static createOrganizationUser(
    tenantId: Uuid,
    username: string,
    email: string,
    organizationId: Uuid,
  ): User {
    return new User(tenantId, username, email, organizationId);
  }

  // é™æ€å·¥å‚æ–¹æ³• - åˆ›å»ºéƒ¨é—¨çº§ç”¨æˆ·
  static createDepartmentUser(
    tenantId: Uuid,
    username: string,
    email: string,
    organizationId: Uuid,
    departmentIds: Uuid[],
  ): User {
    return new User(tenantId, username, email, organizationId, departmentIds);
  }
}

// ç»„ç»‡å®ä½“ - ç»„ç»‡çº§éš”ç¦»
export class Organization extends DataIsolationAwareEntity {
  private _name: string;
  private _code: string;
  private _status: OrganizationStatus;

  constructor(
    tenantId: Uuid,
    name: string,
    code: string,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid,
  ) {
    super(
      tenantId,
      DataIsolationLevel.ORGANIZATION,
      dataPrivacyLevel,
      id,
      id, // organizationId ä¸å®ä½“IDç›¸åŒ
    );
    this._name = name;
    this._code = code;
    this._status = OrganizationStatus.ACTIVE;
  }
}

// éƒ¨é—¨å®ä½“ - éƒ¨é—¨çº§éš”ç¦»
export class Department extends DataIsolationAwareEntity {
  private _name: string;
  private _code: string;
  private _parentId?: Uuid;
  private _level: number;
  private _status: DepartmentStatus;

  constructor(
    tenantId: Uuid,
    organizationId: Uuid,
    name: string,
    code: string,
    level: number = 1,
    parentId?: Uuid,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid,
  ) {
    super(
      tenantId,
      DataIsolationLevel.DEPARTMENT,
      dataPrivacyLevel,
      id,
      organizationId,
      [id!], // departmentIds åŒ…å«å½“å‰éƒ¨é—¨ID
    );
    this._name = name;
    this._code = code;
    this._parentId = parentId;
    this._level = level;
    this._status = DepartmentStatus.ACTIVE;
  }
}

// ç§Ÿæˆ·é…ç½®å®ä½“ - ç§Ÿæˆ·çº§å…¬å…±æ•°æ®
export class TenantConfiguration extends DataIsolationAwareEntity {
  private _settings: Record<string, unknown> = {};

  constructor(
    tenantId: Uuid,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.SHARED,
    id?: Uuid,
  ) {
    super(tenantId, DataIsolationLevel.TENANT, dataPrivacyLevel, id);
  }

  getSetting(key: string): unknown {
    return this._settings[key];
  }

  setSetting(key: string, value: unknown): void {
    this._settings[key] = value;
    this.updateTimestamp();
  }
}

// å¹³å°é…ç½®å®ä½“ - å¹³å°çº§æ•°æ®
export class PlatformConfiguration extends PlatformAwareEntity {
  private readonly _key: string;
  private _value: unknown;
  private readonly _category: string;
  private readonly _isSystem: boolean;

  constructor(
    key: string,
    value: unknown,
    category: string,
    isSystem: boolean = false,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid,
  ) {
    super(id, dataPrivacyLevel);
    this._key = key;
    this._value = value;
    this._category = category;
    this._isSystem = isSystem;
  }

  override isPlatformAdmin(): boolean {
    // å®ç°å¹³å°ç®¡ç†å‘˜æƒé™æ£€æŸ¥é€»è¾‘
    return false;
  }
}
```

### è®¤è¯æ¶æ„

#### JWT Token è®¾è®¡

```typescript
interface JWTPayload {
  sub: string; // ç”¨æˆ·ID
  tenantId: string; // ç§Ÿæˆ·ID
  orgIds: string[]; // ç»„ç»‡IDåˆ—è¡¨
  deptIds: string[]; // éƒ¨é—¨IDåˆ—è¡¨
  roles: string[]; // è§’è‰²åˆ—è¡¨
  permissions: string[]; // æƒé™åˆ—è¡¨
  iat: number; // ç­¾å‘æ—¶é—´
  exp: number; // è¿‡æœŸæ—¶é—´
  jti: string; // JWT ID
}
```

#### å¤šå› å­è®¤è¯

```typescript
interface MFAConfig {
  type: 'TOTP' | 'SMS' | 'EMAIL';
  enabled: boolean;
  backupCodes: string[];
  lastUsed: Date;
}
```

### æƒé™æ§åˆ¶æ¶æ„

#### RBAC + ABAC + æ•°æ®éš”ç¦»æ··åˆæ¨¡å‹

```typescript
interface Permission {
  resource: string; // èµ„æºæ ‡è¯†
  action: string; // æ“ä½œç±»å‹
  conditions: Condition[]; // è®¿é—®æ¡ä»¶
  isolationLevel: DataIsolationLevel; // æ•°æ®éš”ç¦»çº§åˆ«
  privacyLevel: DataPrivacyLevel; // éšç§çº§åˆ«
}

interface Condition {
  attribute: string; // å±æ€§å
  operator: string; // æ“ä½œç¬¦
  value: any; // å±æ€§å€¼
}

// æƒé™æ£€æŸ¥æœåŠ¡
@Injectable()
export class PermissionService {
  constructor(
    private readonly dataAccessControlService: DataAccessControlService,
    private readonly userRepository: UserRepository,
    private readonly permissionRepository: PermissionRepository,
  ) {}

  async checkPermission(
    userId: string,
    resource: string,
    action: string,
    targetEntity?: DataIsolationAwareEntity,
  ): Promise<boolean> {
    // 1. è·å–ç”¨æˆ·ä¿¡æ¯
    const user = await this.userRepository.findById(userId);
    if (!user) {
      return false;
    }

    // 2. è·å–ç”¨æˆ·æƒé™
    const permissions = await this.permissionRepository.findUserPermissions(
      userId,
      user.tenantId,
    );

    // 3. æ£€æŸ¥æƒé™
    const hasPermission = permissions.some(
      permission =>
        permission.resource === resource && permission.action === action,
    );

    if (!hasPermission) {
      return false;
    }

    // 4. å¦‚æœæœ‰ç›®æ ‡å®ä½“ï¼Œè¿›è¡Œæ•°æ®éš”ç¦»æ£€æŸ¥
    if (targetEntity) {
      return user.canAccess(targetEntity);
    }

    return true;
  }

  async checkDataAccess(
    userId: string,
    targetEntity: DataIsolationAwareEntity,
  ): Promise<boolean> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      return false;
    }

    return user.canAccess(targetEntity);
  }
}
```

### æ•°æ®å®‰å…¨æ¶æ„

#### æ•°æ®éš”ç¦»ç­–ç•¥

- **å¹³å°çº§éš”ç¦»**: ç³»ç»Ÿçº§åˆ«éš”ç¦»ï¼Œåªæœ‰å¹³å°ç®¡ç†å‘˜å¯è®¿é—®
- **ç§Ÿæˆ·çº§éš”ç¦»**: æ•°æ®åº“çº§åˆ«éš”ç¦»ï¼Œç¡®ä¿ç§Ÿæˆ·é—´æ•°æ®å®Œå…¨éš”ç¦»
- **ç»„ç»‡çº§éš”ç¦»**: åº”ç”¨çº§åˆ«éš”ç¦»ï¼Œç»„ç»‡é—´æ•°æ®éš”ç¦»
- **éƒ¨é—¨çº§éš”ç¦»**: æ•°æ®çº§åˆ«éš”ç¦»ï¼Œéƒ¨é—¨é—´æ•°æ®éš”ç¦»
- **å­éƒ¨é—¨çº§éš”ç¦»**: ç»†ç²’åº¦æ•°æ®éš”ç¦»ï¼Œå­éƒ¨é—¨é—´æ•°æ®éš”ç¦»
- **ç”¨æˆ·çº§éš”ç¦»**: è¡Œçº§åˆ«éš”ç¦»ï¼Œç”¨æˆ·é—´æ•°æ®éš”ç¦»

#### æ•°æ®è®¿é—®æ§åˆ¶ç­–ç•¥

- **éšç§çº§åˆ«æ§åˆ¶**: åŸºäº `DataPrivacyLevel` çš„è®¿é—®æ§åˆ¶
  - **å¯å…±äº«æ•°æ®**: åŒçº§åˆ«å†…æ‰€æœ‰æˆå‘˜å¯è®¿é—®
  - **å—ä¿æŠ¤æ•°æ®**: éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½è®¿é—®
- **è·¨å±‚çº§è®¿é—®æ§åˆ¶**: æ”¯æŒä»é«˜çº§åˆ«å‘ä½çº§åˆ«çš„è®¿é—®æ§åˆ¶
- **ç”¨æˆ·çº§æ•°æ®è·¨å±‚çº§**: ç”¨æˆ·çº§æ•°æ®å¯ä»¥å­˜åœ¨äºä»»ä½•ç»„ç»‡å±‚çº§ä¸‹ï¼Œä½†è®¿é—®æ§åˆ¶åŸºäºç”¨æˆ·èº«ä»½

#### 4.14 ä¸ªäººæ•°æ®ä¸éƒ¨é—¨æ•°æ®è®¿é—®æ§åˆ¶æœºåˆ¶

##### 4.14.1 æ•°æ®åˆ†ç±»å®šä¹‰

```typescript
export enum DataOwnershipType {
  /** ä¸ªäººæ•°æ® - ç”¨æˆ·åˆ›å»ºå’Œæ‹¥æœ‰çš„æ•°æ® */
  PERSONAL = 'personal',
  /** éƒ¨é—¨æ•°æ® - éƒ¨é—¨å†…éƒ¨å…±äº«çš„æ•°æ® */
  DEPARTMENT = 'department',
  /** ç»„ç»‡æ•°æ® - ç»„ç»‡å†…éƒ¨å…±äº«çš„æ•°æ® */
  ORGANIZATION = 'organization',
  /** ç§Ÿæˆ·æ•°æ® - ç§Ÿæˆ·å†…éƒ¨å…±äº«çš„æ•°æ® */
  TENANT = 'tenant',
  /** å¹³å°æ•°æ® - å¹³å°çº§å…±äº«çš„æ•°æ® */
  PLATFORM = 'platform',
}

export enum DataAccessScope {
  /** ç§æœ‰è®¿é—® - åªæœ‰æ‰€æœ‰è€…å¯ä»¥è®¿é—® */
  PRIVATE = 'private',
  /** éƒ¨é—¨è®¿é—® - éƒ¨é—¨å†…æˆå‘˜å¯ä»¥è®¿é—® */
  DEPARTMENT = 'department',
  /** ç»„ç»‡è®¿é—® - ç»„ç»‡å†…æˆå‘˜å¯ä»¥è®¿é—® */
  ORGANIZATION = 'organization',
  /** ç§Ÿæˆ·è®¿é—® - ç§Ÿæˆ·å†…æˆå‘˜å¯ä»¥è®¿é—® */
  TENANT = 'tenant',
  /** å¹³å°è®¿é—® - å¹³å°å†…æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—® */
  PLATFORM = 'platform',
}
```

##### 4.14.2 æ•°æ®è®¿é—®æ§åˆ¶å®ä½“è®¾è®¡

```typescript
// æ•°æ®è®¿é—®æ§åˆ¶å®ä½“åŸºç±»
export abstract class DataAccessControlledEntity extends DataIsolationAwareEntity {
  protected _dataOwnershipType: DataOwnershipType;
  protected _dataAccessScope: DataAccessScope;
  protected _ownerId: Uuid;
  protected _sharedWithUsers: Uuid[] = [];
  protected _sharedWithDepartments: Uuid[] = [];
  protected _sharedWithOrganizations: Uuid[] = [];

  constructor(
    tenantId: Uuid,
    dataIsolationLevel: DataIsolationLevel,
    dataPrivacyLevel: DataPrivacyLevel,
    dataOwnershipType: DataOwnershipType,
    dataAccessScope: DataAccessScope,
    ownerId: Uuid,
    id?: Uuid,
    organizationId?: Uuid,
    departmentIds: Uuid[] = [],
    userId?: Uuid,
  ) {
    super(
      tenantId,
      dataIsolationLevel,
      dataPrivacyLevel,
      id,
      organizationId,
      departmentIds,
      userId,
    );
    this._dataOwnershipType = dataOwnershipType;
    this._dataAccessScope = dataAccessScope;
    this._ownerId = ownerId;
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®æ­¤å®ä½“
   * @param user è¯·æ±‚è®¿é—®çš„ç”¨æˆ·
   * @returns æ˜¯å¦å…è®¸è®¿é—®
   */
  public canAccess(user: DataIsolationAwareEntity): boolean {
    // 1. åŸºç¡€æ•°æ®éš”ç¦»æ£€æŸ¥
    if (!super.canAccess(user)) {
      return false;
    }

    // 2. æ‰€æœ‰è€…æ£€æŸ¥
    if (this._ownerId.equals(user.id)) {
      return true;
    }

    // 3. æ•°æ®è®¿é—®èŒƒå›´æ£€æŸ¥
    switch (this._dataAccessScope) {
      case DataAccessScope.PRIVATE:
        return false; // ç§æœ‰æ•°æ®åªæœ‰æ‰€æœ‰è€…å¯ä»¥è®¿é—®

      case DataAccessScope.DEPARTMENT:
        return this.canAccessByDepartment(user);

      case DataAccessScope.ORGANIZATION:
        return this.canAccessByOrganization(user);

      case DataAccessScope.TENANT:
        return this.canAccessByTenant(user);

      case DataAccessScope.PLATFORM:
        return true; // å¹³å°çº§æ•°æ®æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®

      default:
        return false;
    }
  }

  /**
   * éƒ¨é—¨çº§è®¿é—®æ§åˆ¶
   */
  private canAccessByDepartment(user: DataIsolationAwareEntity): boolean {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å…±äº«éƒ¨é—¨åˆ—è¡¨ä¸­
    if (this._sharedWithDepartments.length > 0) {
      const userDepartments = user.departmentIds || [];
      return this._sharedWithDepartments.some(deptId =>
        userDepartments.some(userDeptId => deptId.equals(userDeptId)),
      );
    }

    // å¦‚æœæ²¡æœ‰æŒ‡å®šå…±äº«éƒ¨é—¨ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸æ‰€æœ‰è€…åœ¨åŒä¸€éƒ¨é—¨
    if (this._organizationId && user.organizationId) {
      if (!this._organizationId.equals(user.organizationId)) {
        return false;
      }

      const userDepartments = user.departmentIds || [];
      const ownerDepartments = this._departmentIds || [];

      return userDepartments.some(userDeptId =>
        ownerDepartments.some(ownerDeptId => userDeptId.equals(ownerDeptId)),
      );
    }

    return false;
  }

  /**
   * ç»„ç»‡çº§è®¿é—®æ§åˆ¶
   */
  private canAccessByOrganization(user: DataIsolationAwareEntity): boolean {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å…±äº«ç»„ç»‡åˆ—è¡¨ä¸­
    if (this._sharedWithOrganizations.length > 0) {
      return this._sharedWithOrganizations.some(
        orgId => user.organizationId && orgId.equals(user.organizationId),
      );
    }

    // å¦‚æœæ²¡æœ‰æŒ‡å®šå…±äº«ç»„ç»‡ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸æ‰€æœ‰è€…åœ¨åŒä¸€ç»„ç»‡
    return (
      this._organizationId &&
      user.organizationId &&
      this._organizationId.equals(user.organizationId)
    );
  }

  /**
   * ç§Ÿæˆ·çº§è®¿é—®æ§åˆ¶
   */
  private canAccessByTenant(user: DataIsolationAwareEntity): boolean {
    // ç§Ÿæˆ·çº§æ•°æ®ï¼ŒåŒç§Ÿæˆ·å†…æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®
    return this._tenantId.equals(user.tenantId);
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šç”¨æˆ·
   */
  public shareWithUser(userId: Uuid): void {
    if (!this._sharedWithUsers.some(id => id.equals(userId))) {
      this._sharedWithUsers.push(userId);
    }
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šéƒ¨é—¨
   */
  public shareWithDepartment(departmentId: Uuid): void {
    if (!this._sharedWithDepartments.some(id => id.equals(departmentId))) {
      this._sharedWithDepartments.push(departmentId);
    }
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šç»„ç»‡
   */
  public shareWithOrganization(organizationId: Uuid): void {
    if (!this._sharedWithOrganizations.some(id => id.equals(organizationId))) {
      this._sharedWithOrganizations.push(organizationId);
    }
  }

  /**
   * æ’¤é”€ç”¨æˆ·è®¿é—®æƒé™
   */
  public revokeUserAccess(userId: Uuid): void {
    this._sharedWithUsers = this._sharedWithUsers.filter(
      id => !id.equals(userId),
    );
  }

  /**
   * æ’¤é”€éƒ¨é—¨è®¿é—®æƒé™
   */
  public revokeDepartmentAccess(departmentId: Uuid): void {
    this._sharedWithDepartments = this._sharedWithDepartments.filter(
      id => !id.equals(departmentId),
    );
  }

  /**
   * æ’¤é”€ç»„ç»‡è®¿é—®æƒé™
   */
  public revokeOrganizationAccess(organizationId: Uuid): void {
    this._sharedWithOrganizations = this._sharedWithOrganizations.filter(
      id => !id.equals(organizationId),
    );
  }

  // Getters
  get dataOwnershipType(): DataOwnershipType {
    return this._dataOwnershipType;
  }

  get dataAccessScope(): DataAccessScope {
    return this._dataAccessScope;
  }

  get ownerId(): Uuid {
    return this._ownerId;
  }

  get sharedWithUsers(): Uuid[] {
    return [...this._sharedWithUsers];
  }

  get sharedWithDepartments(): Uuid[] {
    return [...this._sharedWithDepartments];
  }

  get sharedWithOrganizations(): Uuid[] {
    return [...this._sharedWithOrganizations];
  }
}
```

##### 4.14.3 ä¸šåŠ¡å®ä½“å®ç°ç¤ºä¾‹

```typescript
// ä¸ªäººæ•°æ®å®ä½“ - ç”¨æˆ·åˆ›å»ºå’Œæ‹¥æœ‰çš„æ•°æ®
export class PersonalDocument extends DataAccessControlledEntity {
  private _title: string;
  private _content: string;
  private _tags: string[] = [];
  private _createdAt: Date;
  private _updatedAt: Date;

  constructor(
    tenantId: Uuid,
    ownerId: Uuid,
    title: string,
    content: string,
    organizationId?: Uuid,
    departmentIds: Uuid[] = [],
    id?: Uuid,
  ) {
    super(
      tenantId,
      DataIsolationLevel.USER,
      DataPrivacyLevel.PROTECTED,
      DataOwnershipType.PERSONAL,
      DataAccessScope.PRIVATE, // é»˜è®¤ç§æœ‰è®¿é—®
      ownerId,
      id,
      organizationId,
      departmentIds,
      ownerId,
    );
    this._title = title;
    this._content = content;
    this._createdAt = new Date();
    this._updatedAt = new Date();
  }

  /**
   * å…±äº«æ–‡æ¡£ç»™æŒ‡å®šç”¨æˆ·
   */
  shareWithUser(userId: Uuid): void {
    super.shareWithUser(userId);
    this._dataAccessScope = DataAccessScope.PRIVATE; // ä¿æŒç§æœ‰ï¼Œä½†å…è®¸ç‰¹å®šç”¨æˆ·è®¿é—®
  }

  /**
   * å…±äº«æ–‡æ¡£ç»™éƒ¨é—¨
   */
  shareWithDepartment(departmentId: Uuid): void {
    super.shareWithDepartment(departmentId);
    this._dataAccessScope = DataAccessScope.DEPARTMENT;
  }

  /**
   * å…±äº«æ–‡æ¡£ç»™ç»„ç»‡
   */
  shareWithOrganization(organizationId: Uuid): void {
    super.shareWithOrganization(organizationId);
    this._dataAccessScope = DataAccessScope.ORGANIZATION;
  }

  /**
   * å‘å¸ƒä¸ºç§Ÿæˆ·çº§æ–‡æ¡£
   */
  publishToTenant(): void {
    this._dataAccessScope = DataAccessScope.TENANT;
    this._dataOwnershipType = DataOwnershipType.TENANT;
  }

  // Getters
  get title(): string {
    return this._title;
  }

  get content(): string {
    return this._content;
  }

  get tags(): string[] {
    return [...this._tags];
  }

  get createdAt(): Date {
    return this._createdAt;
  }

  get updatedAt(): Date {
    return this._updatedAt;
  }
}

// éƒ¨é—¨æ•°æ®å®ä½“ - éƒ¨é—¨å†…éƒ¨å…±äº«çš„æ•°æ®
export class DepartmentProject extends DataAccessControlledEntity {
  private _name: string;
  private _description: string;
  private _status: ProjectStatus;
  private _startDate: Date;
  private _endDate?: Date;
  private _teamMembers: Uuid[] = [];
  private _createdAt: Date;
  private _updatedAt: Date;

  constructor(
    tenantId: Uuid,
    organizationId: Uuid,
    departmentIds: Uuid[],
    ownerId: Uuid,
    name: string,
    description: string,
    id?: Uuid,
  ) {
    super(
      tenantId,
      DataIsolationLevel.DEPARTMENT,
      DataPrivacyLevel.PROTECTED,
      DataOwnershipType.DEPARTMENT,
      DataAccessScope.DEPARTMENT, // éƒ¨é—¨å†…å…±äº«
      ownerId,
      id,
      organizationId,
      departmentIds,
      ownerId,
    );
    this._name = name;
    this._description = description;
    this._status = ProjectStatus.PLANNING;
    this._startDate = new Date();
    this._createdAt = new Date();
    this._updatedAt = new Date();
  }

  /**
   * æ·»åŠ å›¢é˜Ÿæˆå‘˜
   */
  addTeamMember(userId: Uuid): void {
    if (!this._teamMembers.some(id => id.equals(userId))) {
      this._teamMembers.push(userId);
    }
  }

  /**
   * ç§»é™¤å›¢é˜Ÿæˆå‘˜
   */
  removeTeamMember(userId: Uuid): void {
    this._teamMembers = this._teamMembers.filter(id => !id.equals(userId));
  }

  /**
   * æ‰©å±•é¡¹ç›®åˆ°å…¶ä»–éƒ¨é—¨
   */
  extendToDepartments(departmentIds: Uuid[]): void {
    departmentIds.forEach(deptId => {
      if (!this._departmentIds.some(id => id.equals(deptId))) {
        this._departmentIds.push(deptId);
      }
    });
  }

  /**
   * æ‰©å±•é¡¹ç›®åˆ°ç»„ç»‡çº§
   */
  extendToOrganization(): void {
    this._dataAccessScope = DataAccessScope.ORGANIZATION;
    this._dataOwnershipType = DataOwnershipType.ORGANIZATION;
  }

  // Getters
  get name(): string {
    return this._name;
  }

  get description(): string {
    return this._description;
  }

  get status(): ProjectStatus {
    return this._status;
  }

  get startDate(): Date {
    return this._startDate;
  }

  get endDate(): Date | undefined {
    return this._endDate;
  }

  get teamMembers(): Uuid[] {
    return [...this._teamMembers];
  }

  get createdAt(): Date {
    return this._createdAt;
  }

  get updatedAt(): Date {
    return this._updatedAt;
  }
}

// ç»„ç»‡æ•°æ®å®ä½“ - ç»„ç»‡å†…éƒ¨å…±äº«çš„æ•°æ®
export class OrganizationPolicy extends DataAccessControlledEntity {
  private _name: string;
  private _content: string;
  private _category: PolicyCategory;
  private _version: string;
  private _effectiveDate: Date;
  private _expiryDate?: Date;
  private _approvalStatus: ApprovalStatus;
  private _approvedBy?: Uuid;
  private _approvedAt?: Date;
  private _createdAt: Date;
  private _updatedAt: Date;

  constructor(
    tenantId: Uuid,
    organizationId: Uuid,
    ownerId: Uuid,
    name: string,
    content: string,
    category: PolicyCategory,
    id?: Uuid,
  ) {
    super(
      tenantId,
      DataIsolationLevel.ORGANIZATION,
      DataPrivacyLevel.PROTECTED,
      DataOwnershipType.ORGANIZATION,
      DataAccessScope.ORGANIZATION, // ç»„ç»‡å†…å…±äº«
      ownerId,
      id,
      organizationId,
      [],
      ownerId,
    );
    this._name = name;
    this._content = content;
    this._category = category;
    this._version = '1.0.0';
    this._effectiveDate = new Date();
    this._approvalStatus = ApprovalStatus.DRAFT;
    this._createdAt = new Date();
    this._updatedAt = new Date();
  }

  /**
   * æäº¤å®¡æ‰¹
   */
  submitForApproval(): void {
    this._approvalStatus = ApprovalStatus.PENDING;
    this._updatedAt = new Date();
  }

  /**
   * å®¡æ‰¹é€šè¿‡
   */
  approve(approverId: Uuid): void {
    this._approvalStatus = ApprovalStatus.APPROVED;
    this._approvedBy = approverId;
    this._approvedAt = new Date();
    this._updatedAt = new Date();
  }

  /**
   * å®¡æ‰¹æ‹’ç»
   */
  reject(reason: string): void {
    this._approvalStatus = ApprovalStatus.REJECTED;
    this._updatedAt = new Date();
  }

  /**
   * å‘å¸ƒåˆ°ç§Ÿæˆ·çº§
   */
  publishToTenant(): void {
    this._dataAccessScope = DataAccessScope.TENANT;
    this._dataOwnershipType = DataOwnershipType.TENANT;
    this._updatedAt = new Date();
  }

  // Getters
  get name(): string {
    return this._name;
  }

  get content(): string {
    return this._content;
  }

  get category(): PolicyCategory {
    return this._category;
  }

  get version(): string {
    return this._version;
  }

  get effectiveDate(): Date {
    return this._effectiveDate;
  }

  get expiryDate(): Date | undefined {
    return this._expiryDate;
  }

  get approvalStatus(): ApprovalStatus {
    return this._approvalStatus;
  }

  get approvedBy(): Uuid | undefined {
    return this._approvedBy;
  }

  get approvedAt(): Date | undefined {
    return this._approvedAt;
  }

  get createdAt(): Date {
    return this._createdAt;
  }

  get updatedAt(): Date {
    return this._updatedAt;
  }
}
```

##### 4.14.4 æ•°æ®è®¿é—®æ§åˆ¶æœåŠ¡

```typescript
// æ•°æ®è®¿é—®æ§åˆ¶æœåŠ¡
@Injectable()
export class DataAccessControlService {
  constructor(
    private readonly userRepository: UserRepository,
    private readonly organizationRepository: OrganizationRepository,
    private readonly departmentRepository: DepartmentRepository,
    private readonly cacheService: CacheService,
  ) {}

  /**
   * æ£€æŸ¥ç”¨æˆ·å¯¹æŒ‡å®šå®ä½“çš„è®¿é—®æƒé™
   */
  async checkDataAccess(
    userId: string,
    targetEntity: DataAccessControlledEntity,
  ): Promise<boolean> {
    // 1. ä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯
    const cacheKey = `user:${userId}:access_control`;
    let user = await this.cacheService.get(cacheKey);

    if (!user) {
      user = await this.userRepository.findById(userId);
      if (!user) {
        return false;
      }
      // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯5åˆ†é’Ÿ
      await this.cacheService.set(cacheKey, user, 300);
    }

    // 2. åŸºç¡€æ•°æ®éš”ç¦»æ£€æŸ¥
    if (!user.canAccess(targetEntity)) {
      return false;
    }

    // 3. æ•°æ®è®¿é—®æ§åˆ¶æ£€æŸ¥
    return targetEntity.canAccess(user);
  }

  /**
   * è·å–ç”¨æˆ·å¯ä»¥è®¿é—®çš„ä¸ªäººæ•°æ®
   */
  async getAccessiblePersonalData(
    userId: string,
    ownerId?: string,
    page: number = 1,
    size: number = 20,
  ): Promise<PaginatedResponse<PersonalDocument>> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      throw new UserNotFoundException(userId);
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const conditions: any = {
      tenantId: user.tenantId,
      $or: [
        { ownerId: userId }, // è‡ªå·±åˆ›å»ºçš„æ•°æ®
        { sharedWithUsers: userId }, // å…±äº«ç»™è‡ªå·±çš„æ•°æ®
      ],
    };

    // å¦‚æœæŒ‡å®šäº†æ‰€æœ‰è€…ï¼Œæ·»åŠ æ‰€æœ‰è€…æ¡ä»¶
    if (ownerId) {
      conditions.ownerId = ownerId;
    }

    // æ·»åŠ éƒ¨é—¨å’Œç»„ç»‡è®¿é—®æ¡ä»¶
    if (user.organizationId) {
      conditions.$or.push({
        sharedWithOrganizations: user.organizationId,
      });
    }

    if (user.departmentIds && user.departmentIds.length > 0) {
      conditions.$or.push({
        sharedWithDepartments: { $in: user.departmentIds },
      });
    }

    return this.personalDocumentRepository.findByConditions(
      conditions,
      page,
      size,
    );
  }

  /**
   * è·å–ç”¨æˆ·å¯ä»¥è®¿é—®çš„éƒ¨é—¨æ•°æ®
   */
  async getAccessibleDepartmentData(
    userId: string,
    departmentId?: string,
    page: number = 1,
    size: number = 20,
  ): Promise<PaginatedResponse<DepartmentProject>> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      throw new UserNotFoundException(userId);
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const conditions: any = {
      tenantId: user.tenantId,
      $or: [
        { ownerId: userId }, // è‡ªå·±åˆ›å»ºçš„æ•°æ®
        { sharedWithUsers: userId }, // å…±äº«ç»™è‡ªå·±çš„æ•°æ®
      ],
    };

    // å¦‚æœæŒ‡å®šäº†éƒ¨é—¨ï¼Œæ·»åŠ éƒ¨é—¨æ¡ä»¶
    if (departmentId) {
      conditions.departmentIds = departmentId;
    } else {
      // å¦‚æœæ²¡æœ‰æŒ‡å®šéƒ¨é—¨ï¼ŒæŸ¥è¯¢ç”¨æˆ·æ‰€åœ¨éƒ¨é—¨çš„æ•°æ®
      if (user.departmentIds && user.departmentIds.length > 0) {
        conditions.departmentIds = { $in: user.departmentIds };
      }
    }

    // æ·»åŠ ç»„ç»‡è®¿é—®æ¡ä»¶
    if (user.organizationId) {
      conditions.$or.push({
        sharedWithOrganizations: user.organizationId,
      });
    }

    return this.departmentProjectRepository.findByConditions(
      conditions,
      page,
      size,
    );
  }

  /**
   * è·å–ç”¨æˆ·å¯ä»¥è®¿é—®çš„ç»„ç»‡æ•°æ®
   */
  async getAccessibleOrganizationData(
    userId: string,
    organizationId?: string,
    page: number = 1,
    size: number = 20,
  ): Promise<PaginatedResponse<OrganizationPolicy>> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      throw new UserNotFoundException(userId);
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const conditions: any = {
      tenantId: user.tenantId,
      $or: [
        { ownerId: userId }, // è‡ªå·±åˆ›å»ºçš„æ•°æ®
        { sharedWithUsers: userId }, // å…±äº«ç»™è‡ªå·±çš„æ•°æ®
      ],
    };

    // å¦‚æœæŒ‡å®šäº†ç»„ç»‡ï¼Œæ·»åŠ ç»„ç»‡æ¡ä»¶
    if (organizationId) {
      conditions.organizationId = organizationId;
    } else {
      // å¦‚æœæ²¡æœ‰æŒ‡å®šç»„ç»‡ï¼ŒæŸ¥è¯¢ç”¨æˆ·æ‰€åœ¨ç»„ç»‡çš„æ•°æ®
      if (user.organizationId) {
        conditions.organizationId = user.organizationId;
      }
    }

    return this.organizationPolicyRepository.findByConditions(
      conditions,
      page,
      size,
    );
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™å…±äº«æ•°æ®
   */
  async canShareData(
    userId: string,
    targetEntity: DataAccessControlledEntity,
  ): Promise<boolean> {
    // 1. æ£€æŸ¥æ˜¯å¦æ˜¯æ•°æ®æ‰€æœ‰è€…
    if (targetEntity.ownerId.equals(userId)) {
      return true;
    }

    // 2. æ£€æŸ¥æ˜¯å¦æœ‰å…±äº«æƒé™
    const user = await this.userRepository.findById(userId);
    if (!user) {
      return false;
    }

    // 3. æ£€æŸ¥ç”¨æˆ·æƒé™
    return this.checkUserPermission(user, 'data', 'share', targetEntity);
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šç”¨æˆ·
   */
  async shareDataWithUser(
    userId: string,
    targetEntity: DataAccessControlledEntity,
    targetUserId: string,
  ): Promise<void> {
    // æ£€æŸ¥æƒé™
    if (!(await this.canShareData(userId, targetEntity))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™å…±äº«æ­¤æ•°æ®');
    }

    // æ‰§è¡Œå…±äº«
    targetEntity.shareWithUser(new Uuid(targetUserId));

    // ä¿å­˜å®ä½“
    await this.saveEntity(targetEntity);

    // è®°å½•å®¡è®¡æ—¥å¿—
    await this.auditService.logDataSharing(
      userId,
      targetEntity.id.toString(),
      'USER',
      targetUserId,
    );
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šéƒ¨é—¨
   */
  async shareDataWithDepartment(
    userId: string,
    targetEntity: DataAccessControlledEntity,
    departmentId: string,
  ): Promise<void> {
    // æ£€æŸ¥æƒé™
    if (!(await this.canShareData(userId, targetEntity))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™å…±äº«æ­¤æ•°æ®');
    }

    // æ‰§è¡Œå…±äº«
    targetEntity.shareWithDepartment(new Uuid(departmentId));

    // ä¿å­˜å®ä½“
    await this.saveEntity(targetEntity);

    // è®°å½•å®¡è®¡æ—¥å¿—
    await this.auditService.logDataSharing(
      userId,
      targetEntity.id.toString(),
      'DEPARTMENT',
      departmentId,
    );
  }

  /**
   * æ’¤é”€æ•°æ®è®¿é—®æƒé™
   */
  async revokeDataAccess(
    userId: string,
    targetEntity: DataAccessControlledEntity,
    targetType: 'USER' | 'DEPARTMENT' | 'ORGANIZATION',
    targetId: string,
  ): Promise<void> {
    // æ£€æŸ¥æƒé™
    if (!(await this.canShareData(userId, targetEntity))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™æ’¤é”€æ­¤æ•°æ®çš„è®¿é—®æƒé™');
    }

    // æ‰§è¡Œæ’¤é”€
    switch (targetType) {
      case 'USER':
        targetEntity.revokeUserAccess(new Uuid(targetId));
        break;
      case 'DEPARTMENT':
        targetEntity.revokeDepartmentAccess(new Uuid(targetId));
        break;
      case 'ORGANIZATION':
        targetEntity.revokeOrganizationAccess(new Uuid(targetId));
        break;
    }

    // ä¿å­˜å®ä½“
    await this.saveEntity(targetEntity);

    // è®°å½•å®¡è®¡æ—¥å¿—
    await this.auditService.logDataAccessRevocation(
      userId,
      targetEntity.id.toString(),
      targetType,
      targetId,
    );
  }

  /**
   * è·å–æ•°æ®è®¿é—®æƒé™åˆ—è¡¨
   */
  async getDataAccessPermissions(
    entityId: string,
  ): Promise<DataAccessPermissions> {
    const entity = await this.getEntityById(entityId);
    if (!entity) {
      throw new EntityNotFoundException(entityId);
    }

    return {
      ownerId: entity.ownerId.toString(),
      dataOwnershipType: entity.dataOwnershipType,
      dataAccessScope: entity.dataAccessScope,
      sharedWithUsers: entity.sharedWithUsers.map(id => id.toString()),
      sharedWithDepartments: entity.sharedWithDepartments.map(id =>
        id.toString(),
      ),
      sharedWithOrganizations: entity.sharedWithOrganizations.map(id =>
        id.toString(),
      ),
    };
  }

  private async checkUserPermission(
    user: User,
    resource: string,
    action: string,
    targetEntity?: DataAccessControlledEntity,
  ): Promise<boolean> {
    // å®ç°ç”¨æˆ·æƒé™æ£€æŸ¥é€»è¾‘
    // è¿™é‡Œå¯ä»¥é›†æˆç°æœ‰çš„æƒé™ç³»ç»Ÿ
    return true; // ç®€åŒ–å®ç°
  }

  private async saveEntity(entity: DataAccessControlledEntity): Promise<void> {
    // æ ¹æ®å®ä½“ç±»å‹ä¿å­˜åˆ°å¯¹åº”çš„ä»“å‚¨
    // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…å®ç°è°ƒæ•´
  }

  private async getEntityById(
    entityId: string,
  ): Promise<DataAccessControlledEntity | null> {
    // æ ¹æ®å®ä½“IDè·å–å®ä½“
    // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…å®ç°è°ƒæ•´
    return null;
  }
}

// æ•°æ®è®¿é—®æƒé™ä¿¡æ¯
interface DataAccessPermissions {
  ownerId: string;
  dataOwnershipType: DataOwnershipType;
  dataAccessScope: DataAccessScope;
  sharedWithUsers: string[];
  sharedWithDepartments: string[];
  sharedWithOrganizations: string[];
}

// æšä¸¾å®šä¹‰
export enum ProjectStatus {
  PLANNING = 'planning',
  IN_PROGRESS = 'in_progress',
  COMPLETED = 'completed',
  ON_HOLD = 'on_hold',
  CANCELLED = 'cancelled',
}

export enum PolicyCategory {
  HR = 'hr',
  FINANCE = 'finance',
  IT = 'it',
  SECURITY = 'security',
  COMPLIANCE = 'compliance',
  OPERATIONS = 'operations',
}

export enum ApprovalStatus {
  DRAFT = 'draft',
  PENDING = 'pending',
  APPROVED = 'approved',
  REJECTED = 'rejected',
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**åˆ›å»ºæ—¥æœŸ**: 2024-12-19  
**é€‚ç”¨èŒƒå›´**: SAASå¹³å°å®‰å…¨æ¶æ„ä¸æ•°æ®éš”ç¦»è®¾è®¡æŒ‡å¯¼
