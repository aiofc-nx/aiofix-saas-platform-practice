# SAASå¹³å°æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## ğŸ¯ æŠ€æœ¯è®¾è®¡æ¦‚è¿°

### è®¾è®¡ç›®æ ‡

åŸºäºä¸šåŠ¡éœ€æ±‚æ–‡æ¡£ï¼Œè®¾è®¡ä¸€ä¸ªé«˜æ€§èƒ½ã€å¯æ‰©å±•ã€å®‰å…¨çš„ SAAS å¹³å°ï¼Œæ”¯æŒå¤šç§Ÿæˆ·ã€å¤šç»„ç»‡ã€å¤šéƒ¨é—¨çš„å¤æ‚ä¸šåŠ¡åœºæ™¯ã€‚å¹³å°å°†å¹³å°ã€ç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨ã€ç”¨æˆ·ã€è®¤è¯æˆæƒç­‰é¢†åŸŸä½œä¸ºæ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒæ—¶å°†ä¾§é‡äºä¸šåŠ¡é¢†åŸŸçš„å¹³å°ã€ç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨ã€ç”¨æˆ·ä¸è®¤è¯æˆæƒåˆ†ç¦»ï¼Œç¡®ä¿èŒè´£æ¸…æ™°ã€‚ä¸ºä»Šåæ¨ªå‘æ‰©å±•å¢åŠ å…¶ä»–ä¸šåŠ¡é¢†åŸŸæ¨¡å—ï¼Œä¾‹å¦‚ï¼šäººåŠ›èµ„æºã€è´¢åŠ¡ç®¡ç†ã€è¿›é”€å­˜ã€å®¢æˆ·å…³ç³»ç®¡ç†ã€AIæ‹“å±•ç­‰å¥ å®šåšå®çš„åŸºç¡€ã€‚

### æ¶æ„ç‰¹ç‚¹

- **å•ä½“åº”ç”¨ä¼˜å…ˆ**ï¼šé‡‡ç”¨å•ä½“åº”ç”¨æ¶æ„ï¼Œä¾¿äºå¼€å‘å’Œç»´æŠ¤
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šé€šè¿‡æ¨¡å—åŒ–è®¾è®¡å®ç°é«˜å†…èšä½è€¦åˆ
- **å¯æ‰©å±•æ€§**ï¼šä¸ºæœªæ¥å¾®æœåŠ¡åŒ–é¢„ç•™æ¥å£å’Œè®¾è®¡ç©ºé—´
- **æŠ€æœ¯æ ˆç®€åŒ–**ï¼šé¿å…è¿‡åº¦è®¾è®¡ï¼Œé€‰æ‹©å¿…è¦çš„æŠ€æœ¯ç»„ä»¶

### æ¶æ„ç›®æ ‡

SAASå¹³å°çš„é¢†åŸŸæ¶æ„ï¼Œå®ç°ï¼š

1. **èŒè´£æ¸…æ™°**ï¼šæ¯ä¸ªæ¨¡å—éƒ½æœ‰æ˜ç¡®çš„ä¸šåŠ¡è¾¹ç•Œ
2. **é«˜å†…èšä½è€¦åˆ**ï¼šæ¨¡å—å†…éƒ¨é«˜å†…èšï¼Œæ¨¡å—é—´ä½è€¦åˆ
3. **å¯å¤ç”¨æ€§**ï¼šåŸºç¡€æ¨¡å—å¯ä»¥è¢«å¤šä¸ªä¸šåŠ¡åœºæ™¯å¤ç”¨
4. **å¯æ‰©å±•æ€§**ï¼šæ¯ä¸ªæ¨¡å—å¯ä»¥ç‹¬ç«‹æ¼”è¿›å’Œæ‰©å±•
5. **å›¢é˜Ÿåä½œå‹å¥½**ï¼šä¸åŒå›¢é˜Ÿå¯ä»¥ä¸“æ³¨ä¸åŒæ¨¡å—

### æŠ€æœ¯æ¶æ„åŸåˆ™

é¡¹ç›®é‡‡ç”¨æ··åˆæ¶æ„ï¼ŒæŠ€æœ¯æ ˆåŒ…æ‹¬ï¼šClean Architecture + RESTful API + CQRS + GraphQL + äº‹ä»¶æº¯æº + å¤šæ•°æ®åº“æ”¯æŒ + å•ä½“åº”ç”¨æ¶æ„

1. **åˆ†å±‚æ¶æ„**: éµå¾ª Clean Architecture åˆ†å±‚è®¾è®¡
2. **é¢†åŸŸé©±åŠ¨**: åŸºäº DDD æ€æƒ³è¿›è¡Œé¢†åŸŸå»ºæ¨¡
3. **CQRS æ¨¡å¼**: å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»
4. **GraphQL æ”¯æŒ**: çµæ´»æŸ¥è¯¢å’Œæ•°æ®è·å–
5. **äº‹ä»¶æº¯æº**: é‡‡ç”¨ Event Sourcing æ¨¡å¼
6. **å¤šæ•°æ®åº“**: æ”¯æŒ PostgreSQL å’Œ MongoDB
7. **æ•°æ®éš”ç¦»**: å®Œæ•´çš„å¤šå±‚çº§æ•°æ®éš”ç¦»ç­–ç•¥
8. **è®¿é—®æ§åˆ¶**: åŸºäºéš”ç¦»çº§åˆ«å’Œéšç§çº§åˆ«çš„ç»†ç²’åº¦è®¿é—®æ§åˆ¶
9. **é«˜æ€§èƒ½**: æ”¯æŒç™¾ä¸‡çº§ç”¨æˆ·å’Œå¤æ‚æƒé™åœºæ™¯
10. **é«˜å®‰å…¨**: å¤šå±‚æ¬¡å®‰å…¨é˜²æŠ¤æœºåˆ¶
11. **æ ¸å¿ƒåŠŸèƒ½åˆ†ç¦»**: å°†ä¸šåŠ¡ç®¡ç†é¢†åŸŸï¼ˆå¹³å°ã€ç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨ã€ç”¨æˆ·ï¼‰ä¸è®¤è¯æˆæƒé¢†åŸŸåˆ†ç¦»ï¼Œç¡®ä¿èŒè´£æ¸…æ™°
12. **ç›®å½•ç»“æ„è®¾è®¡**: éµå¾ªé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰æ€æƒ³ï¼Œä»£ç ç›®å½•æ¶æ„åº”å½“é¦–å…ˆä½“ç°é¢†åŸŸçš„è¾¹ç•Œ

### æ¶æ„è®¾è®¡åŸåˆ™

```
æ¶æ„è®¾è®¡åŸåˆ™ï¼š
1. å•ä¸€èŒè´£åŸåˆ™ï¼šæ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„ä¸šåŠ¡é¢†åŸŸ
2. é«˜å†…èšä½è€¦åˆï¼šæ¨¡å—å†…éƒ¨é«˜å†…èšï¼Œæ¨¡å—é—´ä½è€¦åˆ
3. é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼šæŒ‰ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†ï¼Œè€Œä¸æ˜¯æŒ‰æŠ€æœ¯å±‚æ¬¡åˆ’åˆ†
4. å¯å¤ç”¨æ€§ï¼šæ¨¡å—å¯ä»¥è¢«å¤šä¸ªä¸šåŠ¡åœºæ™¯å¤ç”¨
5. å¯æ‰©å±•æ€§ï¼šæ¨¡å—å¯ä»¥ç‹¬ç«‹æ¼”è¿›å’Œæ‰©å±•
6. å›¢é˜Ÿåä½œå‹å¥½ï¼šä¸åŒå›¢é˜Ÿå¯ä»¥ä¸“æ³¨ä¸åŒæ¨¡å—
```

### æŠ€æœ¯æ ˆé€‰æ‹©

#### åç«¯æŠ€æœ¯æ ˆ

- **è¯­è¨€**: TypeScript 5.x
- **æ¡†æ¶**: NestJS 11.x
- **æ•°æ®åº“**: PostgreSQL 15.x (å‘½ä»¤ç«¯ + äº‹ä»¶å­˜å‚¨) + MongoDB 7.x (æŸ¥è¯¢ç«¯)
- **ç¼“å­˜**: Redis 7.x
- **ORM**: MikroORM
- **è®¤è¯**: Passport.js + JWT
- **æƒé™æ§åˆ¶**: CASL

#### å¼€å‘å·¥å…·

- **åŒ…ç®¡ç†**: pnpm
- **æ„å»ºå·¥å…·**: pnpm workspace
- **ä»£ç è§„èŒƒ**: ESLint + Prettier
- **æµ‹è¯•æ¡†æ¶**: Jest
- **API æ–‡æ¡£**: Swagger/OpenAPI

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ ¸å¿ƒé¢†åŸŸæ¨¡å—åˆ’åˆ†

#### 2.1 ç”¨æˆ·ç®¡ç†æ¨¡å—ï¼ˆUser Managementï¼‰

**èŒè´£èŒƒå›´**
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç±»å‹çš„ç”¨æˆ·å®ä½“
- ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ç”¨æˆ·æ¡£æ¡ˆç®¡ç†
- ç”¨æˆ·å…³ç³»ç®¡ç†

**åŒ…å«çš„å­é¢†åŸŸ**

##### 2.1.1 å¹³å°ç”¨æˆ·ç®¡ç†ï¼ˆPlatform Usersï¼‰
- ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆSystem Administratorï¼‰
- å¹³å°è¿è¥äººå‘˜ï¼ˆPlatform Operatorï¼‰
- æŠ€æœ¯æ”¯æŒäººå‘˜ï¼ˆTechnical Supportï¼‰
- è´¢åŠ¡ç®¡ç†å‘˜ï¼ˆFinance Administratorï¼‰
- åˆè§„ç®¡ç†å‘˜ï¼ˆCompliance Administratorï¼‰

##### 2.1.2 ç§Ÿæˆ·ç”¨æˆ·ç®¡ç†ï¼ˆTenant Usersï¼‰
- ç§Ÿæˆ·ç®¡ç†å‘˜ï¼ˆTenant Administratorï¼‰
- æ™®é€šç”¨æˆ·ï¼ˆRegular Userï¼‰
- éƒ¨é—¨ç”¨æˆ·ï¼ˆDepartment Userï¼‰
- ç»„ç»‡ç”¨æˆ·ï¼ˆOrganization Userï¼‰

##### 2.1.3 ç”¨æˆ·æ¡£æ¡ˆç®¡ç†
- åŸºæœ¬ä¿¡æ¯ç®¡ç†ï¼ˆå§“åã€é‚®ç®±ã€ç”µè¯ç­‰ï¼‰
- æ‰©å±•ä¿¡æ¯ç®¡ç†ï¼ˆå¤´åƒã€ä¸ªäººç®€ä»‹ç­‰ï¼‰
- åå¥½è®¾ç½®ç®¡ç†ï¼ˆè¯­è¨€ã€æ—¶åŒºã€é€šçŸ¥ç­‰ï¼‰
- éšç§è®¾ç½®ç®¡ç†ï¼ˆæ•°æ®å¯è§æ€§ã€åˆ†äº«æƒé™ç­‰ï¼‰

##### 2.1.4 ç”¨æˆ·å…³ç³»ç®¡ç†
- ç”¨æˆ·ä¸ç§Ÿæˆ·çš„å…³ç³»
- ç”¨æˆ·ä¸ç»„ç»‡çš„å…³ç³»
- ç”¨æˆ·ä¸éƒ¨é—¨çš„å…³ç³»
- ç”¨æˆ·ä¸è§’è‰²çš„å…³ç³»

**æŠ€æœ¯ç‰¹ç‚¹**
- æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„
- æ”¯æŒå¤šå±‚çº§æ•°æ®éš”ç¦»
- æ”¯æŒç”¨æˆ·çŠ¶æ€ç®¡ç†
- æ”¯æŒç”¨æˆ·å…³ç³»ç®¡ç†

#### 2.2 å¹³å°ç®¡ç†æ¨¡å—ï¼ˆPlatform Managementï¼‰

**èŒè´£èŒƒå›´**
- å¹³å°çº§é…ç½®ç®¡ç†
- å¹³å°çº§ç³»ç»Ÿè®¾ç½®
- å¹³å°çº§åŠŸèƒ½å¼€å…³
- å¹³å°çº§å®‰å…¨ç­–ç•¥
- å¹³å°çº§ç­–ç•¥ç®¡ç†

**åŒ…å«çš„å­é¢†åŸŸ**

##### 2.2.1 å¹³å°é…ç½®ç®¡ç†
- ç³»ç»Ÿé…ç½®ï¼ˆSystem Configurationï¼‰
- åŠŸèƒ½å¼€å…³ï¼ˆFeature Flagsï¼‰
- å…¨å±€å‚æ•°ï¼ˆGlobal Parametersï¼‰
- ç¯å¢ƒé…ç½®ï¼ˆEnvironment Configurationï¼‰

##### 2.2.2 å¹³å°ç­–ç•¥ç®¡ç†
- å®‰å…¨ç­–ç•¥ï¼ˆSecurity Policyï¼‰
- åˆè§„ç­–ç•¥ï¼ˆCompliance Policyï¼‰
- è¿è¥ç­–ç•¥ï¼ˆOperation Policyï¼‰
- æŠ€æœ¯ç­–ç•¥ï¼ˆTechnical Policyï¼‰

##### 2.2.3 å¹³å°ç›‘æ§ç®¡ç†
- ç³»ç»Ÿç›‘æ§ï¼ˆSystem Monitoringï¼‰
- æ€§èƒ½ç›‘æ§ï¼ˆPerformance Monitoringï¼‰
- å®‰å…¨ç›‘æ§ï¼ˆSecurity Monitoringï¼‰
- ä¸šåŠ¡ç›‘æ§ï¼ˆBusiness Monitoringï¼‰

**æŠ€æœ¯ç‰¹ç‚¹**
- é…ç½®çƒ­æ›´æ–°
- ç­–ç•¥ç‰ˆæœ¬ç®¡ç†
- é…ç½®å®¡è®¡è¿½è¸ª
- å¤šç¯å¢ƒæ”¯æŒ

#### 2.3 ç§Ÿæˆ·ç®¡ç†æ¨¡å—ï¼ˆTenant Managementï¼‰

**èŒè´£èŒƒå›´**
- ç§Ÿæˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ç§Ÿæˆ·é…ç½®ç®¡ç†
- ç§Ÿæˆ·éš”ç¦»ç­–ç•¥
- ç§Ÿæˆ·è®¡è´¹ç®¡ç†
- ç§Ÿæˆ·ç­–ç•¥ç®¡ç†

**åŒ…å«çš„å­é¢†åŸŸ**

##### 2.3.1 ç§Ÿæˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ç§Ÿæˆ·åˆ›å»ºï¼ˆTenant Creationï¼‰
- ç§Ÿæˆ·æ¿€æ´»ï¼ˆTenant Activationï¼‰
- ç§Ÿæˆ·æš‚åœï¼ˆTenant Suspensionï¼‰
- ç§Ÿæˆ·ç»ˆæ­¢ï¼ˆTenant Terminationï¼‰

##### 2.3.2 ç§Ÿæˆ·é…ç½®ç®¡ç†
- ç§Ÿæˆ·é…ç½®ï¼ˆTenant Configurationï¼‰
- ç§Ÿæˆ·è®¾ç½®ï¼ˆTenant Settingsï¼‰
- ç§Ÿæˆ·ç­–ç•¥ï¼ˆTenant Policyï¼‰
- ç§Ÿæˆ·é™åˆ¶ï¼ˆTenant Limitsï¼‰

##### 2.3.3 ç§Ÿæˆ·è®¡è´¹ç®¡ç†
- è®¡è´¹è®¡åˆ’ï¼ˆBilling Plansï¼‰
- ä½¿ç”¨é‡ç»Ÿè®¡ï¼ˆUsage Statisticsï¼‰
- è´¹ç”¨è®¡ç®—ï¼ˆCost Calculationï¼‰
- æ”¯ä»˜ç®¡ç†ï¼ˆPayment Managementï¼‰

**æŠ€æœ¯ç‰¹ç‚¹**
- å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
- ç§Ÿæˆ·çº§é…ç½®ç®¡ç†
- è®¡è´¹é›†æˆæ”¯æŒ
- ç§Ÿæˆ·çº§ç›‘æ§

#### 2.4 ç»„ç»‡ç®¡ç†æ¨¡å—ï¼ˆOrganization Managementï¼‰

**èŒè´£èŒƒå›´**
- ç»„ç»‡æ¶æ„ç®¡ç†
- ç»„ç»‡å…³ç³»ç®¡ç†
- ç»„ç»‡é…ç½®ç®¡ç†
- ç»„ç»‡ç­–ç•¥ç®¡ç†

**åŒ…å«çš„å­é¢†åŸŸ**

##### 2.4.1 ç»„ç»‡æ¶æ„ç®¡ç†
- ç»„ç»‡åˆ›å»ºï¼ˆOrganization Creationï¼‰
- ç»„ç»‡å±‚çº§ï¼ˆOrganization Hierarchyï¼‰
- ç»„ç»‡å…³ç³»ï¼ˆOrganization Relationshipsï¼‰
- ç»„ç»‡çŠ¶æ€ï¼ˆOrganization Statusï¼‰

##### 2.4.2 ç»„ç»‡é…ç½®ç®¡ç†
- ç»„ç»‡é…ç½®ï¼ˆOrganization Configurationï¼‰
- ç»„ç»‡è®¾ç½®ï¼ˆOrganization Settingsï¼‰
- ç»„ç»‡ç­–ç•¥ï¼ˆOrganization Policyï¼‰
- ç»„ç»‡é™åˆ¶ï¼ˆOrganization Limitsï¼‰

##### 2.4.3 ç»„ç»‡å…³ç³»ç®¡ç†
- ç»„ç»‡ä¸ç§Ÿæˆ·çš„å…³ç³»
- ç»„ç»‡ä¸éƒ¨é—¨çš„å…³ç³»
- ç»„ç»‡ä¸ç”¨æˆ·çš„å…³ç³»
- ç»„ç»‡é—´çš„å…³ç³»

**æŠ€æœ¯ç‰¹ç‚¹**
- æ”¯æŒå¤æ‚ç»„ç»‡æ¶æ„
- ç»„ç»‡çº§æ•°æ®éš”ç¦»
- ç»„ç»‡çº§æƒé™æ§åˆ¶
- ç»„ç»‡çº§é…ç½®ç®¡ç†

#### 2.5 éƒ¨é—¨ç®¡ç†æ¨¡å—ï¼ˆDepartment Managementï¼‰

**èŒè´£èŒƒå›´**
- éƒ¨é—¨æ¶æ„ç®¡ç†
- éƒ¨é—¨å…³ç³»ç®¡ç†
- éƒ¨é—¨é…ç½®ç®¡ç†
- éƒ¨é—¨ç­–ç•¥ç®¡ç†

**åŒ…å«çš„å­é¢†åŸŸ**

##### 2.5.1 éƒ¨é—¨æ¶æ„ç®¡ç†
- éƒ¨é—¨åˆ›å»ºï¼ˆDepartment Creationï¼‰
- éƒ¨é—¨å±‚çº§ï¼ˆDepartment Hierarchyï¼‰
- éƒ¨é—¨å…³ç³»ï¼ˆDepartment Relationshipsï¼‰
- éƒ¨é—¨çŠ¶æ€ï¼ˆDepartment Statusï¼‰

##### 2.5.2 éƒ¨é—¨é…ç½®ç®¡ç†
- éƒ¨é—¨é…ç½®ï¼ˆDepartment Configurationï¼‰
- éƒ¨é—¨è®¾ç½®ï¼ˆDepartment Settingsï¼‰
- éƒ¨é—¨ç­–ç•¥ï¼ˆDepartment Policyï¼‰
- éƒ¨é—¨é™åˆ¶ï¼ˆDepartment Limitsï¼‰

##### 2.5.3 éƒ¨é—¨å…³ç³»ç®¡ç†
- éƒ¨é—¨ä¸ç»„ç»‡çš„å…³ç³»
- éƒ¨é—¨ä¸ç”¨æˆ·çš„å…³ç³»
- éƒ¨é—¨é—´çš„å…³ç³»
- éƒ¨é—¨ä¸ç§Ÿæˆ·çš„å…³ç³»

**æŠ€æœ¯ç‰¹ç‚¹**
- æ”¯æŒå¤æ‚éƒ¨é—¨æ¶æ„
- éƒ¨é—¨çº§æ•°æ®éš”ç¦»
- éƒ¨é—¨çº§æƒé™æ§åˆ¶
- éƒ¨é—¨çº§é…ç½®ç®¡ç†

#### 2.6 IAMæ¨¡å—ï¼ˆIdentity & Access Managementï¼‰

**èŒè´£èŒƒå›´**
- èº«ä»½è®¤è¯ï¼ˆAuthenticationï¼‰
- æˆæƒç®¡ç†ï¼ˆAuthorizationï¼‰
- è§’è‰²ç®¡ç†ï¼ˆRole Managementï¼‰
- æƒé™ç®¡ç†ï¼ˆPermission Managementï¼‰
- ä¼šè¯ç®¡ç†ï¼ˆSession Managementï¼‰
- å®¡è®¡æ—¥å¿—ï¼ˆAudit Loggingï¼‰

**åŒ…å«çš„å­é¢†åŸŸ**

##### 2.6.1 èº«ä»½è®¤è¯ï¼ˆAuthenticationï¼‰
- ç”¨æˆ·åå¯†ç è®¤è¯
- å¤šå› å­è®¤è¯ï¼ˆMFAï¼‰
- å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
- OAuth2.0/OIDC
- ç”Ÿç‰©è¯†åˆ«è®¤è¯

##### 2.6.2 æˆæƒç®¡ç†ï¼ˆAuthorizationï¼‰
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆABACï¼‰
- åŸºäºç­–ç•¥çš„è®¿é—®æ§åˆ¶ï¼ˆPBACï¼‰
- åŠ¨æ€æƒé™æ§åˆ¶

##### 2.6.3 è§’è‰²ç®¡ç†ï¼ˆRole Managementï¼‰
- è§’è‰²å®šä¹‰ï¼ˆRole Definitionï¼‰
- è§’è‰²åˆ†é…ï¼ˆRole Assignmentï¼‰
- è§’è‰²ç»§æ‰¿ï¼ˆRole Inheritanceï¼‰
- è§’è‰²ç»„åˆï¼ˆRole Compositionï¼‰

##### 2.6.4 æƒé™ç®¡ç†ï¼ˆPermission Managementï¼‰
- æƒé™å®šä¹‰ï¼ˆPermission Definitionï¼‰
- æƒé™åˆ†é…ï¼ˆPermission Assignmentï¼‰
- æƒé™éªŒè¯ï¼ˆPermission Validationï¼‰
- æƒé™å®¡è®¡ï¼ˆPermission Auditï¼‰

##### 2.6.5 ä¼šè¯ç®¡ç†ï¼ˆSession Managementï¼‰
- ä¼šè¯åˆ›å»ºï¼ˆSession Creationï¼‰
- ä¼šè¯ç»´æŠ¤ï¼ˆSession Maintenanceï¼‰
- ä¼šè¯éªŒè¯ï¼ˆSession Validationï¼‰
- ä¼šè¯ç»ˆæ­¢ï¼ˆSession Terminationï¼‰

##### 2.6.6 å®¡è®¡æ—¥å¿—ï¼ˆAudit Loggingï¼‰
- è®¤è¯æ—¥å¿—ï¼ˆAuthentication Logsï¼‰
- æˆæƒæ—¥å¿—ï¼ˆAuthorization Logsï¼‰
- æ“ä½œæ—¥å¿—ï¼ˆOperation Logsï¼‰
- å®‰å…¨æ—¥å¿—ï¼ˆSecurity Logsï¼‰

**æŠ€æœ¯ç‰¹ç‚¹**
- æ”¯æŒå¤šç§è®¤è¯æ–¹å¼
- çµæ´»çš„æƒé™æ§åˆ¶
- å®Œæ•´çš„å®¡è®¡è¿½è¸ª
- é«˜æ€§èƒ½çš„æƒé™éªŒè¯

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   REST API  â”‚  â”‚  GraphQL    â”‚  â”‚ WebSocket   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Use Cases  â”‚  â”‚ Commands    â”‚  â”‚   Queries   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Handlers   â”‚  â”‚ Validators  â”‚  â”‚ Projectionsâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Aggregates  â”‚  â”‚  Entities   â”‚  â”‚ Value Objs  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Domain Evt  â”‚  â”‚ Domain Svc  â”‚  â”‚ Repos Intf  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Infrastructure Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚  MongoDB    â”‚  â”‚    Redis    â”‚        â”‚
â”‚  â”‚ (Command DB)â”‚  â”‚ (Query DB)  â”‚  â”‚   (Cache)   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚Event Store  â”‚  â”‚Read Models  â”‚  â”‚ External Svcâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„è®¾è®¡åŸåˆ™

éµå¾ªé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰æ€æƒ³ï¼Œä»£ç ç›®å½•æ¶æ„åº”å½“é¦–å…ˆä½“ç°é¢†åŸŸçš„è¾¹ç•Œã€‚SAASå¹³å°å°†å¹³å°ã€ç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨ã€ç”¨æˆ·ã€è®¤è¯æˆæƒç­‰é¢†åŸŸä½œä¸ºæ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒæ—¶å°†ä¾§é‡äºä¸šåŠ¡é¢†åŸŸçš„å¹³å°ã€ç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨ã€ç”¨æˆ·ä¸è®¤è¯æˆæƒåˆ†ç¦»ï¼Œç¡®ä¿èŒè´£æ¸…æ™°ã€‚

#### è®¾è®¡åŸåˆ™è¯¦è§£

**æ ¸å¿ƒåŸåˆ™**ï¼š
- **æ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆ**ï¼šSAASå¹³å°å°†å¹³å°ã€ç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨ã€ç”¨æˆ·ã€è®¤è¯æˆæƒç­‰é¢†åŸŸä½œä¸ºæ ¸å¿ƒåŠŸèƒ½
- **ä¸šåŠ¡ä¸è®¤è¯åˆ†ç¦»**ï¼šå°†ä¾§é‡äºä¸šåŠ¡é¢†åŸŸçš„å¹³å°ã€ç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨ã€ç”¨æˆ·ä¸è®¤è¯æˆæƒåˆ†ç¦»
- **å…±äº«æ¨¡å—ç»Ÿä¸€**ï¼šç»Ÿä¸€å¼€å‘ç»´æŠ¤ä¸€ä¸ªå…±äº«æ¨¡å—ï¼Œå„é¢†åŸŸæ¨¡å—å†…ä¸è®¾ç½®å…±äº«é¢†åŸŸå±‚
- **åŸºç¡€è®¾æ–½ç‹¬ç«‹**ï¼šé…ç½®ã€æ—¥å¿—ã€ç¼“å­˜ã€æ•°æ®åº“ç­‰é€šç”¨åŸºç¡€è®¾æ–½ç‹¬ç«‹å¼€å‘ï¼Œä¾›å„é¢†åŸŸæ¨¡å—ç»Ÿä¸€è°ƒç”¨
- **åˆ†å±‚æ¶æ„å…¶æ¬¡**ï¼šåœ¨æ¯ä¸ªæ¨¡å—å†…éƒ¨å†æŒ‰åˆ†å±‚æ¶æ„ç»„ç»‡
- **åŠŸèƒ½ç»„ä»¶æœ€å**ï¼šåœ¨æ¯å±‚å†…éƒ¨æŒ‰åŠŸèƒ½ç»„ä»¶ç»„ç»‡

**å‘½åè§„èŒƒ**ï¼š
- **æ ¸å¿ƒä¸šåŠ¡æ¨¡å—**ï¼šä»¥ä¸šåŠ¡é¢†åŸŸåç§°å‘½åï¼ˆå¦‚ï¼šplatformã€tenantã€userã€organizationã€departmentï¼‰
- **è®¤è¯æˆæƒæ¨¡å—**ï¼šä»¥æœåŠ¡ç±»å‹å‘½åï¼ˆå¦‚ï¼šiamï¼‰
- **å…±äº«æ¨¡å—**ï¼šä»¥å…±äº«åŠŸèƒ½å‘½åï¼ˆå¦‚ï¼šsharedï¼‰ï¼Œç»Ÿä¸€ç»´æŠ¤ï¼Œå„é¢†åŸŸæ¨¡å—ä¸é‡å¤åˆ›å»º
- **åŸºç¡€è®¾æ–½æ¨¡å—**ï¼šä»¥åŠŸèƒ½ç±»å‹å‘½åï¼ˆå¦‚ï¼šconfigã€loggingã€cacheã€databaseã€notificationï¼‰ï¼Œç‹¬ç«‹å¼€å‘ï¼Œç»Ÿä¸€è°ƒç”¨
- **åˆ†å±‚ç›®å½•**ï¼šä»¥æ¶æ„å±‚åç§°å‘½åï¼ˆå¦‚ï¼šdomainã€applicationã€infrastructureã€presentationï¼‰
- **åŠŸèƒ½ç»„ä»¶**ï¼šä»¥åŠŸèƒ½ç»„ä»¶åç§°å‘½åï¼ˆå¦‚ï¼šentitiesã€use-casesã€controllersã€repositoriesï¼‰

**ä¼˜åŠ¿**ï¼š
1. **æ ¸å¿ƒåŠŸèƒ½å†…èš**ï¼šå¹³å°ã€ç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨ã€ç”¨æˆ·ã€è®¤è¯æˆæƒç­‰æ ¸å¿ƒåŠŸèƒ½å„è‡ªå†…èš
2. **èŒè´£è¾¹ç•Œæ¸…æ™°**ï¼šä¸šåŠ¡ç®¡ç†æ¨¡å—è´Ÿè´£ä¸šåŠ¡é€»è¾‘ï¼ŒIAM æ¨¡å—è´Ÿè´£è®¤è¯æˆæƒ
3. **å…±äº«æ¨¡å—ç»Ÿä¸€**ï¼šé¿å…é‡å¤å¼€å‘ï¼Œç»Ÿä¸€ç»´æŠ¤å…±äº«åŠŸèƒ½ï¼Œæé«˜ä»£ç å¤ç”¨æ€§
4. **åŸºç¡€è®¾æ–½ç‹¬ç«‹**ï¼šé€šç”¨åŸºç¡€è®¾æ–½ç‹¬ç«‹å¼€å‘ï¼Œä¾¿äºç»Ÿä¸€å‡çº§å’Œç»´æŠ¤
5. **å¯ç»´æŠ¤æ€§**ï¼šä¿®æ”¹æŸä¸ªé¢†åŸŸæ—¶å½±å“èŒƒå›´å¯æ§
6. **å¯æ‰©å±•æ€§**ï¼šæ–°å¢é¢†åŸŸæ—¶ç»“æ„æ¸…æ™°
7. **å›¢é˜Ÿåä½œ**ï¼šä¸åŒå›¢é˜Ÿå¯ä»¥ä¸“æ³¨ä¸åŒé¢†åŸŸ

#### ç›®å½•ç»“æ„ç¤ºä¾‹

```
libs/core/                    # æ ¸å¿ƒä¸šåŠ¡æ¨¡å—
â”œâ”€â”€ platform/                 # å¹³å°ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ domain/          # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ application/     # åº”ç”¨å±‚
â”‚   â”‚   â”œâ”€â”€ infrastructure/  # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â””â”€â”€ presentation/    # è¡¨ç°å±‚
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”œâ”€â”€ tenant/                   # ç§Ÿæˆ·ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ domain/          # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ application/     # åº”ç”¨å±‚
â”‚   â”‚   â”œâ”€â”€ infrastructure/  # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â””â”€â”€ presentation/    # è¡¨ç°å±‚
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”œâ”€â”€ user/                     # ç”¨æˆ·ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼Œç»Ÿä¸€ç®¡ç†å¹³å°ç”¨æˆ·+ç§Ÿæˆ·ç”¨æˆ·ï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ domain/          # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ application/     # åº”ç”¨å±‚
â”‚   â”‚   â”œâ”€â”€ infrastructure/  # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â””â”€â”€ presentation/    # è¡¨ç°å±‚
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”œâ”€â”€ organization/             # ç»„ç»‡ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ domain/          # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ application/     # åº”ç”¨å±‚
â”‚   â”‚   â”œâ”€â”€ infrastructure/  # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â””â”€â”€ presentation/    # è¡¨ç°å±‚
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”œâ”€â”€ department/               # éƒ¨é—¨ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ domain/          # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ application/     # åº”ç”¨å±‚
â”‚   â”‚   â”œâ”€â”€ infrastructure/  # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â””â”€â”€ presentation/    # è¡¨ç°å±‚
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â””â”€â”€ iam/                      # èº«ä»½è®¤è¯ä¸æˆæƒç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ä¸šåŠ¡é¢†åŸŸåˆ†ç¦»ï¼‰
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ auth/            # è®¤è¯å­é¢†åŸŸ
    â”‚   â”‚   â”œâ”€â”€ domain/      # é¢†åŸŸå±‚
    â”‚   â”‚   â”œâ”€â”€ application/ # åº”ç”¨å±‚
    â”‚   â”‚   â”œâ”€â”€ infrastructure/# åŸºç¡€è®¾æ–½å±‚
    â”‚   â”‚   â””â”€â”€ presentation/# è¡¨ç°å±‚
    â”‚   â”œâ”€â”€ role/            # è§’è‰²å­é¢†åŸŸ
    â”‚   â”‚   â”œâ”€â”€ domain/      # é¢†åŸŸå±‚
    â”‚   â”‚   â”œâ”€â”€ application/ # åº”ç”¨å±‚
    â”‚   â”‚   â”œâ”€â”€ infrastructure/# åŸºç¡€è®¾æ–½å±‚
    â”‚   â”‚   â””â”€â”€ presentation/# è¡¨ç°å±‚
    â”‚   â”œâ”€â”€ permission/      # æƒé™å­é¢†åŸŸ
    â”‚   â”‚   â”œâ”€â”€ domain/      # é¢†åŸŸå±‚
    â”‚   â”‚   â”œâ”€â”€ application/ # åº”ç”¨å±‚
    â”‚   â”‚   â”œâ”€â”€ infrastructure/# åŸºç¡€è®¾æ–½å±‚
    â”‚   â”‚   â””â”€â”€ presentation/# è¡¨ç°å±‚
    â”‚   â”œâ”€â”€ session/         # ä¼šè¯å­é¢†åŸŸ
    â”‚   â”‚   â”œâ”€â”€ domain/      # é¢†åŸŸå±‚
    â”‚   â”‚   â”œâ”€â”€ application/ # åº”ç”¨å±‚
    â”‚   â”‚   â”œâ”€â”€ infrastructure/# åŸºç¡€è®¾æ–½å±‚
    â”‚   â”‚   â””â”€â”€ presentation/# è¡¨ç°å±‚
    â”‚   â””â”€â”€ audit/           # å®¡è®¡å­é¢†åŸŸ
    â”‚       â”œâ”€â”€ domain/      # é¢†åŸŸå±‚
    â”‚       â”œâ”€â”€ application/ # åº”ç”¨å±‚
    â”‚       â”œâ”€â”€ infrastructure/# åŸºç¡€è®¾æ–½å±‚
    â”‚       â””â”€â”€ presentation/# è¡¨ç°å±‚
    â”œâ”€â”€ package.json
    â””â”€â”€ tsconfig.json

libs/shared/                  # å…±äº«åŸºç¡€è®¾æ–½æ¨¡å—
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ domain/              # å…±äº«é¢†åŸŸç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ entities/        # åŸºç¡€å®ä½“ç±»
â”‚   â”‚   â”œâ”€â”€ value-objects/   # é€šç”¨å€¼å¯¹è±¡
â”‚   â”‚   â””â”€â”€ enums/           # é€šç”¨æšä¸¾
â”‚   â”œâ”€â”€ infrastructure/      # å…±äº«åŸºç¡€è®¾æ–½
â”‚   â””â”€â”€ presentation/        # å…±äº«è¡¨ç°å±‚ç»„ä»¶
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json

libs/infrastructure/          # é€šç”¨åŸºç¡€è®¾æ–½æ¨¡å—
â”œâ”€â”€ config/                   # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ database/        # æ•°æ®åº“é…ç½®
â”‚   â”‚   â”œâ”€â”€ redis/           # Redisé…ç½®
â”‚   â”‚   â”œâ”€â”€ jwt/             # JWTé…ç½®
â”‚   â”‚   â””â”€â”€ app/             # åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”œâ”€â”€ logging/                  # æ—¥å¿—ç®¡ç†
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ formatters/      # æ—¥å¿—æ ¼å¼åŒ–
â”‚   â”‚   â”œâ”€â”€ transports/      # æ—¥å¿—ä¼ è¾“
â”‚   â”‚   â””â”€â”€ levels/          # æ—¥å¿—çº§åˆ«
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â”œâ”€â”€ cache/                    # ç¼“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ redis/           # Redisç¼“å­˜
â”‚   â”‚   â”œâ”€â”€ memory/          # å†…å­˜ç¼“å­˜
â”‚   â”‚   â””â”€â”€ strategies/      # ç¼“å­˜ç­–ç•¥
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ tsconfig.json
â””â”€â”€ database/                 # æ•°æ®åº“ç®¡ç†
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ postgresql/      # PostgreSQLè¿æ¥
    â”‚   â”œâ”€â”€ mongodb/         # MongoDBè¿æ¥
    â”‚   â”œâ”€â”€ migrations/      # æ•°æ®åº“è¿ç§»
    â”‚   â””â”€â”€ seeds/           # æ•°æ®ç§å­
    â”œâ”€â”€ package.json
    â””â”€â”€ tsconfig.json

libs/notification/            # é€šçŸ¥é¢†åŸŸæ¨¡å—
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ domain/              # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ entities/        # é€šçŸ¥å®ä½“
â”‚   â”‚   â”œâ”€â”€ value-objects/   # é€šçŸ¥å€¼å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ aggregates/      # é€šçŸ¥èšåˆæ ¹
â”‚   â”‚   â”œâ”€â”€ domain-events/   # é€šçŸ¥é¢†åŸŸäº‹ä»¶
â”‚   â”‚   â”œâ”€â”€ domain-services/ # é€šçŸ¥é¢†åŸŸæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ repositories/    # é€šçŸ¥ä»“å‚¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ exceptions/      # é€šçŸ¥å¼‚å¸¸
â”‚   â”‚   â”œâ”€â”€ enums/           # é€šçŸ¥æšä¸¾
â”‚   â”‚   â””â”€â”€ types/           # é€šçŸ¥ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ application/         # åº”ç”¨å±‚
â”‚   â”‚   â”œâ”€â”€ use-cases/       # é€šçŸ¥ç”¨ä¾‹
â”‚   â”‚   â”œâ”€â”€ commands/        # é€šçŸ¥å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ queries/         # é€šçŸ¥æŸ¥è¯¢
â”‚   â”‚   â”œâ”€â”€ projections/     # é€šçŸ¥æŠ•å½±
â”‚   â”‚   â”œâ”€â”€ services/        # é€šçŸ¥åº”ç”¨æœåŠ¡
â”‚   â”‚   â””â”€â”€ interfaces/      # é€šçŸ¥åº”ç”¨å±‚æ¥å£
â”‚   â”œâ”€â”€ infrastructure/      # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”œâ”€â”€ repositories/    # é€šçŸ¥ä»“å‚¨å®ç°
â”‚   â”‚   â”œâ”€â”€ mappers/         # é€šçŸ¥æ˜ å°„å™¨
â”‚   â”‚   â”œâ”€â”€ entities/        # é€šçŸ¥ORMå®ä½“
â”‚   â”‚   â”œâ”€â”€ services/        # é€šçŸ¥åŸºç¡€è®¾æ–½æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ external/        # å¤–éƒ¨é€šçŸ¥æœåŠ¡é›†æˆ
â”‚   â”‚   â”œâ”€â”€ config/          # é€šçŸ¥é…ç½®
â”‚   â”‚   â””â”€â”€ migrations/      # é€šçŸ¥æ•°æ®åº“è¿ç§»
â”‚   â””â”€â”€ presentation/        # è¡¨ç°å±‚
â”‚       â”œâ”€â”€ controllers/     # é€šçŸ¥æ§åˆ¶å™¨
â”‚       â”œâ”€â”€ dtos/            # é€šçŸ¥æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚       â”œâ”€â”€ validators/      # é€šçŸ¥éªŒè¯å™¨
â”‚       â”œâ”€â”€ guards/          # é€šçŸ¥æƒé™å®ˆå«
â”‚       â””â”€â”€ interceptors/    # é€šçŸ¥æ‹¦æˆªå™¨
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

#### åº”ç”¨ç¤ºä¾‹

**æ­£ç¡®ç¤ºä¾‹**ï¼š
- âœ… `libs/core/iam/src/auth/infrastructure/jwt.service.ts` - IAMè®¤è¯å­é¢†åŸŸçš„åŸºç¡€è®¾æ–½æœåŠ¡
- âœ… `libs/core/platform/src/domain/entities/platform-config.entity.ts` - å¹³å°ç®¡ç†æ¨¡å—çš„é¢†åŸŸå®ä½“
- âœ… `libs/core/tenant/src/domain/entities/tenant.entity.ts` - ç§Ÿæˆ·ç®¡ç†æ¨¡å—çš„é¢†åŸŸå®ä½“
- âœ… `libs/core/user/src/domain/entities/user.entity.ts` - ç”¨æˆ·ç®¡ç†æ¨¡å—çš„é¢†åŸŸå®ä½“
- âœ… `libs/core/iam/src/role/application/use-cases/create-role.usecase.ts` - IAMè§’è‰²å­é¢†åŸŸçš„åº”ç”¨ç”¨ä¾‹
- âœ… `libs/infrastructure/config/src/database/database.config.ts` - é€šç”¨æ•°æ®åº“é…ç½®æœåŠ¡
- âœ… `libs/infrastructure/logging/src/formatters/json.formatter.ts` - é€šç”¨æ—¥å¿—æ ¼å¼åŒ–æœåŠ¡
- âœ… `libs/infrastructure/cache/src/redis/redis.cache.service.ts` - é€šç”¨Redisç¼“å­˜æœåŠ¡
- âœ… `libs/notification/src/domain/entities/notification.entity.ts` - é€šçŸ¥é¢†åŸŸå®ä½“
- âœ… `libs/notification/src/application/use-cases/send-notification.usecase.ts` - é€šçŸ¥å‘é€ç”¨ä¾‹
- âœ… `libs/shared/src/domain/value-objects/uuid.vo.ts` - å…±äº«UUIDå€¼å¯¹è±¡

**é”™è¯¯ç¤ºä¾‹**ï¼š
- âŒ `libs/core/iam/src/infrastructure/auth/jwt.service.ts` - æŒ‰åˆ†å±‚æ¶æ„ç»„ç»‡ï¼Œä¸ç¬¦åˆDDDåŸåˆ™
- âŒ `libs/core/iam/src/domain/user/user.entity.ts` - ç”¨æˆ·å®ä½“ä¸åº”æ”¾åœ¨IAMæ¨¡å—ä¸­
- âŒ `libs/core/iam/src/platform/domain/entities/platform-user.entity.ts` - å¹³å°ç”¨æˆ·å®ä½“ä¸åº”æ”¾åœ¨IAMæ¨¡å—ä¸­
- âŒ `libs/core/platform/src/shared/domain/value-objects/uuid.vo.ts` - å„é¢†åŸŸæ¨¡å—ä¸åº”åˆ›å»ºå…±äº«é¢†åŸŸå±‚
- âŒ `libs/core/user/src/infrastructure/database/database.service.ts` - å„é¢†åŸŸæ¨¡å—ä¸åº”é‡å¤å¼€å‘åŸºç¡€è®¾æ–½æœåŠ¡
- âŒ `libs/core/tenant/src/shared/utils/logging.util.ts` - å„é¢†åŸŸæ¨¡å—ä¸åº”é‡å¤å¼€å‘é€šç”¨å·¥å…·
- âŒ `libs/core/user/src/domain/entities/notification.entity.ts` - é€šçŸ¥å®ä½“ä¸åº”æ”¾åœ¨ç”¨æˆ·æ¨¡å—ä¸­
- âŒ `libs/core/platform/src/application/use-cases/send-notification.usecase.ts` - é€šçŸ¥ç”¨ä¾‹ä¸åº”æ”¾åœ¨å¹³å°æ¨¡å—ä¸­

### æ¨¡å—åˆ’åˆ†

```
libs/
â”œâ”€â”€ shared/                   # å…±äº«æ¨¡å—
â”‚   â”œâ”€â”€ domain/               # å…±äº«é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ infrastructure/       # å…±äº«åŸºç¡€è®¾æ–½
â”‚   â””â”€â”€ utils/                # å·¥å…·ç±»
â”œâ”€â”€ notification/             # é€šçŸ¥é¢†åŸŸæ¨¡å—ï¼ˆç‹¬ç«‹å¼€å‘ï¼Œä¾›å„é¢†åŸŸæ¨¡å—ç»Ÿä¸€ä½¿ç”¨ï¼‰
â”œâ”€â”€ core/                     # æ ¸å¿ƒä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ platform/             # å¹³å°ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼‰
â”‚   â”œâ”€â”€ tenant/               # ç§Ÿæˆ·ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼‰
â”‚   â”œâ”€â”€ user/                 # ç”¨æˆ·ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼‰
â”‚   â”œâ”€â”€ organization/         # ç»„ç»‡ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼‰
â”‚   â”œâ”€â”€ department/           # éƒ¨é—¨ç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸï¼‰
â”‚   â””â”€â”€ iam/                  # èº«ä»½è®¤è¯ä¸æˆæƒç®¡ç†æ¨¡å—ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ä¸šåŠ¡é¢†åŸŸåˆ†ç¦»ï¼‰
â”‚       â”œâ”€â”€ auth/             # è®¤è¯å­é¢†åŸŸ
â”‚       â”œâ”€â”€ role/             # è§’è‰²å­é¢†åŸŸ
â”‚       â”œâ”€â”€ permission/       # æƒé™å­é¢†åŸŸ
â”‚       â”œâ”€â”€ session/          # ä¼šè¯å­é¢†åŸŸ
â”‚       â””â”€â”€ audit/            # å®¡è®¡å­é¢†åŸŸ
```

### æ¨¡å—ä¾èµ–å…³ç³»

#### 3.1 ä¾èµ–å…³ç³»å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           Business Modules           â”‚
                    â”‚           (ä¸šåŠ¡æ¨¡å—å±‚)               â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚   HR Mgmt   â”‚  â”‚ Finance Mgmtâ”‚  â”‚
                    â”‚  â”‚ (äººåŠ›èµ„æº)   â”‚  â”‚ (è´¢åŠ¡ç®¡ç†)   â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Mgmt     â”‚    â”‚  Platform Mgmt  â”‚    â”‚  Tenant Mgmt    â”‚
â”‚   (ç”¨æˆ·ç®¡ç†)     â”‚    â”‚   (å¹³å°ç®¡ç†)     â”‚    â”‚   (ç§Ÿæˆ·ç®¡ç†)     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚   IAM   â”‚   â”‚    â”‚   â”‚   IAM   â”‚   â”‚    â”‚   â”‚   IAM   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Organization   â”‚    â”‚     Shared      â”‚    â”‚      IAM       â”‚
â”‚     Mgmt        â”‚    â”‚   (å…±äº«æ¨¡å—)     â”‚    â”‚ (èº«ä»½è®¤è¯æˆæƒ)   â”‚
â”‚   (ç»„ç»‡ç®¡ç†)     â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚   â”‚   IAM   â”‚   â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚                 â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                       â”‚
â”‚  Department     â”‚              â”‚                       â”‚
â”‚     Mgmt        â”‚              â”‚                       â”‚
â”‚   (éƒ¨é—¨ç®¡ç†)     â”‚              â”‚                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚              â”‚                       â”‚
â”‚   â”‚   IAM   â”‚   â”‚              â”‚                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚              â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         Infrastructure Layer        â”‚
                    â”‚           (åŸºç¡€è®¾æ–½å±‚)               â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚ PostgreSQL  â”‚  â”‚   Redis     â”‚  â”‚
                    â”‚  â”‚   MongoDB   â”‚  â”‚             â”‚  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2 ä¾èµ–å…³ç³»è¯´æ˜

**åŸºç¡€ä¾èµ–**
- **Sharedæ¨¡å—**ï¼šæ‰€æœ‰æ¨¡å—éƒ½ä¾èµ–çš„å…±äº«åŸºç¡€è®¾æ–½ï¼ˆå€¼å¯¹è±¡ã€åŸºç±»ã€å·¥å…·ç­‰ï¼‰
- **IAMæ¨¡å—**ï¼šæä¾›è®¤è¯æˆæƒæœåŠ¡ï¼Œè¢«æ‰€æœ‰ç®¡ç†æ¨¡å—ä½¿ç”¨

**æ ¸å¿ƒç®¡ç†æ¨¡å—ä¾èµ–**
- **User Management**ï¼šä¾èµ–Sharedæ¨¡å—å’ŒIAMæ¨¡å—ï¼Œä¸“æ³¨äºç”¨æˆ·å®ä½“ç®¡ç†
- **Platform Management**ï¼šä¾èµ–Sharedæ¨¡å—å’ŒIAMæ¨¡å—ï¼Œç®¡ç†å¹³å°çº§é…ç½®
- **Tenant Management**ï¼šä¾èµ–Sharedæ¨¡å—å’ŒIAMæ¨¡å—ï¼Œç®¡ç†ç§Ÿæˆ·å®ä½“å’Œç”Ÿå‘½å‘¨æœŸ
- **Organization Management**ï¼šä¾èµ–Sharedæ¨¡å—ã€IAMæ¨¡å—å’ŒTenant Managementï¼Œç®¡ç†ç»„ç»‡æ¶æ„
- **Department Management**ï¼šä¾èµ–Sharedæ¨¡å—ã€IAMæ¨¡å—å’ŒOrganization Managementï¼Œç®¡ç†éƒ¨é—¨æ¶æ„

**ä¸šåŠ¡æ¨¡å—ä¾èµ–**
- **Business Modules**ï¼šä¸šåŠ¡æ¨¡å—ï¼ˆå¦‚HRã€Financeã€Orderç­‰ï¼‰ä¾èµ–æ‰€æœ‰åŸºç¡€ç®¡ç†æ¨¡å—
- **Infrastructure Layer**ï¼šåŸºç¡€è®¾æ–½å±‚è¢«æ‰€æœ‰ä¸Šå±‚æ¨¡å—ä½¿ç”¨

#### 3.3 ä¾èµ–å…³ç³»è®¾è®¡åŸåˆ™

**å®ä½“å…³ç³»ç®¡ç†åŸåˆ™**
- **å±‚çº§å…³ç³»**ï¼šç§Ÿæˆ· â†’ ç»„ç»‡ â†’ éƒ¨é—¨ï¼Œå½¢æˆæ¸…æ™°çš„å±‚çº§ç»“æ„
- **åŒ…å«å…³ç³»**ï¼šä¸Šçº§å®ä½“åŒ…å«ä¸‹çº§å®ä½“ï¼Œä¸‹çº§å®ä½“å±äºä¸Šçº§å®ä½“
- **å…³ç³»ç»´æŠ¤**ï¼šæ¯ä¸ªç®¡ç†æ¨¡å—è´Ÿè´£ç»´æŠ¤è‡ªå·±å®ä½“ä¸å…¶ä»–å®ä½“çš„å…³ç³»

**è®¤è¯æˆæƒç®¡ç†åŸåˆ™**
- **ç»Ÿä¸€è®¤è¯**ï¼šæ‰€æœ‰ç®¡ç†æ¨¡å—éƒ½ç›´æ¥ä¾èµ–IAMæ¨¡å—è¿›è¡Œè®¤è¯æˆæƒ
- **æƒé™æ§åˆ¶**ï¼šæ¯ä¸ªç®¡ç†æ¨¡å—éƒ½æœ‰è‡ªå·±çš„æƒé™æ§åˆ¶éœ€æ±‚
- **æœåŠ¡å¤ç”¨**ï¼šIAMæ¨¡å—ä½œä¸ºå…¬å…±æœåŠ¡ï¼Œè¢«æ‰€æœ‰æ¨¡å—å¤ç”¨

**æ¨¡å—èŒè´£åˆ†ç¦»åŸåˆ™**
- **ç”¨æˆ·ç®¡ç†**ï¼šä¸“æ³¨äºç”¨æˆ·å®ä½“ã€ç”¨æˆ·æ¡£æ¡ˆã€ç”¨æˆ·è®¤è¯æˆæƒ
- **ç»„ç»‡ç®¡ç†**ï¼šä¸“æ³¨äºç»„ç»‡æ¶æ„ã€ç»„ç»‡å…³ç³»ã€ç”¨æˆ·ä¸ç»„ç»‡çš„å…³ç³»
- **éƒ¨é—¨ç®¡ç†**ï¼šä¸“æ³¨äºéƒ¨é—¨æ¶æ„ã€éƒ¨é—¨å…³ç³»ã€ç”¨æˆ·ä¸éƒ¨é—¨çš„å…³ç³»
- **ç§Ÿæˆ·ç®¡ç†**ï¼šä¸“æ³¨äºç§Ÿæˆ·ç”Ÿå‘½å‘¨æœŸã€ç§Ÿæˆ·é…ç½®ã€ç”¨æˆ·ä¸ç§Ÿæˆ·çš„å…³ç³»
â”‚   â”œâ”€â”€ auth/                 # è®¤è¯æˆæƒå­é¢†åŸŸ
â”‚   â”‚   â”œâ”€â”€ domain/           # é¢†åŸŸå±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/     # å®ä½“ (ä¸šåŠ¡å®ä½“)
â”‚   â”‚   â”‚   â”œâ”€â”€ value-objects/# å€¼å¯¹è±¡ (ä¸å¯å˜å¯¹è±¡)
â”‚   â”‚   â”‚   â”œâ”€â”€ aggregates/   # èšåˆæ ¹ (ä¸šåŠ¡è§„åˆ™ã€ä¸€è‡´æ€§è¾¹ç•Œ)
â”‚   â”‚   â”‚   â”œâ”€â”€ domain-events/# é¢†åŸŸäº‹ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ domain-services/# é¢†åŸŸæœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/ # ä»“å‚¨æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ exceptions/   # é¢†åŸŸå¼‚å¸¸
â”‚   â”‚   â”‚   â”œâ”€â”€ enums/        # æšä¸¾
â”‚   â”‚   â”‚   â””â”€â”€ types/        # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ application/      # åº”ç”¨å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ use-cases/    # ç”¨ä¾‹ (ä¸šåŠ¡é€»è¾‘å…¥å£)
â”‚   â”‚   â”‚   â”œâ”€â”€ commands/     # å‘½ä»¤ (å†™æ“ä½œ)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ handlers/ # å‘½ä»¤å¤„ç†å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ validators/ # å‘½ä»¤éªŒè¯å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ queries/      # æŸ¥è¯¢ (è¯»æ“ä½œ)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ handlers/ # æŸ¥è¯¢å¤„ç†å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ validators/ # æŸ¥è¯¢éªŒè¯å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ projections/  # è¯»æ¨¡å‹æŠ•å½±
â”‚   â”‚   â”‚   â”œâ”€â”€ services/     # åº”ç”¨æœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ interfaces/   # åº”ç”¨å±‚æ¥å£
â”‚   â”‚   â”œâ”€â”€ infrastructure/   # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/ # ä»“å‚¨å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ mappers/      # æ˜ å°„å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/     # ORMå®ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ services/     # åŸºç¡€è®¾æ–½æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ external/     # å¤–éƒ¨æœåŠ¡é›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ config/       # é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ migrations/   # æ•°æ®åº“è¿ç§»
â”‚   â”‚   â””â”€â”€ presentation/     # è¡¨ç°å±‚
â”‚   â”‚       â”œâ”€â”€ controllers/  # æ§åˆ¶å™¨
â”‚   â”‚       â”œâ”€â”€ dtos/         # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚       â”œâ”€â”€ validators/   # è¡¨ç°å±‚éªŒè¯å™¨
â”‚   â”‚       â”œâ”€â”€ guards/       # æƒé™å®ˆå«
â”‚   â”‚       â””â”€â”€ interceptors/ # æ‹¦æˆªå™¨
# æ³¨æ„ï¼šç»„ç»‡ç®¡ç†å’Œéƒ¨é—¨ç®¡ç†å·²ç‹¬ç«‹ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œä¸IAMåŒçº§
â”‚   â”œâ”€â”€ role/                 # è§’è‰²å­é¢†åŸŸ
â”‚   â”œâ”€â”€ permission/           # æƒé™å­é¢†åŸŸ
â”‚   â””â”€â”€ audit/                # å®¡è®¡å­é¢†åŸŸ
apps/
â””â”€â”€ api/                      # APIåº”ç”¨
```

### å­é¢†åŸŸèŒè´£åˆ’åˆ†

**æ³¨æ„**: ä»¥ä¸‹ä¸šåŠ¡é¢†åŸŸå·²ç‹¬ç«‹ä¸ºç‹¬ç«‹æ¨¡å—ï¼Œä¸IAMåŒçº§ï¼Œä½œä¸ºSAASå¹³å°çš„æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼š
- Platform Management (å¹³å°ç®¡ç†) - `libs/core/platform`
- Tenant Management (ç§Ÿæˆ·ç®¡ç†) - `libs/core/tenant`
- User Management (ç”¨æˆ·ç®¡ç†) - `libs/core/user`
- Organization Management (ç»„ç»‡ç®¡ç†) - `libs/core/organization`
- Department Management (éƒ¨é—¨ç®¡ç†) - `libs/core/department`

**IAMæ¨¡å—ä¸“æ³¨äºè®¤è¯æˆæƒåŠŸèƒ½ï¼Œä¸ä¸šåŠ¡é¢†åŸŸåˆ†ç¦»ï¼ŒåŒ…å«ä»¥ä¸‹å­é¢†åŸŸï¼š**

#### 1. **auth å­é¢†åŸŸ**

- **èŒè´£**: èº«ä»½è®¤è¯ã€å¤šå› å­è®¤è¯ã€å•ç‚¹ç™»å½•
- **æ ¸å¿ƒåŠŸèƒ½**: 
  - ç”¨æˆ·åå¯†ç è®¤è¯
  - å¤šå› å­è®¤è¯ï¼ˆTOTPã€çŸ­ä¿¡ã€é‚®ç®±ï¼‰
  - å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
  - OAuth2.0/OIDCé›†æˆ
  - ç”Ÿç‰©è¯†åˆ«è®¤è¯
- **è¾¹ç•Œ**: ä¸“æ³¨äºè®¤è¯æµç¨‹å’Œè®¤è¯æ–¹å¼ï¼Œä¸æ¶‰åŠç”¨æˆ·æ•°æ®ç®¡ç†

#### 2. **role å­é¢†åŸŸ**

- **èŒè´£**: è§’è‰²å®šä¹‰ã€è§’è‰²åˆ†é…ã€è§’è‰²ç»§æ‰¿
- **æ ¸å¿ƒåŠŸèƒ½**: 
  - è§’è‰²å®šä¹‰å’Œé…ç½®
  - è§’è‰²åˆ†é…å’Œæ’¤é”€
  - è§’è‰²ç»§æ‰¿å’Œç»„åˆ
  - ç³»ç»Ÿè§’è‰²å’Œä¸šåŠ¡è§’è‰²ç®¡ç†
  - è§’è‰²æƒé™å…³è”
- **è¾¹ç•Œ**: ä¸“æ³¨äºè§’è‰²å±‚é¢çš„ç®¡ç†ï¼Œä¸æ¶‰åŠå…·ä½“æƒé™å®ç°

#### 3. **permission å­é¢†åŸŸ**

- **èŒè´£**: æƒé™å®šä¹‰ã€æƒé™åˆ†é…ã€æƒé™éªŒè¯
- **æ ¸å¿ƒåŠŸèƒ½**: 
  - æƒé™å®šä¹‰å’Œé…ç½®
  - æƒé™åˆ†é…å’Œæ’¤é”€
  - æƒé™éªŒè¯å’Œæ£€æŸ¥
  - åŠŸèƒ½æƒé™ã€æ•°æ®æƒé™ã€å­—æ®µæƒé™
  - æƒé™ç”³è¯·å’Œå®¡æ‰¹æµç¨‹
- **è¾¹ç•Œ**: ä¸“æ³¨äºæƒé™å±‚é¢çš„ç®¡ç†ï¼Œæä¾›æƒé™éªŒè¯æœåŠ¡

#### 4. **session å­é¢†åŸŸ**

- **èŒè´£**: ä¼šè¯ç®¡ç†ã€ä¼šè¯éªŒè¯ã€ä¼šè¯å®‰å…¨
- **æ ¸å¿ƒåŠŸèƒ½**: 
  - ä¼šè¯åˆ›å»ºå’Œç»´æŠ¤
  - ä¼šè¯éªŒè¯å’Œåˆ·æ–°
  - ä¼šè¯å®‰å…¨ç­–ç•¥
  - å¤šè®¾å¤‡ä¼šè¯ç®¡ç†
  - ä¼šè¯å®¡è®¡å’Œç›‘æ§
  - ä¼šè¯è¶…æ—¶ç®¡ç†
  - å¹¶å‘ä¼šè¯æ§åˆ¶
- **è¾¹ç•Œ**: ä¸“æ³¨äºä¼šè¯å±‚é¢çš„ç®¡ç†ï¼Œç¡®ä¿ä¼šè¯å®‰å…¨

#### 5. **audit å­é¢†åŸŸ**

- **èŒè´£**: å®¡è®¡æ—¥å¿—ã€åˆè§„æ£€æŸ¥ã€å®‰å…¨ç›‘æ§
- **æ ¸å¿ƒåŠŸèƒ½**: 
  - æ“ä½œæ—¥å¿—è®°å½•
  - å®¡è®¡æŠ¥å‘Šç”Ÿæˆ
  - åˆè§„æ£€æŸ¥æ”¯æŒ
  - å®‰å…¨äº‹ä»¶ç›‘æ§
  - æ•°æ®è®¿é—®è¿½è¸ª
- **è¾¹ç•Œ**: ä¸“æ³¨äºå®¡è®¡å±‚é¢çš„ç®¡ç†ï¼Œæä¾›å®Œæ•´çš„å®¡è®¡èƒ½åŠ›

## ğŸ”„ Clean Architecture + CQRS + GraphQL + äº‹ä»¶æº¯æºæ¶æ„è®¾è®¡

### Use Case è®¾è®¡åŸåˆ™

```typescript
// Use Case æ˜¯ä¸šåŠ¡é€»è¾‘çš„ç»Ÿä¸€å…¥å£
@Injectable()
export class CreateUserUseCase {
  constructor(
    private readonly commandBus: CommandBus,
    private readonly userRepository: UserRepository,
    private readonly emailService: EmailService,
    private readonly auditService: AuditService
  ) {}

  async execute(request: CreateUserRequest): Promise<CreateUserResponse> {
    // 1. ä¸šåŠ¡è§„åˆ™éªŒè¯
    await this.validateBusinessRules(request);

    // 2. åˆ›å»ºå‘½ä»¤
    const command = new CreateUserCommand(
      request.username,
      request.email,
      request.password,
      request.tenantId
    );

    // 3. æ‰§è¡Œå‘½ä»¤
    await this.commandBus.execute(command);

    // 4. ä¸šåŠ¡é€»è¾‘å¤„ç†
    await this.sendWelcomeEmail(request.email);
    await this.auditService.logUserCreation(request);

    return { userId: command.userId, success: true };
  }

  private async validateBusinessRules(
    request: CreateUserRequest
  ): Promise<void> {
    // ä¸šåŠ¡è§„åˆ™éªŒè¯é€»è¾‘
  }
}

@Injectable()
export class GetUserUseCase {
  constructor(
    private readonly queryBus: QueryBus,
    private readonly permissionService: PermissionService
  ) {}

  async execute(request: GetUserRequest): Promise<GetUserResponse> {
    // 1. æƒé™éªŒè¯
    await this.permissionService.checkPermission(
      request.currentUserId,
      'user',
      'read',
      request.userId
    );

    // 2. åˆ›å»ºæŸ¥è¯¢
    const query = new GetUserByIdQuery(request.userId);

    // 3. æ‰§è¡ŒæŸ¥è¯¢
    const user = await this.queryBus.execute(query);

    return { user, success: true };
  }
}
```

### CQRS ç›®å½•ç»“æ„æœ€ä½³å®è·µ

#### åº”ç”¨å±‚ç›®å½•ç»„ç»‡åŸåˆ™

```
application/
â”œâ”€â”€ use-cases/          # ç”¨ä¾‹ (ä¸šåŠ¡é€»è¾‘å…¥å£)
â”œâ”€â”€ commands/           # å‘½ä»¤ (å†™æ“ä½œ)
â”‚   â”œâ”€â”€ handlers/      # å‘½ä»¤å¤„ç†å™¨
â”‚   â””â”€â”€ validators/    # å‘½ä»¤éªŒè¯å™¨
â”œâ”€â”€ queries/           # æŸ¥è¯¢ (è¯»æ“ä½œ)
â”‚   â”œâ”€â”€ handlers/      # æŸ¥è¯¢å¤„ç†å™¨
â”‚   â””â”€â”€ validators/    # æŸ¥è¯¢éªŒè¯å™¨
â”œâ”€â”€ projections/       # è¯»æ¨¡å‹æŠ•å½±
â”œâ”€â”€ services/          # åº”ç”¨æœåŠ¡
â””â”€â”€ interfaces/        # åº”ç”¨å±‚æ¥å£
```

**è®¾è®¡åŸåˆ™**ï¼š
- **å‘½ä»¤å’ŒæŸ¥è¯¢åˆ†ç¦»**ï¼šå†™æ“ä½œå’Œè¯»æ“ä½œå®Œå…¨åˆ†ç¦»
- **å¤„ç†å™¨å°±è¿‘åŸåˆ™**ï¼šhandlersæ”¾åœ¨å¯¹åº”çš„commands/queriesç›®å½•ä¸‹
- **éªŒè¯å™¨åˆ†ç¦»**ï¼šæ¯ä¸ªå‘½ä»¤/æŸ¥è¯¢éƒ½æœ‰å¯¹åº”çš„éªŒè¯å™¨
- **èŒè´£æ¸…æ™°**ï¼šæ¯ä¸ªç›®å½•éƒ½æœ‰æ˜ç¡®çš„èŒè´£è¾¹ç•Œ

### CQRS + GraphQL æ¨¡å¼è®¾è®¡

#### å‘½ä»¤ç«¯ï¼ˆCommand Sideï¼‰

```typescript
// å‘½ä»¤å®šä¹‰
export class CreateUserCommand {
  constructor(
    public readonly username: string,
    public readonly email: string,
    public readonly password: string,
    public readonly tenantId?: string
  ) {}
}

export class ChangeUserEmailCommand {
  constructor(
    public readonly userId: string,
    public readonly newEmail: string
  ) {}
}

// å‘½ä»¤å¤„ç†å™¨ - ä½äº commands/handlers/
@CommandHandler(CreateUserCommand)
export class CreateUserHandler {
  constructor(
    private readonly userRepository: UserRepository,
    private readonly eventStore: EventStore
  ) {}

  async execute(command: CreateUserCommand): Promise<void> {
    // åˆ›å»ºç”¨æˆ·èšåˆæ ¹
    const userAggregate = UserAggregate.create(
      command.username,
      command.email,
      command.password
    );

    // ä¿å­˜èšåˆæ ¹
    await this.userRepository.save(userAggregate);

    // ä¿å­˜é¢†åŸŸäº‹ä»¶
    const events = userAggregate.getUncommittedEvents();
    await this.eventStore.saveEvents(
      userAggregate.getId(),
      events,
      userAggregate.getVersion()
    );

    // æ ‡è®°äº‹ä»¶ä¸ºå·²æäº¤
    userAggregate.markEventsAsCommitted();
  }
}

// å‘½ä»¤éªŒè¯å™¨ - ä½äº commands/validators/
@Injectable()
export class CreateUserCommandValidator {
  async validate(command: CreateUserCommand): Promise<void> {
    if (!command.username || command.username.length < 3) {
      throw new ValidationException('Username must be at least 3 characters');
    }
    
    if (!command.email || !isValidEmail(command.email)) {
      throw new ValidationException('Invalid email format');
    }
    
    if (!command.password || command.password.length < 8) {
      throw new ValidationException('Password must be at least 8 characters');
    }
  }
}

// å‘½ä»¤æ€»çº¿
@Injectable()
export class CommandBus {
  constructor(private readonly handlers: Map<string, CommandHandler>) {}

  async execute<T extends Command>(command: T): Promise<void> {
    const handler = this.handlers.get(command.constructor.name);
    if (!handler) {
      throw new CommandHandlerNotFoundException(command.constructor.name);
    }
    await handler.execute(command);
  }
}
```

#### æŸ¥è¯¢ç«¯ï¼ˆQuery Sideï¼‰

```typescript
// æŸ¥è¯¢å®šä¹‰
export class GetUserByIdQuery {
  constructor(public readonly userId: string) {}
}

export class GetUsersByTenantQuery {
  constructor(
    public readonly tenantId: string,
    public readonly page: number,
    public readonly size: number
  ) {}
}

// æŸ¥è¯¢å¤„ç†å™¨ - ä½äº queries/handlers/
@QueryHandler(GetUserByIdQuery)
export class GetUserByIdHandler {
  constructor(private readonly userReadModel: UserReadModel) {}

  async execute(query: GetUserByIdQuery): Promise<UserDto> {
    return this.userReadModel.findById(query.userId);
  }
}

// æŸ¥è¯¢éªŒè¯å™¨ - ä½äº queries/validators/
@Injectable()
export class GetUserByIdQueryValidator {
  async validate(query: GetUserByIdQuery): Promise<void> {
    if (!query.userId || !isValidUuid(query.userId)) {
      throw new ValidationException('Invalid user ID format');
    }
  }
}

// æŸ¥è¯¢æ€»çº¿
@Injectable()
export class QueryBus {
  constructor(private readonly handlers: Map<string, QueryHandler>) {}

  async execute<T extends Query, R>(query: T): Promise<R> {
    const handler = this.handlers.get(query.constructor.name);
    if (!handler) {
      throw new QueryHandlerNotFoundException(query.constructor.name);
    }
    return handler.execute(query);
  }
}
```

### äº‹ä»¶æº¯æºè®¾è®¡

#### äº‹ä»¶å­˜å‚¨

```typescript
// äº‹ä»¶å­˜å‚¨æ¥å£
interface EventStore {
  saveEvents(
    aggregateId: string,
    events: DomainEvent[],
    expectedVersion: number
  ): Promise<void>;
  getEvents(aggregateId: string): Promise<DomainEvent[]>;
  getEventsByType(eventType: string): Promise<DomainEvent[]>;
  getEventsByDateRange(from: Date, to: Date): Promise<DomainEvent[]>;
}

// PostgreSQLäº‹ä»¶å­˜å‚¨å®ç°
@Injectable()
export class PostgreSQLEventStore implements EventStore {
  constructor(private readonly dataSource: DataSource) {}

  async saveEvents(
    aggregateId: string,
    events: DomainEvent[],
    expectedVersion: number
  ): Promise<void> {
    const queryRunner = this.dataSource.createQueryRunner();
    await queryRunner.connect();
    await queryRunner.startTransaction();

    try {
      // æ£€æŸ¥ç‰ˆæœ¬å†²çª
      const currentVersion = await this.getCurrentVersion(aggregateId);
      if (currentVersion !== expectedVersion) {
        throw new ConcurrencyException(
          aggregateId,
          expectedVersion,
          currentVersion
        );
      }

      // ä¿å­˜äº‹ä»¶
      for (const event of events) {
        await queryRunner.query(
          `INSERT INTO domain_events (event_id, aggregate_id, aggregate_type, event_type, event_data, version, created_at) 
           VALUES ($1, $2, $3, $4, $5, $6, $7)`,
          [
            event.eventId,
            event.aggregateId,
            event.aggregateType,
            event.eventType,
            JSON.stringify(event.eventData),
            expectedVersion + 1,
            event.timestamp,
          ]
        );
        expectedVersion++;
      }

      await queryRunner.commitTransaction();
    } catch (error) {
      await queryRunner.rollbackTransaction();
      throw error;
    } finally {
      await queryRunner.release();
    }
  }

  async getEvents(aggregateId: string): Promise<DomainEvent[]> {
    const result = await this.dataSource.query(
      `SELECT * FROM domain_events WHERE aggregate_id = $1 ORDER BY version ASC`,
      [aggregateId]
    );
    return result.map(this.mapToDomainEvent);
  }

  private mapToDomainEvent(row: any): DomainEvent {
    return {
      eventId: row.event_id,
      aggregateId: row.aggregate_id,
      aggregateType: row.aggregate_type,
      eventType: row.event_type,
      eventData: JSON.parse(row.event_data),
      metadata: JSON.parse(row.metadata || '{}'),
      timestamp: new Date(row.created_at),
      version: row.version,
    };
  }
}
```

#### é¢†åŸŸæ¨¡å‹åˆ†å±‚è®¾è®¡

```typescript
// 1. èšåˆæ ¹åŸºç±» - ä¸šåŠ¡è§„åˆ™å’Œä¸€è‡´æ€§è¾¹ç•Œ
abstract class AggregateRoot {
  private uncommittedEvents: DomainEvent[] = [];
  private version: number = 0;

  protected apply(event: DomainEvent): void {
    this.uncommittedEvents.push(event);
    this.when(event);
  }

  protected abstract when(event: DomainEvent): void;

  getUncommittedEvents(): DomainEvent[] {
    return this.uncommittedEvents;
  }

  markEventsAsCommitted(): void {
    this.uncommittedEvents = [];
  }

  getVersion(): number {
    return this.version;
  }

  setVersion(version: number): void {
    this.version = version;
  }

  static rebuildFromEvents<T extends AggregateRoot>(
    this: new () => T,
    events: DomainEvent[]
  ): T {
    const aggregate = new this();
    events.forEach((event) => aggregate.when(event));
    aggregate.setVersion(events.length);
    return aggregate;
  }
}

// 2. è§’è‰²èšåˆæ ¹ - è§’è‰²çº§ä¸šåŠ¡è§„åˆ™å’Œä¸€è‡´æ€§è¾¹ç•Œ
export class RoleAggregate extends AggregateRoot {
  private role: RoleEntity;
  private uncommittedEvents: DomainEvent[] = [];

  static create(
    name: string,
    code: string,
    description: string,
    tenantId: string
  ): RoleAggregate {
    const aggregate = new RoleAggregate();
    const roleId = RoleId.generate();

    // åˆ›å»ºè§’è‰²å®ä½“
    aggregate.role = RoleEntity.create(roleId, name, code, description, tenantId);

    // åº”ç”¨ä¸šåŠ¡è§„åˆ™
    aggregate.validateRoleCode(code);

    // äº§ç”Ÿé¢†åŸŸäº‹ä»¶
    aggregate.apply(new RoleCreatedEvent(roleId, name, code, tenantId));

    return aggregate;
  }

  changeName(newName: string): void {
    // ä¸šåŠ¡è§„åˆ™éªŒè¯
    if (this.role.name === newName) {
      return;
    }

    // æ›´æ–°å®ä½“
    this.role.changeName(newName);

    // äº§ç”Ÿé¢†åŸŸäº‹ä»¶
    this.apply(
      new RoleNameChangedEvent(this.role.id, this.role.name, newName)
    );
  }

  changeDescription(newDescription: string): void {
    if (this.role.description === newDescription) {
      return;
    }
    this.apply(new RoleDescriptionChangedEvent(this.role.id, this.role.description, newDescription));
  }

  protected when(event: DomainEvent): void {
    if (event instanceof RoleCreatedEvent) {
      this.role = RoleEntity.create(
        new RoleId(event.roleId),
        event.name,
        event.code,
        event.description,
        event.tenantId
      );
    } else if (event instanceof RoleNameChangedEvent) {
      this.role.changeName(event.newName);
    } else if (event instanceof RoleDescriptionChangedEvent) {
      this.role.changeDescription(event.newDescription);
    }
  }

  private validateRoleCode(code: string): void {
    // è§’è‰²ä»£ç éªŒè¯ä¸šåŠ¡è§„åˆ™
    if (!/^[A-Z_][A-Z0-9_]*$/.test(code)) {
      throw new InvalidRoleCodeException(
        'Role code must start with uppercase letter and contain only uppercase letters, numbers and underscores'
      );
    }
  }

  // Getters
  getId(): RoleId {
    return this.role.id;
  }

  getRole(): RoleEntity {
    return this.role;
  }
}

// 3. æƒé™èšåˆæ ¹ - æƒé™çº§ä¸šåŠ¡è§„åˆ™å’Œä¸€è‡´æ€§è¾¹ç•Œ
export class PermissionAggregate extends AggregateRoot {
  private permission: PermissionEntity;
  private uncommittedEvents: DomainEvent[] = [];

  static create(
    name: string,
    code: string,
    resource: string,
    action: string,
    tenantId: string
  ): PermissionAggregate {
    const aggregate = new PermissionAggregate();
    const permissionId = PermissionId.generate();

    // åˆ›å»ºæƒé™å®ä½“
    aggregate.permission = PermissionEntity.create(
      permissionId,
      name,
      code,
      resource,
      action,
      tenantId
    );

    // åº”ç”¨ä¸šåŠ¡è§„åˆ™
    aggregate.validatePermissionCode(code);

    // äº§ç”Ÿé¢†åŸŸäº‹ä»¶
    aggregate.apply(new PermissionCreatedEvent(
      permissionId,
      name,
      code,
      resource,
      action,
      tenantId
    ));

    return aggregate;
  }

  changeResource(newResource: string): void {
    if (this.permission.resource === newResource) {
      return;
    }
    this.apply(new PermissionResourceChangedEvent(
      this.permission.id.toString(),
      this.permission.resource,
      newResource
    ));
  }

  changeAction(newAction: string): void {
    if (this.permission.action === newAction) {
      return;
    }
    this.apply(new PermissionActionChangedEvent(
      this.permission.id.toString(),
      this.permission.action,
      newAction
    ));
  }

  protected when(event: DomainEvent): void {
    if (event instanceof PermissionCreatedEvent) {
      this.permission = PermissionEntity.create(
        new PermissionId(event.permissionId),
        event.name,
        event.code,
        event.resource,
        event.action,
        event.tenantId
      );
    } else if (event instanceof PermissionResourceChangedEvent) {
      this.permission.changeResource(event.newResource);
    } else if (event instanceof PermissionActionChangedEvent) {
      this.permission.changeAction(event.newAction);
    }
  }

  private validatePermissionCode(code: string): void {
    // æƒé™ä»£ç éªŒè¯ä¸šåŠ¡è§„åˆ™
    if (!/^[A-Z_][A-Z0-9_]*$/.test(code)) {
      throw new InvalidPermissionCodeException(
        'Permission code must start with uppercase letter and contain only uppercase letters, numbers and underscores'
      );
    }
  }

  // Getters
  getId(): PermissionId {
    return this.permission.id;
  }

  getPermission(): PermissionEntity {
    return this.permission;
  }
}

// 3. è§’è‰²å®ä½“ - è§’è‰²çº§ä¸šåŠ¡å®ä½“ï¼Œæœ‰æ ‡è¯†
export class RoleEntity extends DataIsolationAwareEntity {
  constructor(
    id: RoleId,
    private name: string,
    private code: string,
    private description: string,
    private tenantId: string,
    private status: RoleStatus = RoleStatus.ACTIVE,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED
  ) {
    super(
      new Uuid(tenantId),
      DataIsolationLevel.TENANT,
      dataPrivacyLevel,
      id
    );
  }

  static create(
    id: RoleId,
    name: string,
    code: string,
    description: string,
    tenantId: string
  ): RoleEntity {
    return new RoleEntity(id, name, code, description, tenantId);
  }

  changeName(newName: string): void {
    this.name = newName;
  }

  changeDescription(newDescription: string): void {
    this.description = newDescription;
  }

  // Getters
  get id(): RoleId {
    return this._id as RoleId;
  }
  get roleName(): string {
    return this.name;
  }
  get roleCode(): string {
    return this.code;
  }
  get roleDescription(): string {
    return this.description;
  }
  get roleStatus(): RoleStatus {
    return this.status;
  }
}

// 4. æƒé™å®ä½“ - æƒé™çº§ä¸šåŠ¡å®ä½“ï¼Œæœ‰æ ‡è¯†
export class PermissionEntity extends DataIsolationAwareEntity {
  constructor(
    id: PermissionId,
    private name: string,
    private code: string,
    private resource: string,
    private action: string,
    private tenantId: string,
    private status: PermissionStatus = PermissionStatus.ACTIVE,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED
  ) {
    super(
      new Uuid(tenantId),
      DataIsolationLevel.TENANT,
      dataPrivacyLevel,
      id
    );
  }

  static create(
    id: PermissionId,
    name: string,
    code: string,
    resource: string,
    action: string,
    tenantId: string
  ): PermissionEntity {
    return new PermissionEntity(id, name, code, resource, action, tenantId);
  }

  changeResource(newResource: string): void {
    this.resource = newResource;
  }

  changeAction(newAction: string): void {
    this.action = newAction;
  }

  // Getters
  get id(): PermissionId {
    return this._id as PermissionId;
  }
  get permissionName(): string {
    return this.name;
  }
  get permissionCode(): string {
    return this.code;
  }
  get permissionResource(): string {
    return this.resource;
  }
  get permissionAction(): string {
    return this.action;
  }
  get permissionStatus(): PermissionStatus {
    return this.status;
  }
}

// 4. å€¼å¯¹è±¡ - ä¸å¯å˜å¯¹è±¡
export class RoleId {
  constructor(private readonly value: string) {}

  static generate(): RoleId {
    return new RoleId(crypto.randomUUID());
  }

  equals(other: RoleId): boolean {
    return this.value === other.value;
  }

  toString(): string {
    return this.value;
  }
}

export class PermissionId {
  constructor(private readonly value: string) {}

  static generate(): PermissionId {
    return new PermissionId(crypto.randomUUID());
  }

  equals(other: PermissionId): boolean {
    return this.value === other.value;
  }

  toString(): string {
    return this.value;
  }
}

export class Uuid {
  constructor(private readonly value: string) {}

  static generate(): Uuid {
    return new Uuid(crypto.randomUUID());
  }

  equals(other: Uuid): boolean {
    return this.value === other.value;
  }

  toString(): string {
    return this.value;
  }
}
```

#### è¯»æ¨¡å‹æŠ•å½±

```typescript
// æŠ•å½±æ¥å£
interface Projection {
  handle(event: DomainEvent): Promise<void>;
}

// ä¼šè¯è¯»æ¨¡å‹æŠ•å½±
@Injectable()
export class SessionReadModelProjection implements Projection {
  constructor(private readonly sessionReadModel: SessionReadModel) {}

  async handle(event: DomainEvent): Promise<void> {
    if (event instanceof SessionCreatedEvent) {
      await this.sessionReadModel.create({
        id: event.eventData.sessionId,
        userId: event.eventData.userId,
        tenantId: event.eventData.tenantId,
        deviceInfo: event.eventData.deviceInfo,
        ipAddress: event.eventData.ipAddress,
        userAgent: event.eventData.userAgent,
        expiresAt: event.eventData.expiresAt,
        status: 'ACTIVE',
        createdAt: event.timestamp,
      });
    } else if (event instanceof SessionRefreshedEvent) {
      await this.sessionReadModel.updateExpiresAt(
        event.eventData.sessionId,
        event.eventData.newExpiresAt
      );
    } else if (event instanceof SessionTerminatedEvent) {
      await this.sessionReadModel.updateStatus(
        event.eventData.sessionId,
        'TERMINATED'
      );
    }
  }
}

// è§’è‰²è¯»æ¨¡å‹æœåŠ¡
@Injectable()
export class RoleReadModel {
  constructor(private readonly dataSource: DataSource) {}

  async create(roleData: RoleDto): Promise<void> {
    await this.dataSource.query(
      `INSERT INTO roles_read_model (
        id, name, code, description, tenant_id, status, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7)`,
      [
        roleData.id,
        roleData.name,
        roleData.code,
        roleData.description,
        roleData.tenantId,
        roleData.status,
        roleData.createdAt,
      ]
    );
  }

  async updateName(roleId: string, name: string): Promise<void> {
    await this.dataSource.query(
      `UPDATE roles_read_model SET name = $1, updated_at = NOW() WHERE id = $2`,
      [name, roleId]
    );
  }

  async updateDescription(roleId: string, description: string): Promise<void> {
    await this.dataSource.query(
      `UPDATE roles_read_model SET description = $1, updated_at = NOW() WHERE id = $2`,
      [description, roleId]
    );
  }

  async findById(roleId: string): Promise<RoleDto | null> {
    const result = await this.dataSource.query(
      `SELECT * FROM roles_read_model WHERE id = $1`,
      [roleId]
    );
    return result.length > 0 ? this.mapToRoleDto(result[0]) : null;
  }

  async findByTenant(
    tenantId: string,
    page: number,
    size: number
  ): Promise<RoleDto[]> {
    const offset = (page - 1) * size;
    const result = await this.dataSource.query(
      `SELECT * FROM roles_read_model WHERE tenant_id = $1 ORDER BY created_at DESC LIMIT $2 OFFSET $3`,
      [tenantId, size, offset]
    );
    return result.map(this.mapToRoleDto);
  }

  private mapToRoleDto(row: any): RoleDto {
    return {
      id: row.id,
      name: row.name,
      code: row.code,
      description: row.description,
      tenantId: row.tenant_id,
      status: row.status,
      createdAt: new Date(row.created_at),
      updatedAt: new Date(row.updated_at),
    };
  }
}

// æƒé™è¯»æ¨¡å‹æœåŠ¡
@Injectable()
export class PermissionReadModel {
  constructor(private readonly dataSource: DataSource) {}

  async create(permissionData: PermissionDto): Promise<void> {
    await this.dataSource.query(
      `INSERT INTO permissions_read_model (
        id, name, code, resource, action, tenant_id, status, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)`,
      [
        permissionData.id,
        permissionData.name,
        permissionData.code,
        permissionData.resource,
        permissionData.action,
        permissionData.tenantId,
        permissionData.status,
        permissionData.createdAt,
      ]
    );
  }

  async updateResource(permissionId: string, resource: string): Promise<void> {
    await this.dataSource.query(
      `UPDATE permissions_read_model SET resource = $1, updated_at = NOW() WHERE id = $2`,
      [resource, permissionId]
    );
  }

  async updateAction(permissionId: string, action: string): Promise<void> {
    await this.dataSource.query(
      `UPDATE permissions_read_model SET action = $1, updated_at = NOW() WHERE id = $2`,
      [action, permissionId]
    );
  }

  async findById(permissionId: string): Promise<PermissionDto | null> {
    const result = await this.dataSource.query(
      `SELECT * FROM permissions_read_model WHERE id = $1`,
      [permissionId]
    );
    return result.length > 0 ? this.mapToPermissionDto(result[0]) : null;
  }

  async findByTenant(
    tenantId: string,
    page: number,
    size: number
  ): Promise<PermissionDto[]> {
    const offset = (page - 1) * size;
    const result = await this.dataSource.query(
      `SELECT * FROM permissions_read_model WHERE tenant_id = $1 ORDER BY created_at DESC LIMIT $2 OFFSET $3`,
      [tenantId, size, offset]
    );
    return result.map(this.mapToPermissionDto);
  }

  private mapToPermissionDto(row: any): PermissionDto {
    return {
      id: row.id,
      name: row.name,
      code: row.code,
      resource: row.resource,
      action: row.action,
      tenantId: row.tenant_id,
      status: row.status,
      createdAt: new Date(row.created_at),
      updatedAt: new Date(row.updated_at),
    };
  }
}
```

## ğŸ” å®‰å…¨æ¶æ„ä¸æ•°æ®éš”ç¦»è®¾è®¡

### æ•°æ®éš”ç¦»ç­–ç•¥

#### 4.1 å¤šå±‚çº§æ•°æ®éš”ç¦»

```
æ•°æ®éš”ç¦»å±‚çº§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Platform Level                       â”‚
â”‚                 (å¹³å°çº§æ•°æ®éš”ç¦»)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     Tenant Level                        â”‚
â”‚                  (ç§Ÿæˆ·çº§æ•°æ®éš”ç¦»)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Organization Level                     â”‚
â”‚                 (ç»„ç»‡çº§æ•°æ®éš”ç¦»)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   Department Level                     â”‚
â”‚                  (éƒ¨é—¨çº§æ•°æ®éš”ç¦»)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     User Level                         â”‚
â”‚                   (ç”¨æˆ·çº§æ•°æ®éš”ç¦»)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2 æ•°æ®éšç§çº§åˆ«

```
æ•°æ®éšç§çº§åˆ«ï¼š
1. PUBLICï¼ˆå…¬å¼€æ•°æ®ï¼‰
   - å¯ä»¥è¢«ä»»ä½•äººè®¿é—®
   - é€‚ç”¨äºå…¬å¼€ä¿¡æ¯

2. SHAREDï¼ˆå…±äº«æ•°æ®ï¼‰
   - å¯ä»¥åœ¨æŒ‡å®šèŒƒå›´å†…å…±äº«
   - é€‚ç”¨äºå†…éƒ¨å…±äº«ä¿¡æ¯

3. PROTECTEDï¼ˆå—ä¿æŠ¤æ•°æ®ï¼‰
   - éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½è®¿é—®
   - é€‚ç”¨äºæ•æ„Ÿä¿¡æ¯

4. PRIVATEï¼ˆç§æœ‰æ•°æ®ï¼‰
   - åªæœ‰æ‰€æœ‰è€…å¯ä»¥è®¿é—®
   - é€‚ç”¨äºä¸ªäººéšç§ä¿¡æ¯
```

### æ•°æ®éš”ç¦»ä¸è®¿é—®æ§åˆ¶æ¶æ„

#### æ•°æ®éš”ç¦»çº§åˆ«

```typescript
export enum DataIsolationLevel {
  /** å¹³å°çº§éš”ç¦» */
  PLATFORM = 'platform',
  /** ç§Ÿæˆ·çº§éš”ç¦» */
  TENANT = 'tenant',
  /** ç»„ç»‡çº§éš”ç¦» */
  ORGANIZATION = 'organization',
  /** éƒ¨é—¨çº§éš”ç¦» */
  DEPARTMENT = 'department',
  /** å­éƒ¨é—¨çº§éš”ç¦» */
  SUB_DEPARTMENT = 'sub_department',
  /** ç”¨æˆ·çº§éš”ç¦» */
  USER = 'user',
}

export enum DataPrivacyLevel {
  /** å¯å…±äº« */
  SHARED = 'shared',
  /** å—ä¿æŠ¤ */
  PROTECTED = 'protected',
}
```

#### æ•°æ®éš”ç¦»å±‚æ¬¡ç»“æ„

```
å¹³å° (Platform)
â”œâ”€â”€ å¹³å°çº§æ•°æ® (Platform Data)
â”‚   â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
â”‚   â”‚   â”œâ”€â”€ å¹³å°å…¬å‘Š
â”‚   â”‚   â”œâ”€â”€ ç³»ç»Ÿé€šçŸ¥
â”‚   â”‚   â”œâ”€â”€ å…¬å…±APIæ–‡æ¡£
â”‚   â”‚   â””â”€â”€ å¹³å°ç‰ˆæœ¬ä¿¡æ¯
â”‚   â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
â”‚       â”œâ”€â”€ å¹³å°é…ç½®
â”‚       â”œâ”€â”€ ç³»ç»Ÿæ—¥å¿—
â”‚       â”œâ”€â”€ ç®¡ç†å‘˜æ•°æ®
â”‚       â””â”€â”€ ç³»ç»Ÿç»´æŠ¤é…ç½®
â””â”€â”€ ç§Ÿæˆ· (Tenant)
    â”œâ”€â”€ ç§Ÿæˆ·çº§æ•°æ® (Tenant Data)
    â”‚   â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
    â”‚   â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
    â”œâ”€â”€ ç»„ç»‡ (Organization)
    â”‚   â”œâ”€â”€ ç»„ç»‡çº§æ•°æ® (Organization Data)
    â”‚   â”‚   â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
    â”‚   â”‚   â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
    â”‚   â”œâ”€â”€ éƒ¨é—¨ (Department)
    â”‚   â”‚   â”œâ”€â”€ éƒ¨é—¨çº§æ•°æ® (Department Data)
    â”‚   â”‚   â”‚   â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
    â”‚   â”‚   â”‚   â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
    â”‚   â”‚   â””â”€â”€ å­éƒ¨é—¨ (Sub-Department)
    â”‚   â”‚       â””â”€â”€ å­éƒ¨é—¨çº§æ•°æ® (Sub-Department Data)
    â”‚   â””â”€â”€ ç”¨æˆ·çº§æ•°æ® (User Data)
    â”‚       â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
    â”‚       â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
    â””â”€â”€ ç”¨æˆ·çº§æ•°æ® (User Data)
        â”œâ”€â”€ å¯å…±äº«æ•°æ® (Shared Data)
        â””â”€â”€ å—ä¿æŠ¤æ•°æ® (Protected Data)
```

#### å®ä½“åŸºç±»è®¾è®¡

```typescript
// å¹³å°æ„ŸçŸ¥å®ä½“åŸºç±»
export abstract class PlatformAwareEntity extends BaseEntity {
  protected _dataPrivacyLevel: DataPrivacyLevel;

  constructor(
    id?: Uuid,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED
  ) {
    super(id ?? Uuid.generate());
    this._dataPrivacyLevel = dataPrivacyLevel;
  }

  public canAccess(target: PlatformAwareEntity): boolean {
    try {
      // å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯å¯å…±äº«æ•°æ®ï¼Œåˆ™å…è®¸è®¿é—®
      if (target._dataPrivacyLevel === DataPrivacyLevel.SHARED) {
        return true;
      }

      // å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯å—ä¿æŠ¤æ•°æ®ï¼Œåˆ™éœ€è¦å¹³å°ç®¡ç†å‘˜æƒé™
      if (target._dataPrivacyLevel === DataPrivacyLevel.PROTECTED) {
        return this.isPlatformAdmin();
      }

      return false;
    } catch {
      return false;
    }
  }

  protected abstract isPlatformAdmin(): boolean;

  public isSharedData(): boolean {
    return this._dataPrivacyLevel === DataPrivacyLevel.SHARED;
  }

  public isProtectedData(): boolean {
    return this._dataPrivacyLevel === DataPrivacyLevel.PROTECTED;
  }

  protected assertPlatformAccess(target: PlatformAwareEntity): void {
    if (!this.canAccess(target)) {
      throw new PlatformAccessDeniedError(
        `å¹³å°çº§è®¿é—®è¢«æ‹’ç»: ç›®æ ‡å¯¹è±¡éšç§çº§åˆ«ä¸º${target._dataPrivacyLevel}`
      );
    }
  }
}

// æ•°æ®éš”ç¦»æ„ŸçŸ¥å®ä½“åŸºç±»
export abstract class DataIsolationAwareEntity extends BaseEntity {
  protected readonly _tenantId: Uuid;
  protected _organizationId?: Uuid;
  protected _departmentIds: Uuid[] = [];
  protected _userId?: Uuid;
  protected _dataIsolationLevel: DataIsolationLevel;
  protected _dataPrivacyLevel: DataPrivacyLevel;

  constructor(
    tenantId: Uuid,
    dataIsolationLevel: DataIsolationLevel = DataIsolationLevel.TENANT,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid,
    organizationId?: Uuid,
    departmentIds: Uuid[] = [],
    userId?: Uuid
  ) {
    super(id ?? Uuid.generate());
    this._tenantId = tenantId;
    this._dataIsolationLevel = dataIsolationLevel;
    this._dataPrivacyLevel = dataPrivacyLevel;
    this._organizationId = organizationId;
    this._departmentIds = [...departmentIds];
    this._userId = userId;
  }

  public canAccess(target: DataIsolationAwareEntity): boolean {
    try {
      // å¹³å°çº§æ•°æ®è®¿é—®æ§åˆ¶
      if (target._dataIsolationLevel === DataIsolationLevel.PLATFORM) {
        return this.canAccessPlatformData(target);
      }

      // ç”¨æˆ·çº§æ•°æ®è®¿é—®æ§åˆ¶ï¼ˆè·¨å±‚çº§å­˜åœ¨ï¼‰
      if (target._dataIsolationLevel === DataIsolationLevel.USER) {
        return this.canAccessUserData(target);
      }

      // å…¶ä»–çº§åˆ«çš„è®¿é—®æ§åˆ¶
      return this.canAccessByLevel(target, target._dataIsolationLevel);
    } catch {
      return false;
    }
  }

  private canAccessPlatformData(target: DataIsolationAwareEntity): boolean {
    if (target._dataPrivacyLevel === DataPrivacyLevel.SHARED) {
      return true; // å¯å…±äº«çš„å¹³å°æ•°æ®ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å¯è®¿é—®
    }
    return this.isPlatformAdmin();
  }

  private canAccessUserData(target: DataIsolationAwareEntity): boolean {
    if (target._dataPrivacyLevel === DataPrivacyLevel.SHARED) {
      return this.isInSameOrganization(target);
    }
    return this._userId?.equals(target._userId) ?? false;
  }

  private canAccessByLevel(
    target: DataIsolationAwareEntity,
    level: DataIsolationLevel
  ): boolean {
    // é¦–å…ˆæ£€æŸ¥ç§Ÿæˆ·æ˜¯å¦åŒ¹é…
    if (!this._tenantId.equals(target.tenantId)) {
      return false;
    }

    // å¦‚æœç›®æ ‡å¯¹è±¡æ˜¯ç§Ÿæˆ·çº§å…¬å…±æ•°æ®ï¼Œåˆ™å…è®¸è®¿é—®
    if (target._dataIsolationLevel === DataIsolationLevel.TENANT) {
      return true;
    }

    switch (level) {
      case DataIsolationLevel.TENANT:
        return true; // ç§Ÿæˆ·çº§è®¿é—®å…è®¸è®¿é—®æ‰€æœ‰åŒç§Ÿæˆ·æ•°æ®
      case DataIsolationLevel.ORGANIZATION:
        this.assertSameOrganization(target);
        return true;
      case DataIsolationLevel.DEPARTMENT:
        this.assertSameDepartment(target);
        return true;
      case DataIsolationLevel.SUB_DEPARTMENT:
        this.assertSameDepartment(target);
        return true;
      default:
        return false;
    }
  }

  protected assertSameTenant(other: DataIsolationAwareEntity): void {
    if (!this._tenantId.equals(other.tenantId)) {
      throw new TenantAccessDeniedError(
        `æ“ä½œç¦æ­¢: å®ä½“å±äºç§Ÿæˆ·${this._tenantId.toString()}ï¼Œç›®æ ‡å±äº${other.tenantId.toString()}`
      );
    }
  }

  protected assertSameOrganization(other: DataIsolationAwareEntity): void {
    this.assertSameTenant(other);
    if (this._organizationId && other.organizationId) {
      if (!this._organizationId.equals(other.organizationId)) {
        throw new TenantAccessDeniedError(
          `æ“ä½œç¦æ­¢: å®ä½“å±äºç»„ç»‡${this._organizationId.toString()}ï¼Œç›®æ ‡å±äº${other.organizationId.toString()}`
        );
      }
    }
  }

  protected assertSameDepartment(other: DataIsolationAwareEntity): void {
    this.assertSameOrganization(other);
    const commonDepartments = this._departmentIds.filter((deptId) =>
      other.departmentIds.some((otherDeptId) => deptId.equals(otherDeptId))
    );
    if (commonDepartments.length === 0) {
      throw new TenantAccessDeniedError(
        `æ“ä½œç¦æ­¢: å®ä½“ä¸ç›®æ ‡å¯¹è±¡æ²¡æœ‰å…±åŒçš„éƒ¨é—¨å½’å±`
      );
    }
  }
}
```

### è®¤è¯æ¶æ„

#### JWT Token è®¾è®¡

```typescript
interface JWTPayload {
  sub: string; // ç”¨æˆ·ID
  tenantId: string; // ç§Ÿæˆ·ID
  orgIds: string[]; // ç»„ç»‡IDåˆ—è¡¨
  deptIds: string[]; // éƒ¨é—¨IDåˆ—è¡¨
  roles: string[]; // è§’è‰²åˆ—è¡¨
  permissions: string[]; // æƒé™åˆ—è¡¨
  iat: number; // ç­¾å‘æ—¶é—´
  exp: number; // è¿‡æœŸæ—¶é—´
  jti: string; // JWT ID
}
```

#### å¤šå› å­è®¤è¯

```typescript
interface MFAConfig {
  type: 'TOTP' | 'SMS' | 'EMAIL';
  enabled: boolean;
  backupCodes: string[];
  lastUsed: Date;
}
```

### æƒé™æ§åˆ¶æ¶æ„

#### RBAC + ABAC + æ•°æ®éš”ç¦»æ··åˆæ¨¡å‹

```typescript
interface Permission {
  resource: string; // èµ„æºæ ‡è¯†
  action: string; // æ“ä½œç±»å‹
  conditions: Condition[]; // è®¿é—®æ¡ä»¶
  isolationLevel: DataIsolationLevel; // æ•°æ®éš”ç¦»çº§åˆ«
  privacyLevel: DataPrivacyLevel; // éšç§çº§åˆ«
}

interface Condition {
  attribute: string; // å±æ€§å
  operator: string; // æ“ä½œç¬¦
  value: any; // å±æ€§å€¼
}

// æƒé™æ£€æŸ¥æœåŠ¡
@Injectable()
export class PermissionService {
  constructor(
    private readonly dataAccessControlService: DataAccessControlService,
    private readonly userRepository: UserRepository,
    private readonly permissionRepository: PermissionRepository
  ) {}

  async checkPermission(
    userId: string,
    resource: string,
    action: string,
    targetEntity?: DataIsolationAwareEntity
  ): Promise<boolean> {
    // 1. è·å–ç”¨æˆ·ä¿¡æ¯
    const user = await this.userRepository.findById(userId);
    if (!user) {
      return false;
    }

    // 2. è·å–ç”¨æˆ·æƒé™
    const permissions = await this.permissionRepository.findUserPermissions(
      userId,
      user.tenantId
    );

    // 3. æ£€æŸ¥æƒé™
    const hasPermission = permissions.some(
      (permission) =>
        permission.resource === resource && permission.action === action
    );

    if (!hasPermission) {
      return false;
    }

    // 4. å¦‚æœæœ‰ç›®æ ‡å®ä½“ï¼Œè¿›è¡Œæ•°æ®éš”ç¦»æ£€æŸ¥
    if (targetEntity) {
      return user.canAccess(targetEntity);
    }

    return true;
  }

  async checkDataAccess(
    userId: string,
    targetEntity: DataIsolationAwareEntity
  ): Promise<boolean> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      return false;
    }

    return user.canAccess(targetEntity);
  }
}
```

### æ•°æ®å®‰å…¨æ¶æ„

#### æ•°æ®éš”ç¦»ç­–ç•¥

- **å¹³å°çº§éš”ç¦»**: ç³»ç»Ÿçº§åˆ«éš”ç¦»ï¼Œåªæœ‰å¹³å°ç®¡ç†å‘˜å¯è®¿é—®
- **ç§Ÿæˆ·çº§éš”ç¦»**: æ•°æ®åº“çº§åˆ«éš”ç¦»ï¼Œç¡®ä¿ç§Ÿæˆ·é—´æ•°æ®å®Œå…¨éš”ç¦»
- **ç»„ç»‡çº§éš”ç¦»**: åº”ç”¨çº§åˆ«éš”ç¦»ï¼Œç»„ç»‡é—´æ•°æ®éš”ç¦»
- **éƒ¨é—¨çº§éš”ç¦»**: æ•°æ®çº§åˆ«éš”ç¦»ï¼Œéƒ¨é—¨é—´æ•°æ®éš”ç¦»
- **å­éƒ¨é—¨çº§éš”ç¦»**: ç»†ç²’åº¦æ•°æ®éš”ç¦»ï¼Œå­éƒ¨é—¨é—´æ•°æ®éš”ç¦»
- **ç”¨æˆ·çº§éš”ç¦»**: è¡Œçº§åˆ«éš”ç¦»ï¼Œç”¨æˆ·é—´æ•°æ®éš”ç¦»

#### æ•°æ®è®¿é—®æ§åˆ¶ç­–ç•¥

- **éšç§çº§åˆ«æ§åˆ¶**: åŸºäº `DataPrivacyLevel` çš„è®¿é—®æ§åˆ¶
  - **å¯å…±äº«æ•°æ®**: åŒçº§åˆ«å†…æ‰€æœ‰æˆå‘˜å¯è®¿é—®
  - **å—ä¿æŠ¤æ•°æ®**: éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½è®¿é—®
- **è·¨å±‚çº§è®¿é—®æ§åˆ¶**: æ”¯æŒä»é«˜çº§åˆ«å‘ä½çº§åˆ«çš„è®¿é—®æ§åˆ¶
- **ç”¨æˆ·çº§æ•°æ®è·¨å±‚çº§**: ç”¨æˆ·çº§æ•°æ®å¯ä»¥å­˜åœ¨äºä»»ä½•ç»„ç»‡å±‚çº§ä¸‹ï¼Œä½†è®¿é—®æ§åˆ¶åŸºäºç”¨æˆ·èº«ä»½

#### 4.14 ä¸ªäººæ•°æ®ä¸éƒ¨é—¨æ•°æ®è®¿é—®æ§åˆ¶æœºåˆ¶

##### 4.14.1 æ•°æ®åˆ†ç±»å®šä¹‰

```typescript
export enum DataOwnershipType {
  /** ä¸ªäººæ•°æ® - ç”¨æˆ·åˆ›å»ºå’Œæ‹¥æœ‰çš„æ•°æ® */
  PERSONAL = 'personal',
  /** éƒ¨é—¨æ•°æ® - éƒ¨é—¨å†…éƒ¨å…±äº«çš„æ•°æ® */
  DEPARTMENT = 'department',
  /** ç»„ç»‡æ•°æ® - ç»„ç»‡å†…éƒ¨å…±äº«çš„æ•°æ® */
  ORGANIZATION = 'organization',
  /** ç§Ÿæˆ·æ•°æ® - ç§Ÿæˆ·å†…éƒ¨å…±äº«çš„æ•°æ® */
  TENANT = 'tenant',
  /** å¹³å°æ•°æ® - å¹³å°çº§å…±äº«çš„æ•°æ® */
  PLATFORM = 'platform',
}

export enum DataAccessScope {
  /** ç§æœ‰è®¿é—® - åªæœ‰æ‰€æœ‰è€…å¯ä»¥è®¿é—® */
  PRIVATE = 'private',
  /** éƒ¨é—¨è®¿é—® - éƒ¨é—¨å†…æˆå‘˜å¯ä»¥è®¿é—® */
  DEPARTMENT = 'department',
  /** ç»„ç»‡è®¿é—® - ç»„ç»‡å†…æˆå‘˜å¯ä»¥è®¿é—® */
  ORGANIZATION = 'organization',
  /** ç§Ÿæˆ·è®¿é—® - ç§Ÿæˆ·å†…æˆå‘˜å¯ä»¥è®¿é—® */
  TENANT = 'tenant',
  /** å¹³å°è®¿é—® - å¹³å°å†…æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—® */
  PLATFORM = 'platform',
}
```

##### 4.14.2 æ•°æ®è®¿é—®æ§åˆ¶å®ä½“è®¾è®¡

```typescript
// æ•°æ®è®¿é—®æ§åˆ¶å®ä½“åŸºç±»
export abstract class DataAccessControlledEntity extends DataIsolationAwareEntity {
  protected _dataOwnershipType: DataOwnershipType;
  protected _dataAccessScope: DataAccessScope;
  protected _ownerId: Uuid;
  protected _sharedWithUsers: Uuid[] = [];
  protected _sharedWithDepartments: Uuid[] = [];
  protected _sharedWithOrganizations: Uuid[] = [];

  constructor(
    tenantId: Uuid,
    dataIsolationLevel: DataIsolationLevel,
    dataPrivacyLevel: DataPrivacyLevel,
    dataOwnershipType: DataOwnershipType,
    dataAccessScope: DataAccessScope,
    ownerId: Uuid,
    id?: Uuid,
    organizationId?: Uuid,
    departmentIds: Uuid[] = [],
    userId?: Uuid
  ) {
    super(
      tenantId,
      dataIsolationLevel,
      dataPrivacyLevel,
      id,
      organizationId,
      departmentIds,
      userId
    );
    this._dataOwnershipType = dataOwnershipType;
    this._dataAccessScope = dataAccessScope;
    this._ownerId = ownerId;
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®æ­¤å®ä½“
   * @param user è¯·æ±‚è®¿é—®çš„ç”¨æˆ·
   * @returns æ˜¯å¦å…è®¸è®¿é—®
   */
  public canAccess(user: DataIsolationAwareEntity): boolean {
    // 1. åŸºç¡€æ•°æ®éš”ç¦»æ£€æŸ¥
    if (!super.canAccess(user)) {
      return false;
    }

    // 2. æ‰€æœ‰è€…æ£€æŸ¥
    if (this._ownerId.equals(user.id)) {
      return true;
    }

    // 3. æ•°æ®è®¿é—®èŒƒå›´æ£€æŸ¥
    switch (this._dataAccessScope) {
      case DataAccessScope.PRIVATE:
        return false; // ç§æœ‰æ•°æ®åªæœ‰æ‰€æœ‰è€…å¯ä»¥è®¿é—®
      
      case DataAccessScope.DEPARTMENT:
        return this.canAccessByDepartment(user);
      
      case DataAccessScope.ORGANIZATION:
        return this.canAccessByOrganization(user);
      
      case DataAccessScope.TENANT:
        return this.canAccessByTenant(user);
      
      case DataAccessScope.PLATFORM:
        return true; // å¹³å°çº§æ•°æ®æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®
      
      default:
        return false;
    }
  }

  /**
   * éƒ¨é—¨çº§è®¿é—®æ§åˆ¶
   */
  private canAccessByDepartment(user: DataIsolationAwareEntity): boolean {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å…±äº«éƒ¨é—¨åˆ—è¡¨ä¸­
    if (this._sharedWithDepartments.length > 0) {
      const userDepartments = user.departmentIds || [];
      return this._sharedWithDepartments.some(deptId =>
        userDepartments.some(userDeptId => deptId.equals(userDeptId))
      );
    }

    // å¦‚æœæ²¡æœ‰æŒ‡å®šå…±äº«éƒ¨é—¨ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸æ‰€æœ‰è€…åœ¨åŒä¸€éƒ¨é—¨
    if (this._organizationId && user.organizationId) {
      if (!this._organizationId.equals(user.organizationId)) {
        return false;
      }

      const userDepartments = user.departmentIds || [];
      const ownerDepartments = this._departmentIds || [];
      
      return userDepartments.some(userDeptId =>
        ownerDepartments.some(ownerDeptId => userDeptId.equals(ownerDeptId))
      );
    }

    return false;
  }

  /**
   * ç»„ç»‡çº§è®¿é—®æ§åˆ¶
   */
  private canAccessByOrganization(user: DataIsolationAwareEntity): boolean {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å…±äº«ç»„ç»‡åˆ—è¡¨ä¸­
    if (this._sharedWithOrganizations.length > 0) {
      return this._sharedWithOrganizations.some(orgId =>
        user.organizationId && orgId.equals(user.organizationId)
      );
    }

    // å¦‚æœæ²¡æœ‰æŒ‡å®šå…±äº«ç»„ç»‡ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸æ‰€æœ‰è€…åœ¨åŒä¸€ç»„ç»‡
    return this._organizationId && user.organizationId &&
           this._organizationId.equals(user.organizationId);
  }

  /**
   * ç§Ÿæˆ·çº§è®¿é—®æ§åˆ¶
   */
  private canAccessByTenant(user: DataIsolationAwareEntity): boolean {
    // ç§Ÿæˆ·çº§æ•°æ®ï¼ŒåŒç§Ÿæˆ·å†…æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®
    return this._tenantId.equals(user.tenantId);
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šç”¨æˆ·
   */
  public shareWithUser(userId: Uuid): void {
    if (!this._sharedWithUsers.some(id => id.equals(userId))) {
      this._sharedWithUsers.push(userId);
    }
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šéƒ¨é—¨
   */
  public shareWithDepartment(departmentId: Uuid): void {
    if (!this._sharedWithDepartments.some(id => id.equals(departmentId))) {
      this._sharedWithDepartments.push(departmentId);
    }
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šç»„ç»‡
   */
  public shareWithOrganization(organizationId: Uuid): void {
    if (!this._sharedWithOrganizations.some(id => id.equals(organizationId))) {
      this._sharedWithOrganizations.push(organizationId);
    }
  }

  /**
   * æ’¤é”€ç”¨æˆ·è®¿é—®æƒé™
   */
  public revokeUserAccess(userId: Uuid): void {
    this._sharedWithUsers = this._sharedWithUsers.filter(id => !id.equals(userId));
  }

  /**
   * æ’¤é”€éƒ¨é—¨è®¿é—®æƒé™
   */
  public revokeDepartmentAccess(departmentId: Uuid): void {
    this._sharedWithDepartments = this._sharedWithDepartments.filter(id => !id.equals(departmentId));
  }

  /**
   * æ’¤é”€ç»„ç»‡è®¿é—®æƒé™
   */
  public revokeOrganizationAccess(organizationId: Uuid): void {
    this._sharedWithOrganizations = this._sharedWithOrganizations.filter(id => !id.equals(organizationId));
  }

  // Getters
  get dataOwnershipType(): DataOwnershipType {
    return this._dataOwnershipType;
  }

  get dataAccessScope(): DataAccessScope {
    return this._dataAccessScope;
  }

  get ownerId(): Uuid {
    return this._ownerId;
  }

  get sharedWithUsers(): Uuid[] {
    return [...this._sharedWithUsers];
  }

  get sharedWithDepartments(): Uuid[] {
    return [...this._sharedWithDepartments];
  }

  get sharedWithOrganizations(): Uuid[] {
    return [...this._sharedWithOrganizations];
  }
}
```

##### 4.14.3 ä¸šåŠ¡å®ä½“å®ç°ç¤ºä¾‹

```typescript
// ä¸ªäººæ•°æ®å®ä½“ - ç”¨æˆ·åˆ›å»ºå’Œæ‹¥æœ‰çš„æ•°æ®
export class PersonalDocument extends DataAccessControlledEntity {
  private _title: string;
  private _content: string;
  private _tags: string[] = [];
  private _createdAt: Date;
  private _updatedAt: Date;

  constructor(
    tenantId: Uuid,
    ownerId: Uuid,
    title: string,
    content: string,
    organizationId?: Uuid,
    departmentIds: Uuid[] = [],
    id?: Uuid
  ) {
    super(
      tenantId,
      DataIsolationLevel.USER,
      DataPrivacyLevel.PROTECTED,
      DataOwnershipType.PERSONAL,
      DataAccessScope.PRIVATE, // é»˜è®¤ç§æœ‰è®¿é—®
      ownerId,
      id,
      organizationId,
      departmentIds,
      ownerId
    );
    this._title = title;
    this._content = content;
    this._createdAt = new Date();
    this._updatedAt = new Date();
  }

  /**
   * å…±äº«æ–‡æ¡£ç»™æŒ‡å®šç”¨æˆ·
   */
  shareWithUser(userId: Uuid): void {
    super.shareWithUser(userId);
    this._dataAccessScope = DataAccessScope.PRIVATE; // ä¿æŒç§æœ‰ï¼Œä½†å…è®¸ç‰¹å®šç”¨æˆ·è®¿é—®
  }

  /**
   * å…±äº«æ–‡æ¡£ç»™éƒ¨é—¨
   */
  shareWithDepartment(departmentId: Uuid): void {
    super.shareWithDepartment(departmentId);
    this._dataAccessScope = DataAccessScope.DEPARTMENT;
  }

  /**
   * å…±äº«æ–‡æ¡£ç»™ç»„ç»‡
   */
  shareWithOrganization(organizationId: Uuid): void {
    super.shareWithOrganization(organizationId);
    this._dataAccessScope = DataAccessScope.ORGANIZATION;
  }

  /**
   * å‘å¸ƒä¸ºç§Ÿæˆ·çº§æ–‡æ¡£
   */
  publishToTenant(): void {
    this._dataAccessScope = DataAccessScope.TENANT;
    this._dataOwnershipType = DataOwnershipType.TENANT;
  }

  // Getters
  get title(): string {
    return this._title;
  }

  get content(): string {
    return this._content;
  }

  get tags(): string[] {
    return [...this._tags];
  }

  get createdAt(): Date {
    return this._createdAt;
  }

  get updatedAt(): Date {
    return this._updatedAt;
  }
}

// éƒ¨é—¨æ•°æ®å®ä½“ - éƒ¨é—¨å†…éƒ¨å…±äº«çš„æ•°æ®
export class DepartmentProject extends DataAccessControlledEntity {
  private _name: string;
  private _description: string;
  private _status: ProjectStatus;
  private _startDate: Date;
  private _endDate?: Date;
  private _teamMembers: Uuid[] = [];
  private _createdAt: Date;
  private _updatedAt: Date;

  constructor(
    tenantId: Uuid,
    organizationId: Uuid,
    departmentIds: Uuid[],
    ownerId: Uuid,
    name: string,
    description: string,
    id?: Uuid
  ) {
    super(
      tenantId,
      DataIsolationLevel.DEPARTMENT,
      DataPrivacyLevel.PROTECTED,
      DataOwnershipType.DEPARTMENT,
      DataAccessScope.DEPARTMENT, // éƒ¨é—¨å†…å…±äº«
      ownerId,
      id,
      organizationId,
      departmentIds,
      ownerId
    );
    this._name = name;
    this._description = description;
    this._status = ProjectStatus.PLANNING;
    this._startDate = new Date();
    this._createdAt = new Date();
    this._updatedAt = new Date();
  }

  /**
   * æ·»åŠ å›¢é˜Ÿæˆå‘˜
   */
  addTeamMember(userId: Uuid): void {
    if (!this._teamMembers.some(id => id.equals(userId))) {
      this._teamMembers.push(userId);
    }
  }

  /**
   * ç§»é™¤å›¢é˜Ÿæˆå‘˜
   */
  removeTeamMember(userId: Uuid): void {
    this._teamMembers = this._teamMembers.filter(id => !id.equals(userId));
  }

  /**
   * æ‰©å±•é¡¹ç›®åˆ°å…¶ä»–éƒ¨é—¨
   */
  extendToDepartments(departmentIds: Uuid[]): void {
    departmentIds.forEach(deptId => {
      if (!this._departmentIds.some(id => id.equals(deptId))) {
        this._departmentIds.push(deptId);
      }
    });
  }

  /**
   * æ‰©å±•é¡¹ç›®åˆ°ç»„ç»‡çº§
   */
  extendToOrganization(): void {
    this._dataAccessScope = DataAccessScope.ORGANIZATION;
    this._dataOwnershipType = DataOwnershipType.ORGANIZATION;
  }

  // Getters
  get name(): string {
    return this._name;
  }

  get description(): string {
    return this._description;
  }

  get status(): ProjectStatus {
    return this._status;
  }

  get startDate(): Date {
    return this._startDate;
  }

  get endDate(): Date | undefined {
    return this._endDate;
  }

  get teamMembers(): Uuid[] {
    return [...this._teamMembers];
  }

  get createdAt(): Date {
    return this._createdAt;
  }

  get updatedAt(): Date {
    return this._updatedAt;
  }
}

// ç»„ç»‡æ•°æ®å®ä½“ - ç»„ç»‡å†…éƒ¨å…±äº«çš„æ•°æ®
export class OrganizationPolicy extends DataAccessControlledEntity {
  private _name: string;
  private _content: string;
  private _category: PolicyCategory;
  private _version: string;
  private _effectiveDate: Date;
  private _expiryDate?: Date;
  private _approvalStatus: ApprovalStatus;
  private _approvedBy?: Uuid;
  private _approvedAt?: Date;
  private _createdAt: Date;
  private _updatedAt: Date;

  constructor(
    tenantId: Uuid,
    organizationId: Uuid,
    ownerId: Uuid,
    name: string,
    content: string,
    category: PolicyCategory,
    id?: Uuid
  ) {
    super(
      tenantId,
      DataIsolationLevel.ORGANIZATION,
      DataPrivacyLevel.PROTECTED,
      DataOwnershipType.ORGANIZATION,
      DataAccessScope.ORGANIZATION, // ç»„ç»‡å†…å…±äº«
      ownerId,
      id,
      organizationId,
      [],
      ownerId
    );
    this._name = name;
    this._content = content;
    this._category = category;
    this._version = '1.0.0';
    this._effectiveDate = new Date();
    this._approvalStatus = ApprovalStatus.DRAFT;
    this._createdAt = new Date();
    this._updatedAt = new Date();
  }

  /**
   * æäº¤å®¡æ‰¹
   */
  submitForApproval(): void {
    this._approvalStatus = ApprovalStatus.PENDING;
    this._updatedAt = new Date();
  }

  /**
   * å®¡æ‰¹é€šè¿‡
   */
  approve(approverId: Uuid): void {
    this._approvalStatus = ApprovalStatus.APPROVED;
    this._approvedBy = approverId;
    this._approvedAt = new Date();
    this._updatedAt = new Date();
  }

  /**
   * å®¡æ‰¹æ‹’ç»
   */
  reject(reason: string): void {
    this._approvalStatus = ApprovalStatus.REJECTED;
    this._updatedAt = new Date();
  }

  /**
   * å‘å¸ƒåˆ°ç§Ÿæˆ·çº§
   */
  publishToTenant(): void {
    this._dataAccessScope = DataAccessScope.TENANT;
    this._dataOwnershipType = DataOwnershipType.TENANT;
    this._updatedAt = new Date();
  }

  // Getters
  get name(): string {
    return this._name;
  }

  get content(): string {
    return this._content;
  }

  get category(): PolicyCategory {
    return this._category;
  }

  get version(): string {
    return this._version;
  }

  get effectiveDate(): Date {
    return this._effectiveDate;
  }

  get expiryDate(): Date | undefined {
    return this._expiryDate;
  }

  get approvalStatus(): ApprovalStatus {
    return this._approvalStatus;
  }

  get approvedBy(): Uuid | undefined {
    return this._approvedBy;
  }

  get approvedAt(): Date | undefined {
    return this._approvedAt;
  }

  get createdAt(): Date {
    return this._createdAt;
  }

  get updatedAt(): Date {
    return this._updatedAt;
  }
}
```

##### 4.14.4 æ•°æ®è®¿é—®æ§åˆ¶æœåŠ¡

```typescript
// æ•°æ®è®¿é—®æ§åˆ¶æœåŠ¡
@Injectable()
export class DataAccessControlService {
  constructor(
    private readonly userRepository: UserRepository,
    private readonly organizationRepository: OrganizationRepository,
    private readonly departmentRepository: DepartmentRepository,
    private readonly cacheService: CacheService
  ) {}

  /**
   * æ£€æŸ¥ç”¨æˆ·å¯¹æŒ‡å®šå®ä½“çš„è®¿é—®æƒé™
   */
  async checkDataAccess(
    userId: string,
    targetEntity: DataAccessControlledEntity
  ): Promise<boolean> {
    // 1. ä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯
    const cacheKey = `user:${userId}:access_control`;
    let user = await this.cacheService.get(cacheKey);
    
    if (!user) {
      user = await this.userRepository.findById(userId);
      if (!user) {
        return false;
      }
      // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯5åˆ†é’Ÿ
      await this.cacheService.set(cacheKey, user, 300);
    }

    // 2. åŸºç¡€æ•°æ®éš”ç¦»æ£€æŸ¥
    if (!user.canAccess(targetEntity)) {
      return false;
    }

    // 3. æ•°æ®è®¿é—®æ§åˆ¶æ£€æŸ¥
    return targetEntity.canAccess(user);
  }

  /**
   * è·å–ç”¨æˆ·å¯ä»¥è®¿é—®çš„ä¸ªäººæ•°æ®
   */
  async getAccessiblePersonalData(
    userId: string,
    ownerId?: string,
    page: number = 1,
    size: number = 20
  ): Promise<PaginatedResponse<PersonalDocument>> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      throw new UserNotFoundException(userId);
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const conditions: any = {
      tenantId: user.tenantId,
      $or: [
        { ownerId: userId }, // è‡ªå·±åˆ›å»ºçš„æ•°æ®
        { sharedWithUsers: userId }, // å…±äº«ç»™è‡ªå·±çš„æ•°æ®
      ]
    };

    // å¦‚æœæŒ‡å®šäº†æ‰€æœ‰è€…ï¼Œæ·»åŠ æ‰€æœ‰è€…æ¡ä»¶
    if (ownerId) {
      conditions.ownerId = ownerId;
    }

    // æ·»åŠ éƒ¨é—¨å’Œç»„ç»‡è®¿é—®æ¡ä»¶
    if (user.organizationId) {
      conditions.$or.push({
        sharedWithOrganizations: user.organizationId
      });
    }

    if (user.departmentIds && user.departmentIds.length > 0) {
      conditions.$or.push({
        sharedWithDepartments: { $in: user.departmentIds }
      });
    }

    return this.personalDocumentRepository.findByConditions(
      conditions,
      page,
      size
    );
  }

  /**
   * è·å–ç”¨æˆ·å¯ä»¥è®¿é—®çš„éƒ¨é—¨æ•°æ®
   */
  async getAccessibleDepartmentData(
    userId: string,
    departmentId?: string,
    page: number = 1,
    size: number = 20
  ): Promise<PaginatedResponse<DepartmentProject>> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      throw new UserNotFoundException(userId);
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const conditions: any = {
      tenantId: user.tenantId,
      $or: [
        { ownerId: userId }, // è‡ªå·±åˆ›å»ºçš„æ•°æ®
        { sharedWithUsers: userId }, // å…±äº«ç»™è‡ªå·±çš„æ•°æ®
      ]
    };

    // å¦‚æœæŒ‡å®šäº†éƒ¨é—¨ï¼Œæ·»åŠ éƒ¨é—¨æ¡ä»¶
    if (departmentId) {
      conditions.departmentIds = departmentId;
    } else {
      // å¦‚æœæ²¡æœ‰æŒ‡å®šéƒ¨é—¨ï¼ŒæŸ¥è¯¢ç”¨æˆ·æ‰€åœ¨éƒ¨é—¨çš„æ•°æ®
      if (user.departmentIds && user.departmentIds.length > 0) {
        conditions.departmentIds = { $in: user.departmentIds };
      }
    }

    // æ·»åŠ ç»„ç»‡è®¿é—®æ¡ä»¶
    if (user.organizationId) {
      conditions.$or.push({
        sharedWithOrganizations: user.organizationId
      });
    }

    return this.departmentProjectRepository.findByConditions(
      conditions,
      page,
      size
    );
  }

  /**
   * è·å–ç”¨æˆ·å¯ä»¥è®¿é—®çš„ç»„ç»‡æ•°æ®
   */
  async getAccessibleOrganizationData(
    userId: string,
    organizationId?: string,
    page: number = 1,
    size: number = 20
  ): Promise<PaginatedResponse<OrganizationPolicy>> {
    const user = await this.userRepository.findById(userId);
    if (!user) {
      throw new UserNotFoundException(userId);
    }

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const conditions: any = {
      tenantId: user.tenantId,
      $or: [
        { ownerId: userId }, // è‡ªå·±åˆ›å»ºçš„æ•°æ®
        { sharedWithUsers: userId }, // å…±äº«ç»™è‡ªå·±çš„æ•°æ®
      ]
    };

    // å¦‚æœæŒ‡å®šäº†ç»„ç»‡ï¼Œæ·»åŠ ç»„ç»‡æ¡ä»¶
    if (organizationId) {
      conditions.organizationId = organizationId;
    } else {
      // å¦‚æœæ²¡æœ‰æŒ‡å®šç»„ç»‡ï¼ŒæŸ¥è¯¢ç”¨æˆ·æ‰€åœ¨ç»„ç»‡çš„æ•°æ®
      if (user.organizationId) {
        conditions.organizationId = user.organizationId;
      }
    }

    return this.organizationPolicyRepository.findByConditions(
      conditions,
      page,
      size
    );
  }

  /**
   * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™å…±äº«æ•°æ®
   */
  async canShareData(
    userId: string,
    targetEntity: DataAccessControlledEntity
  ): Promise<boolean> {
    // 1. æ£€æŸ¥æ˜¯å¦æ˜¯æ•°æ®æ‰€æœ‰è€…
    if (targetEntity.ownerId.equals(userId)) {
      return true;
    }

    // 2. æ£€æŸ¥æ˜¯å¦æœ‰å…±äº«æƒé™
    const user = await this.userRepository.findById(userId);
    if (!user) {
      return false;
    }

    // 3. æ£€æŸ¥ç”¨æˆ·æƒé™
    return this.checkUserPermission(user, 'data', 'share', targetEntity);
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šç”¨æˆ·
   */
  async shareDataWithUser(
    userId: string,
    targetEntity: DataAccessControlledEntity,
    targetUserId: string
  ): Promise<void> {
    // æ£€æŸ¥æƒé™
    if (!(await this.canShareData(userId, targetEntity))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™å…±äº«æ­¤æ•°æ®');
    }

    // æ‰§è¡Œå…±äº«
    targetEntity.shareWithUser(new Uuid(targetUserId));
    
    // ä¿å­˜å®ä½“
    await this.saveEntity(targetEntity);
    
    // è®°å½•å®¡è®¡æ—¥å¿—
    await this.auditService.logDataSharing(
      userId,
      targetEntity.id.toString(),
      'USER',
      targetUserId
    );
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šéƒ¨é—¨
   */
  async shareDataWithDepartment(
    userId: string,
    targetEntity: DataAccessControlledEntity,
    departmentId: string
  ): Promise<void> {
    // æ£€æŸ¥æƒé™
    if (!(await this.canShareData(userId, targetEntity))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™å…±äº«æ­¤æ•°æ®');
    }

    // æ‰§è¡Œå…±äº«
    targetEntity.shareWithDepartment(new Uuid(departmentId));
    
    // ä¿å­˜å®ä½“
    await this.saveEntity(targetEntity);
    
    // è®°å½•å®¡è®¡æ—¥å¿—
    await this.auditService.logDataSharing(
      userId,
      targetEntity.id.toString(),
      'DEPARTMENT',
      departmentId
    );
  }

  /**
   * æ’¤é”€æ•°æ®è®¿é—®æƒé™
   */
  async revokeDataAccess(
    userId: string,
    targetEntity: DataAccessControlledEntity,
    targetType: 'USER' | 'DEPARTMENT' | 'ORGANIZATION',
    targetId: string
  ): Promise<void> {
    // æ£€æŸ¥æƒé™
    if (!(await this.canShareData(userId, targetEntity))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™æ’¤é”€æ­¤æ•°æ®çš„è®¿é—®æƒé™');
    }

    // æ‰§è¡Œæ’¤é”€
    switch (targetType) {
      case 'USER':
        targetEntity.revokeUserAccess(new Uuid(targetId));
        break;
      case 'DEPARTMENT':
        targetEntity.revokeDepartmentAccess(new Uuid(targetId));
        break;
      case 'ORGANIZATION':
        targetEntity.revokeOrganizationAccess(new Uuid(targetId));
        break;
    }
    
    // ä¿å­˜å®ä½“
    await this.saveEntity(targetEntity);
    
    // è®°å½•å®¡è®¡æ—¥å¿—
    await this.auditService.logDataAccessRevocation(
      userId,
      targetEntity.id.toString(),
      targetType,
      targetId
    );
  }

  /**
   * è·å–æ•°æ®è®¿é—®æƒé™åˆ—è¡¨
   */
  async getDataAccessPermissions(
    entityId: string
  ): Promise<DataAccessPermissions> {
    const entity = await this.getEntityById(entityId);
    if (!entity) {
      throw new EntityNotFoundException(entityId);
    }

    return {
      ownerId: entity.ownerId.toString(),
      dataOwnershipType: entity.dataOwnershipType,
      dataAccessScope: entity.dataAccessScope,
      sharedWithUsers: entity.sharedWithUsers.map(id => id.toString()),
      sharedWithDepartments: entity.sharedWithDepartments.map(id => id.toString()),
      sharedWithOrganizations: entity.sharedWithOrganizations.map(id => id.toString()),
    };
  }

  private async checkUserPermission(
    user: User,
    resource: string,
    action: string,
    targetEntity?: DataAccessControlledEntity
  ): Promise<boolean> {
    // å®ç°ç”¨æˆ·æƒé™æ£€æŸ¥é€»è¾‘
    // è¿™é‡Œå¯ä»¥é›†æˆç°æœ‰çš„æƒé™ç³»ç»Ÿ
    return true; // ç®€åŒ–å®ç°
  }

  private async saveEntity(entity: DataAccessControlledEntity): Promise<void> {
    // æ ¹æ®å®ä½“ç±»å‹ä¿å­˜åˆ°å¯¹åº”çš„ä»“å‚¨
    // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…å®ç°è°ƒæ•´
  }

  private async getEntityById(entityId: string): Promise<DataAccessControlledEntity | null> {
    // æ ¹æ®å®ä½“IDè·å–å®ä½“
    // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…å®ç°è°ƒæ•´
    return null;
  }
}

// æ•°æ®è®¿é—®æƒé™ä¿¡æ¯
interface DataAccessPermissions {
  ownerId: string;
  dataOwnershipType: DataOwnershipType;
  dataAccessScope: DataAccessScope;
  sharedWithUsers: string[];
  sharedWithDepartments: string[];
  sharedWithOrganizations: string[];
}

// æšä¸¾å®šä¹‰
export enum ProjectStatus {
  PLANNING = 'planning',
  IN_PROGRESS = 'in_progress',
  COMPLETED = 'completed',
  ON_HOLD = 'on_hold',
  CANCELLED = 'cancelled',
}

export enum PolicyCategory {
  HR = 'hr',
  FINANCE = 'finance',
  IT = 'it',
  SECURITY = 'security',
  COMPLIANCE = 'compliance',
  OPERATIONS = 'operations',
}

export enum ApprovalStatus {
  DRAFT = 'draft',
  PENDING = 'pending',
  APPROVED = 'approved',
  REJECTED = 'rejected',
}
```

#### æ•°æ®éš”ç¦»å®ç°ç¤ºä¾‹

```typescript
// ç”¨æˆ·å®ä½“ - æ”¯æŒè·¨å±‚çº§å­˜åœ¨
export class User extends DataIsolationAwareEntity {
  private _username: string;
  private _email: string;
  private _status: UserStatus;

  constructor(
    tenantId: Uuid,
    username: string,
    email: string,
    organizationId?: Uuid,
    departmentIds: Uuid[] = [],
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid
  ) {
    super(
      tenantId,
      DataIsolationLevel.USER,
      dataPrivacyLevel,
      id,
      organizationId,
      departmentIds,
      id // userId ä¸å®ä½“IDç›¸åŒ
    );
    this._username = username;
    this._email = email;
    this._status = UserStatus.ACTIVE;
  }

  // é™æ€å·¥å‚æ–¹æ³• - åˆ›å»ºç§Ÿæˆ·çº§ç”¨æˆ·ï¼ˆæ— ç»„ç»‡å½’å±ï¼‰
  static createTenantUser(
    tenantId: Uuid,
    username: string,
    email: string
  ): User {
    return new User(tenantId, username, email);
  }

  // é™æ€å·¥å‚æ–¹æ³• - åˆ›å»ºç»„ç»‡çº§ç”¨æˆ·
  static createOrganizationUser(
    tenantId: Uuid,
    username: string,
    email: string,
    organizationId: Uuid
  ): User {
    return new User(tenantId, username, email, organizationId);
  }

  // é™æ€å·¥å‚æ–¹æ³• - åˆ›å»ºéƒ¨é—¨çº§ç”¨æˆ·
  static createDepartmentUser(
    tenantId: Uuid,
    username: string,
    email: string,
    organizationId: Uuid,
    departmentIds: Uuid[]
  ): User {
    return new User(tenantId, username, email, organizationId, departmentIds);
  }
}

// ç»„ç»‡å®ä½“ - ç»„ç»‡çº§éš”ç¦»
export class Organization extends DataIsolationAwareEntity {
  private _name: string;
  private _code: string;
  private _status: OrganizationStatus;

  constructor(
    tenantId: Uuid,
    name: string,
    code: string,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid
  ) {
    super(
      tenantId,
      DataIsolationLevel.ORGANIZATION,
      dataPrivacyLevel,
      id,
      id // organizationId ä¸å®ä½“IDç›¸åŒ
    );
    this._name = name;
    this._code = code;
    this._status = OrganizationStatus.ACTIVE;
  }
}

// éƒ¨é—¨å®ä½“ - éƒ¨é—¨çº§éš”ç¦»
export class Department extends DataIsolationAwareEntity {
  private _name: string;
  private _code: string;
  private _parentId?: Uuid;
  private _level: number;
  private _status: DepartmentStatus;

  constructor(
    tenantId: Uuid,
    organizationId: Uuid,
    name: string,
    code: string,
    level: number = 1,
    parentId?: Uuid,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid
  ) {
    super(
      tenantId,
      DataIsolationLevel.DEPARTMENT,
      dataPrivacyLevel,
      id,
      organizationId,
      [id!] // departmentIds åŒ…å«å½“å‰éƒ¨é—¨ID
    );
    this._name = name;
    this._code = code;
    this._parentId = parentId;
    this._level = level;
    this._status = DepartmentStatus.ACTIVE;
  }
}

// ç§Ÿæˆ·é…ç½®å®ä½“ - ç§Ÿæˆ·çº§å…¬å…±æ•°æ®
export class TenantConfiguration extends DataIsolationAwareEntity {
  private _settings: Record<string, unknown> = {};

  constructor(
    tenantId: Uuid,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.SHARED,
    id?: Uuid
  ) {
    super(tenantId, DataIsolationLevel.TENANT, dataPrivacyLevel, id);
  }

  getSetting(key: string): unknown {
    return this._settings[key];
  }

  setSetting(key: string, value: unknown): void {
    this._settings[key] = value;
    this.updateTimestamp();
  }
}

// å¹³å°é…ç½®å®ä½“ - å¹³å°çº§æ•°æ®
export class PlatformConfiguration extends PlatformAwareEntity {
  private readonly _key: string;
  private _value: unknown;
  private readonly _category: string;
  private readonly _isSystem: boolean;

  constructor(
    key: string,
    value: unknown,
    category: string,
    isSystem: boolean = false,
    dataPrivacyLevel: DataPrivacyLevel = DataPrivacyLevel.PROTECTED,
    id?: Uuid
  ) {
    super(id, dataPrivacyLevel);
    this._key = key;
    this._value = value;
    this._category = category;
    this._isSystem = isSystem;
  }

  override isPlatformAdmin(): boolean {
    // å®ç°å¹³å°ç®¡ç†å‘˜æƒé™æ£€æŸ¥é€»è¾‘
    return false;
  }
}
```

## ğŸ“Š æ•°æ®æ¨¡å‹ä¸GraphQLè®¾è®¡

### æ ¸å¿ƒå®ä½“å…³ç³»

```
Platform (å¹³å°)
â”œâ”€â”€ PlatformConfiguration (å¹³å°é…ç½®) - 1:N
â”œâ”€â”€ PlatformUser (å¹³å°ç”¨æˆ·) - 1:N
â”œâ”€â”€ SystemConfiguration (ç³»ç»Ÿé…ç½®) - 1:N
â””â”€â”€ PlatformAdministrator (å¹³å°ç®¡ç†å‘˜) - 1:N

Tenant (ç§Ÿæˆ·)
â”œâ”€â”€ Organization (ç»„ç»‡) - 1:N
â”‚   â”œâ”€â”€ Department (éƒ¨é—¨) - 1:N
â”‚   â”‚   â””â”€â”€ SubDepartment (å­éƒ¨é—¨) - 1:N
â”‚   â””â”€â”€ TenantUser (ç§Ÿæˆ·ç”¨æˆ·) - M:N (è·¨å±‚çº§å­˜åœ¨)
â”œâ”€â”€ TenantUser (ç§Ÿæˆ·ç”¨æˆ·) - 1:N (ç§Ÿæˆ·çº§ç”¨æˆ·ï¼Œæ— ç»„ç»‡å½’å±)
â”œâ”€â”€ Role (è§’è‰²) - 1:N
â”œâ”€â”€ Permission (æƒé™) - 1:N
â”œâ”€â”€ TenantConfiguration (ç§Ÿæˆ·é…ç½®) - 1:N
â””â”€â”€ AuditLog (å®¡è®¡æ—¥å¿—) - 1:N

PlatformUser (å¹³å°ç”¨æˆ·)
â””â”€â”€ TenantUser (ç§Ÿæˆ·ç”¨æˆ·) - 1:1 (ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†)

æ•°æ®éš”ç¦»å…³ç³»ï¼š
Platform (å¹³å°çº§) - å¹³å°çº§æ•°æ®éš”ç¦»
â””â”€â”€ Tenant (ç§Ÿæˆ·çº§) - ç§Ÿæˆ·çº§æ•°æ®éš”ç¦»
    â”œâ”€â”€ Organization (ç»„ç»‡çº§) - ç»„ç»‡çº§æ•°æ®éš”ç¦»
    â”‚   â”œâ”€â”€ Department (éƒ¨é—¨çº§) - éƒ¨é—¨çº§æ•°æ®éš”ç¦»
    â”‚   â”‚   â””â”€â”€ SubDepartment (å­éƒ¨é—¨çº§) - å­éƒ¨é—¨çº§æ•°æ®éš”ç¦»
    â”‚   â””â”€â”€ TenantUser (ç”¨æˆ·çº§) - ç”¨æˆ·çº§æ•°æ®éš”ç¦»ï¼ˆè·¨å±‚çº§å­˜åœ¨ï¼‰
    â””â”€â”€ TenantUser (ç”¨æˆ·çº§) - ç”¨æˆ·çº§æ•°æ®éš”ç¦»ï¼ˆè·¨å±‚çº§å­˜åœ¨ï¼‰
```

### æ•°æ®éš”ç¦»å…³ç³»

```
æ•°æ®éš”ç¦»å±‚æ¬¡ç»“æ„ï¼š
Platform (å¹³å°çº§)
â”œâ”€â”€ PlatformUser (å¹³å°ç”¨æˆ·) - å¹³å°çº§æ•°æ®éš”ç¦»
â”œâ”€â”€ PlatformConfiguration (å¹³å°é…ç½®) - å¹³å°çº§æ•°æ®éš”ç¦»
â”œâ”€â”€ SystemConfiguration (ç³»ç»Ÿé…ç½®) - å¹³å°çº§æ•°æ®éš”ç¦»
â””â”€â”€ PlatformAdministrator (å¹³å°ç®¡ç†å‘˜) - å¹³å°çº§æ•°æ®éš”ç¦»

Tenant (ç§Ÿæˆ·çº§)
â”œâ”€â”€ Organization (ç»„ç»‡çº§)
â”‚   â”œâ”€â”€ Department (éƒ¨é—¨çº§)
â”‚   â”‚   â””â”€â”€ SubDepartment (å­éƒ¨é—¨çº§)
â”‚   â””â”€â”€ TenantUser (ç”¨æˆ·çº§ - è·¨å±‚çº§å­˜åœ¨)
â”œâ”€â”€ TenantUser (ç”¨æˆ·çº§ - è·¨å±‚çº§å­˜åœ¨)
â”œâ”€â”€ Role (è§’è‰²) - ç§Ÿæˆ·çº§æ•°æ®éš”ç¦»
â”œâ”€â”€ Permission (æƒé™) - ç§Ÿæˆ·çº§æ•°æ®éš”ç¦»
â”œâ”€â”€ TenantConfiguration (ç§Ÿæˆ·é…ç½®) - ç§Ÿæˆ·çº§æ•°æ®éš”ç¦»
â””â”€â”€ AuditLog (å®¡è®¡æ—¥å¿—) - ç§Ÿæˆ·çº§æ•°æ®éš”ç¦»

éšç§çº§åˆ«åˆ†ç±»ï¼š
â”œâ”€â”€ SHARED (å¯å…±äº«) - åŒçº§åˆ«å†…æ‰€æœ‰æˆå‘˜å¯è®¿é—®
â””â”€â”€ PROTECTED (å—ä¿æŠ¤) - éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½è®¿é—®

å®ä½“ç±»å‹ï¼š
â”œâ”€â”€ PlatformAwareEntity (å¹³å°æ„ŸçŸ¥å®ä½“)
â”‚   â”œâ”€â”€ PlatformUser (å¹³å°ç”¨æˆ·)
â”‚   â”œâ”€â”€ PlatformConfiguration (å¹³å°é…ç½®)
â”‚   â”œâ”€â”€ SystemConfiguration (ç³»ç»Ÿé…ç½®)
â”‚   â””â”€â”€ PlatformAdministrator (å¹³å°ç®¡ç†å‘˜)
â””â”€â”€ DataIsolationAwareEntity (æ•°æ®éš”ç¦»æ„ŸçŸ¥å®ä½“)
    â”œâ”€â”€ Tenant Level (ç§Ÿæˆ·çº§)
    â”‚   â”œâ”€â”€ Tenant (ç§Ÿæˆ·)
    â”‚   â”œâ”€â”€ Role (è§’è‰²)
    â”‚   â”œâ”€â”€ Permission (æƒé™)
    â”‚   â”œâ”€â”€ TenantConfiguration (ç§Ÿæˆ·é…ç½®)
    â”‚   â””â”€â”€ AuditLog (å®¡è®¡æ—¥å¿—)
    â”œâ”€â”€ Organization Level (ç»„ç»‡çº§)
    â”‚   â””â”€â”€ Organization (ç»„ç»‡)
    â”œâ”€â”€ Department Level (éƒ¨é—¨çº§)
    â”‚   â””â”€â”€ Department (éƒ¨é—¨)
    â”œâ”€â”€ SubDepartment Level (å­éƒ¨é—¨çº§)
    â”‚   â””â”€â”€ SubDepartment (å­éƒ¨é—¨)
    â””â”€â”€ User Level (ç”¨æˆ·çº§ - è·¨å±‚çº§)
        â””â”€â”€ TenantUser (ç§Ÿæˆ·ç”¨æˆ·)
```

### æ•°æ®åº“è®¾è®¡

#### PostgreSQL è¡¨ç»“æ„

```sql
-- ç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    domain VARCHAR(255) UNIQUE NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'ACTIVE',
    subscription_plan VARCHAR(100),
    resource_quota JSONB,
    config JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç»„ç»‡è¡¨
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100) NOT NULL,
    type VARCHAR(100),
    status VARCHAR(50) NOT NULL DEFAULT 'ACTIVE',
    description TEXT,
    manager_id UUID,
    config JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, name),
    UNIQUE(tenant_id, code)
);

-- éƒ¨é—¨è¡¨
CREATE TABLE departments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100) NOT NULL,
    type VARCHAR(100),
    status VARCHAR(50) NOT NULL DEFAULT 'ACTIVE',
    parent_id UUID REFERENCES departments(id),
    level INTEGER NOT NULL DEFAULT 1,
    path TEXT,
    manager_id UUID,
    description TEXT,
    config JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, name),
    UNIQUE(organization_id, code)
);

-- å¹³å°é…ç½®è¡¨
CREATE TABLE platform_configurations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    key VARCHAR(255) UNIQUE NOT NULL,
    value JSONB NOT NULL,
    category VARCHAR(100) NOT NULL,
    description TEXT,
    is_system BOOLEAN NOT NULL DEFAULT FALSE,
    data_privacy_level VARCHAR(20) NOT NULL DEFAULT 'PROTECTED',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¹³å°ç”¨æˆ·è¡¨
CREATE TABLE platform_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    phone VARCHAR(20),
    password_hash VARCHAR(255),
    status VARCHAR(50) NOT NULL DEFAULT 'ACTIVE',
    profile JSONB,
    mfa_config JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç§Ÿæˆ·é…ç½®è¡¨
CREATE TABLE tenant_configurations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    settings JSONB NOT NULL DEFAULT '{}',
    data_privacy_level VARCHAR(20) NOT NULL DEFAULT 'SHARED',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç§Ÿæˆ·ç”¨æˆ·è¡¨
CREATE TABLE tenant_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    platform_user_id UUID NOT NULL REFERENCES platform_users(id),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    status VARCHAR(50) NOT NULL DEFAULT 'ACTIVE',
    hire_date DATE,
    leave_date DATE,
    last_login_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(platform_user_id, tenant_id)
);

-- ç”¨æˆ·ç»„ç»‡å…³ç³»è¡¨
CREATE TABLE user_organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_user_id UUID NOT NULL REFERENCES tenant_users(id),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    department_id UUID REFERENCES departments(id),
    data_isolation_level VARCHAR(20) NOT NULL DEFAULT 'USER',
    data_privacy_level VARCHAR(20) NOT NULL DEFAULT 'PROTECTED',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_user_id, organization_id)
);

-- æ•°æ®è®¿é—®æ§åˆ¶è¡¨
CREATE TABLE data_access_control (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_id UUID NOT NULL,
    entity_type VARCHAR(100) NOT NULL,
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    organization_id UUID REFERENCES organizations(id),
    department_ids JSONB DEFAULT '[]',
    data_ownership_type VARCHAR(20) NOT NULL,
    data_access_scope VARCHAR(20) NOT NULL,
    owner_id UUID NOT NULL REFERENCES platform_users(id),
    shared_with_users JSONB DEFAULT '[]',
    shared_with_departments JSONB DEFAULT '[]',
    shared_with_organizations JSONB DEFAULT '[]',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_data_access_control_entity (entity_id, entity_type),
    INDEX idx_data_access_control_owner (owner_id),
    INDEX idx_data_access_control_tenant (tenant_id),
    INDEX idx_data_access_control_organization (organization_id)
);

-- ä¸ªäººæ–‡æ¡£è¡¨
CREATE TABLE personal_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    owner_id UUID NOT NULL REFERENCES platform_users(id),
    organization_id UUID REFERENCES organizations(id),
    department_ids JSONB DEFAULT '[]',
    title VARCHAR(255) NOT NULL,
    content TEXT,
    tags JSONB DEFAULT '[]',
    data_ownership_type VARCHAR(20) NOT NULL DEFAULT 'personal',
    data_access_scope VARCHAR(20) NOT NULL DEFAULT 'private',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_personal_documents_owner (owner_id),
    INDEX idx_personal_documents_tenant (tenant_id),
    INDEX idx_personal_documents_organization (organization_id)
);

-- éƒ¨é—¨é¡¹ç›®è¡¨
CREATE TABLE department_projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    department_ids JSONB NOT NULL DEFAULT '[]',
    owner_id UUID NOT NULL REFERENCES platform_users(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(50) NOT NULL DEFAULT 'planning',
    start_date DATE NOT NULL,
    end_date DATE,
    team_members JSONB DEFAULT '[]',
    data_ownership_type VARCHAR(20) NOT NULL DEFAULT 'department',
    data_access_scope VARCHAR(20) NOT NULL DEFAULT 'department',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_department_projects_owner (owner_id),
    INDEX idx_department_projects_tenant (tenant_id),
    INDEX idx_department_projects_organization (organization_id),
    INDEX idx_department_projects_departments USING GIN (department_ids)
);

-- ç»„ç»‡æ”¿ç­–è¡¨
CREATE TABLE organization_policies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    organization_id UUID NOT NULL REFERENCES organizations(id),
    owner_id UUID NOT NULL REFERENCES platform_users(id),
    name VARCHAR(255) NOT NULL,
    content TEXT,
    category VARCHAR(100) NOT NULL,
    version VARCHAR(50) NOT NULL DEFAULT '1.0.0',
    effective_date DATE NOT NULL,
    expiry_date DATE,
    approval_status VARCHAR(50) NOT NULL DEFAULT 'draft',
    approved_by UUID REFERENCES platform_users(id),
    approved_at TIMESTAMP,
    data_ownership_type VARCHAR(20) NOT NULL DEFAULT 'organization',
    data_access_scope VARCHAR(20) NOT NULL DEFAULT 'organization',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_organization_policies_owner (owner_id),
    INDEX idx_organization_policies_tenant (tenant_id),
    INDEX idx_organization_policies_organization (organization_id),
    INDEX idx_organization_policies_category (category),
    INDEX idx_organization_policies_status (approval_status)
);

-- æ•°æ®å…±äº«è®°å½•è¡¨
CREATE TABLE data_sharing_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_id UUID NOT NULL,
    entity_type VARCHAR(100) NOT NULL,
    shared_by UUID NOT NULL REFERENCES platform_users(id),
    shared_with_type VARCHAR(20) NOT NULL, -- 'USER', 'DEPARTMENT', 'ORGANIZATION'
    shared_with_id UUID NOT NULL,
    shared_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    revoked_at TIMESTAMP,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    INDEX idx_data_sharing_records_entity (entity_id, entity_type),
    INDEX idx_data_sharing_records_shared_by (shared_by),
    INDEX idx_data_sharing_records_shared_with (shared_with_type, shared_with_id),
    INDEX idx_data_sharing_records_active (is_active)
);

-- è§’è‰²è¡¨
CREATE TABLE roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100) NOT NULL,
    type VARCHAR(100),
    status VARCHAR(50) NOT NULL DEFAULT 'ACTIVE',
    description TEXT,
    scope VARCHAR(50) NOT NULL DEFAULT 'GLOBAL',
    parent_id UUID REFERENCES roles(id),
    is_system BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, name),
    UNIQUE(tenant_id, code)
);

-- æƒé™è¡¨
CREATE TABLE permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100) NOT NULL,
    type VARCHAR(100),
    resource VARCHAR(255) NOT NULL,
    action VARCHAR(100) NOT NULL,
    conditions JSONB,
    isolation_level VARCHAR(20) NOT NULL DEFAULT 'TENANT',
    privacy_level VARCHAR(20) NOT NULL DEFAULT 'PROTECTED',
    status VARCHAR(50) NOT NULL DEFAULT 'ACTIVE',
    description TEXT,
    is_system BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_id, code)
);

-- è§’è‰²æƒé™å…³ç³»è¡¨
CREATE TABLE role_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    role_id UUID NOT NULL REFERENCES roles(id),
    permission_id UUID NOT NULL REFERENCES permissions(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(role_id, permission_id)
);

-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨
CREATE TABLE user_roles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_user_id UUID NOT NULL REFERENCES tenant_users(id),
    role_id UUID NOT NULL REFERENCES roles(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(tenant_user_id, role_id)
);

-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id),
    user_id UUID REFERENCES platform_users(id),
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(100) NOT NULL,
    resource_id VARCHAR(255),
    details JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é¢†åŸŸäº‹ä»¶å­˜å‚¨è¡¨
CREATE TABLE domain_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_id UUID NOT NULL UNIQUE,
    aggregate_id VARCHAR(100) NOT NULL,
    aggregate_type VARCHAR(50) NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    event_data JSONB NOT NULL,
    metadata JSONB,
    version INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- è¯»æ¨¡å‹è¡¨ï¼ˆç”¨æˆ·ï¼‰
CREATE TABLE users_read_model (
    id UUID PRIMARY KEY,
    username VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    tenant_id UUID REFERENCES tenants(id),
    organization_id UUID REFERENCES organizations(id),
    department_ids JSONB DEFAULT '[]',
    isolation_level VARCHAR(20) NOT NULL DEFAULT 'USER',
    privacy_level VARCHAR(20) NOT NULL DEFAULT 'PROTECTED',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- è®¤è¯ç›¸å…³è¡¨
-- ç”¨æˆ·ä¼šè¯è¡¨
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES platform_users(id),
    tenant_id UUID REFERENCES tenants(id),
    session_id VARCHAR(255) UNIQUE NOT NULL,
    token_hash VARCHAR(255),
    device_info JSONB,
    ip_address INET,
    user_agent TEXT,
    last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¤šå› å­è®¤è¯é…ç½®è¡¨
CREATE TABLE mfa_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES platform_users(id),
    type VARCHAR(50) NOT NULL, -- 'TOTP', 'SMS', 'EMAIL'
    secret_key VARCHAR(255),
    backup_codes JSONB,
    is_enabled BOOLEAN NOT NULL DEFAULT FALSE,
    last_used TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, type)
);

-- ç™»å½•å°è¯•è®°å½•è¡¨
CREATE TABLE login_attempts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES platform_users(id),
    username VARCHAR(100),
    ip_address INET,
    user_agent TEXT,
    success BOOLEAN NOT NULL,
    failure_reason VARCHAR(255),
    attempt_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¯†ç é‡ç½®ä»¤ç‰Œè¡¨
CREATE TABLE password_reset_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES platform_users(id),
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    is_used BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é‚®ç®±éªŒè¯ä»¤ç‰Œè¡¨
CREATE TABLE email_verification_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES platform_users(id),
    email VARCHAR(255) NOT NULL,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    is_used BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### MongoDB é›†åˆè®¾è®¡

```javascript
// ç”¨æˆ·ä¼šè¯é›†åˆ
db.user_sessions.insertOne({
  _id: ObjectId(),
  userId: 'uuid',
  tenantId: 'uuid',
  sessionId: 'string',
  token: 'string',
  deviceInfo: {
    userAgent: 'string',
    ipAddress: 'string',
    location: 'string',
  },
  permissions: ['permission1', 'permission2'],
  lastActivity: new Date(),
  expiresAt: new Date(),
  createdAt: new Date(),
});

// æƒé™ç¼“å­˜é›†åˆ
db.permission_cache.insertOne({
  _id: ObjectId(),
  userId: 'uuid',
  tenantId: 'uuid',
  permissions: [
    {
      resource: 'string',
      action: 'string',
      conditions: {},
    },
  ],
  roles: ['role1', 'role2'],
  expiresAt: new Date(),
  createdAt: new Date(),
});

// äº‹ä»¶å­˜å‚¨é›†åˆ
db.domain_events.insertOne({
  _id: ObjectId(),
  eventId: 'uuid',
  aggregateId: 'uuid',
  aggregateType: 'string',
  eventType: 'string',
  eventData: {},
  metadata: {
    tenantId: 'uuid',
    userId: 'uuid',
    timestamp: new Date(),
    version: 1,
  },
  createdAt: new Date(),
});
```

## ğŸ”„ äº‹ä»¶æº¯æºä¸GraphQLæ¶æ„

### é¢†åŸŸäº‹ä»¶è®¾è®¡

```typescript
// åŸºç¡€äº‹ä»¶æ¥å£
interface DomainEvent {
  eventId: string;
  aggregateId: string;
  aggregateType: string;
  eventType: string;
  eventData: any;
  metadata: EventMetadata;
  timestamp: Date;
  version: number;
}

interface EventMetadata {
  tenantId?: string;
  userId?: string;
  organizationId?: string;
  departmentIds?: string[];
  isolationLevel?: DataIsolationLevel;
  privacyLevel?: DataPrivacyLevel;
  correlationId?: string;
  causationId?: string;
}
```

// è§’è‰²ç›¸å…³äº‹ä»¶
interface RoleCreatedEvent extends DomainEvent {
eventType: 'RoleCreated';
eventData: {
roleId: string;
name: string;
code: string;
description: string;
tenantId: string;
};
}

interface RoleNameChangedEvent extends DomainEvent {
eventType: 'RoleNameChanged';
eventData: {
roleId: string;
oldName: string;
newName: string;
};
}

interface RoleDescriptionChangedEvent extends DomainEvent {
eventType: 'RoleDescriptionChanged';
eventData: {
roleId: string;
oldDescription: string;
newDescription: string;
};
}

// æƒé™ç›¸å…³äº‹ä»¶
interface PermissionCreatedEvent extends DomainEvent {
eventType: 'PermissionCreated';
eventData: {
permissionId: string;
name: string;
code: string;
resource: string;
action: string;
tenantId: string;
};
}

interface PermissionResourceChangedEvent extends DomainEvent {
eventType: 'PermissionResourceChanged';
eventData: {
permissionId: string;
oldResource: string;
newResource: string;
};
}

interface PermissionActionChangedEvent extends DomainEvent {
eventType: 'PermissionActionChanged';
eventData: {
permissionId: string;
oldAction: string;
newAction: string;
};
}

// ä¼šè¯ç›¸å…³äº‹ä»¶
interface SessionCreatedEvent extends DomainEvent {
eventType: 'SessionCreated';
eventData: {
sessionId: string;
userId: string;
tenantId?: string;
deviceInfo: any;
ipAddress: string;
userAgent: string;
expiresAt: Date;
};
}

interface SessionRefreshedEvent extends DomainEvent {
eventType: 'SessionRefreshed';
eventData: {
sessionId: string;
userId: string;
newExpiresAt: Date;
};
}

interface SessionTerminatedEvent extends DomainEvent {
eventType: 'SessionTerminated';
eventData: {
sessionId: string;
userId: string;
reason: string;
};
}

// æƒé™ç›¸å…³äº‹ä»¶
interface PermissionGrantedEvent extends DomainEvent {
eventType: 'PermissionGranted';
eventData: {
userId: string;
permissionId: string;
grantedBy: string;
tenantId: string;
};
}

// è®¤è¯ç›¸å…³äº‹ä»¶
interface UserLoginEvent extends DomainEvent {
eventType: 'UserLogin';
eventData: {
userId: string;
tenantId?: string;
ipAddress: string;
userAgent: string;
loginMethod: 'PASSWORD' | 'MFA' | 'SSO';
};
}

interface UserLogoutEvent extends DomainEvent {
eventType: 'UserLogout';
eventData: {
userId: string;
sessionId: string;
tenantId?: string;
logoutReason: 'USER_INITIATED' | 'SESSION_EXPIRED' | 'SECURITY_POLICY';
};
}

````

### äº‹ä»¶æŠ•å½±è®¾è®¡

```typescript
// æŠ•å½±æ¥å£
interface Projection {
  handle(event: DomainEvent): Promise<void>;
}

// è§’è‰²è¯»æ¨¡å‹æŠ•å½±
@Injectable()
export class RoleReadModelProjection implements Projection {
  constructor(private readonly roleReadModel: RoleReadModel) {}

  async handle(event: DomainEvent): Promise<void> {
    if (event instanceof RoleCreatedEvent) {
      await this.roleReadModel.create({
        id: event.eventData.roleId,
        name: event.eventData.name,
        code: event.eventData.code,
        description: event.eventData.description,
        tenantId: event.eventData.tenantId,
        status: 'ACTIVE',
        createdAt: event.timestamp,
      });
    } else if (event instanceof RoleNameChangedEvent) {
      await this.roleReadModel.updateName(
        event.eventData.roleId,
        event.eventData.newName
      );
    } else if (event instanceof RoleDescriptionChangedEvent) {
      await this.roleReadModel.updateDescription(
        event.eventData.roleId,
        event.eventData.newDescription
      );
    }
  }
}

// æƒé™è¯»æ¨¡å‹æŠ•å½±
@Injectable()
export class PermissionReadModelProjection implements Projection {
  constructor(private readonly permissionReadModel: PermissionReadModel) {}

  async handle(event: DomainEvent): Promise<void> {
    if (event instanceof PermissionCreatedEvent) {
      await this.permissionReadModel.create({
        id: event.eventData.permissionId,
        name: event.eventData.name,
        code: event.eventData.code,
        resource: event.eventData.resource,
        action: event.eventData.action,
        tenantId: event.eventData.tenantId,
        status: 'ACTIVE',
        createdAt: event.timestamp,
      });
    } else if (event instanceof PermissionResourceChangedEvent) {
      await this.permissionReadModel.updateResource(
        event.eventData.permissionId,
        event.eventData.newResource
      );
    } else if (event instanceof PermissionActionChangedEvent) {
      await this.permissionReadModel.updateAction(
        event.eventData.permissionId,
        event.eventData.newAction
      );
    }
  }
}
````

// å®¡è®¡æ—¥å¿—æŠ•å½±
@Injectable()
export class AuditLogProjection implements Projection {
constructor(private readonly auditService: AuditService) {}

async handle(event: DomainEvent): Promise<void> {
await this.auditService.logEvent(event);
}
}

````

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ä¸GraphQLä¼˜åŒ–è®¾è®¡

### ç¼“å­˜ç­–ç•¥

#### Redis ç¼“å­˜è®¾è®¡

```typescript
// ç¼“å­˜é”®è®¾è®¡
const CACHE_KEYS = {
  USER_PERMISSIONS: 'user:permissions:{userId}:{tenantId}',
  USER_ROLES: 'user:roles:{userId}:{tenantId}',
  ORGANIZATION_USERS: 'org:users:{orgId}',
  DEPARTMENT_USERS: 'dept:users:{deptId}',
  PERMISSION_CACHE: 'permission:{permissionId}',
  ROLE_CACHE: 'role:{roleId}',
  TENANT_CONFIG: 'tenant:config:{tenantId}',
  USER_SESSION: 'session:{sessionId}',
};

// ç¼“å­˜é…ç½®
const CACHE_CONFIG = {
  USER_PERMISSIONS_TTL: 300, // 5åˆ†é’Ÿ
  USER_ROLES_TTL: 600, // 10åˆ†é’Ÿ
  ORGANIZATION_USERS_TTL: 1800, // 30åˆ†é’Ÿ
  PERMISSION_CACHE_TTL: 3600, // 1å°æ—¶
  ROLE_CACHE_TTL: 3600, // 1å°æ—¶
  TENANT_CONFIG_TTL: 7200, // 2å°æ—¶
  USER_SESSION_TTL: 1800, // 30åˆ†é’Ÿ
};
````

#### ç¼“å­˜æ›´æ–°ç­–ç•¥

```typescript
// ç¼“å­˜æ›´æ–°äº‹ä»¶
interface CacheInvalidationEvent {
  type: 'USER_PERMISSIONS' | 'USER_ROLES' | 'ORGANIZATION_USERS';
  userId?: string;
  tenantId?: string;
  organizationId?: string;
}

// ç¼“å­˜æœåŠ¡
@Injectable()
export class CacheService {
  constructor(
    private readonly redisService: RedisService,
    private readonly eventBus: EventBus
  ) {
    this.eventBus.subscribe(
      CacheInvalidationEvent,
      this.handleCacheInvalidation.bind(this)
    );
  }

  async invalidateUserPermissions(
    userId: string,
    tenantId: string
  ): Promise<void> {
    const key = CACHE_KEYS.USER_PERMISSIONS.replace('{userId}', userId).replace(
      '{tenantId}',
      tenantId
    );
    await this.redisService.del(key);
  }

  private async handleCacheInvalidation(
    event: CacheInvalidationEvent
  ): Promise<void> {
    switch (event.type) {
      case 'USER_PERMISSIONS':
        if (event.userId && event.tenantId) {
          await this.invalidateUserPermissions(event.userId, event.tenantId);
        }
        break;
      // å…¶ä»–ç¼“å­˜å¤±æ•ˆå¤„ç†...
    }
  }
}
```

### æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•è®¾è®¡

```sql
-- ç”¨æˆ·ç›¸å…³ç´¢å¼•
CREATE INDEX idx_platform_configurations_key ON platform_configurations(key);
CREATE INDEX idx_platform_configurations_category ON platform_configurations(category);
CREATE INDEX idx_platform_configurations_privacy_level ON platform_configurations(data_privacy_level);

CREATE INDEX idx_platform_users_email ON platform_users(email);
CREATE INDEX idx_platform_users_username ON platform_users(username);
CREATE INDEX idx_platform_users_status ON platform_users(status);

CREATE INDEX idx_tenant_configurations_tenant_id ON tenant_configurations(tenant_id);
CREATE INDEX idx_tenant_configurations_privacy_level ON tenant_configurations(data_privacy_level);

CREATE INDEX idx_tenant_users_platform_user_id ON tenant_users(platform_user_id);
CREATE INDEX idx_tenant_users_tenant_id ON tenant_users(tenant_id);
CREATE INDEX idx_tenant_users_status ON tenant_users(status);

-- ç»„ç»‡ç›¸å…³ç´¢å¼•
CREATE INDEX idx_organizations_tenant_id ON organizations(tenant_id);
CREATE INDEX idx_organizations_status ON organizations(status);
CREATE INDEX idx_organizations_tenant_name ON organizations(tenant_id, name);

-- éƒ¨é—¨ç›¸å…³ç´¢å¼•
CREATE INDEX idx_departments_organization_id ON departments(organization_id);
CREATE INDEX idx_departments_parent_id ON departments(parent_id);
CREATE INDEX idx_departments_path ON departments(path);
CREATE INDEX idx_departments_level ON departments(level);

-- ç”¨æˆ·ç»„ç»‡å…³ç³»ç´¢å¼•
CREATE INDEX idx_user_organizations_tenant_user_id ON user_organizations(tenant_user_id);
CREATE INDEX idx_user_organizations_organization_id ON user_organizations(organization_id);
CREATE INDEX idx_user_organizations_department_id ON user_organizations(department_id);
CREATE INDEX idx_user_organizations_isolation_level ON user_organizations(data_isolation_level);
CREATE INDEX idx_user_organizations_privacy_level ON user_organizations(data_privacy_level);

-- æƒé™ç›¸å…³ç´¢å¼•
CREATE INDEX idx_roles_tenant_id ON roles(tenant_id);
CREATE INDEX idx_roles_parent_id ON roles(parent_id);
CREATE INDEX idx_roles_tenant_code ON roles(tenant_id, code);

CREATE INDEX idx_permissions_tenant_id ON permissions(tenant_id);
CREATE INDEX idx_permissions_resource ON permissions(resource);
CREATE INDEX idx_permissions_tenant_code ON permissions(tenant_id, code);
CREATE INDEX idx_permissions_isolation_level ON permissions(isolation_level);
CREATE INDEX idx_permissions_privacy_level ON permissions(privacy_level);

-- å®¡è®¡æ—¥å¿—ç´¢å¼•
CREATE INDEX idx_audit_logs_tenant_id ON audit_logs(tenant_id);
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_tenant_created_at ON audit_logs(tenant_id, created_at);

-- è®¤è¯ç›¸å…³ç´¢å¼•
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_session_id ON user_sessions(session_id);
CREATE INDEX idx_user_sessions_token_hash ON user_sessions(token_hash);
CREATE INDEX idx_user_sessions_expires_at ON user_sessions(expires_at);
CREATE INDEX idx_user_sessions_is_active ON user_sessions(is_active);

CREATE INDEX idx_mfa_configs_user_id ON mfa_configs(user_id);
CREATE INDEX idx_mfa_configs_type ON mfa_configs(type);
CREATE INDEX idx_mfa_configs_user_type ON mfa_configs(user_id, type);

CREATE INDEX idx_login_attempts_user_id ON login_attempts(user_id);
CREATE INDEX idx_login_attempts_ip_address ON login_attempts(ip_address);
CREATE INDEX idx_login_attempts_attempt_time ON login_attempts(attempt_time);
CREATE INDEX idx_login_attempts_success ON login_attempts(success);

CREATE INDEX idx_password_reset_tokens_user_id ON password_reset_tokens(user_id);
CREATE INDEX idx_password_reset_tokens_token_hash ON password_reset_tokens(token_hash);
CREATE INDEX idx_password_reset_tokens_expires_at ON password_reset_tokens(expires_at);

CREATE INDEX idx_email_verification_tokens_user_id ON email_verification_tokens(user_id);
CREATE INDEX idx_email_verification_tokens_token_hash ON email_verification_tokens(token_hash);
CREATE INDEX idx_email_verification_tokens_expires_at ON email_verification_tokens(expires_at);

-- äº‹ä»¶å­˜å‚¨ç´¢å¼•
CREATE INDEX idx_domain_events_aggregate_id ON domain_events(aggregate_id);
CREATE INDEX idx_domain_events_aggregate_type ON domain_events(aggregate_type);
CREATE INDEX idx_domain_events_event_type ON domain_events(event_type);
CREATE INDEX idx_domain_events_created_at ON domain_events(created_at);
CREATE INDEX idx_domain_events_aggregate_version ON domain_events(aggregate_id, version);
CREATE INDEX idx_domain_events_event_id ON domain_events(event_id);

-- è¯»æ¨¡å‹ç´¢å¼•
CREATE INDEX idx_users_read_model_tenant_id ON users_read_model(tenant_id);
CREATE INDEX idx_users_read_model_organization_id ON users_read_model(organization_id);
CREATE INDEX idx_users_read_model_email ON users_read_model(email);
CREATE INDEX idx_users_read_model_status ON users_read_model(status);
CREATE INDEX idx_users_read_model_isolation_level ON users_read_model(isolation_level);
CREATE INDEX idx_users_read_model_privacy_level ON users_read_model(privacy_level);
CREATE INDEX idx_users_read_model_created_at ON users_read_model(created_at);
```

#### æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ç”¨æˆ·æƒé™æŸ¥è¯¢ä¼˜åŒ–
@Injectable()
export class UserPermissionService {
  constructor(
    private readonly cacheService: CacheService,
    private readonly userRepository: UserRepository,
    private readonly permissionRepository: PermissionRepository
  ) {}

  async getUserPermissions(
    userId: string,
    tenantId: string
  ): Promise<Permission[]> {
    // å…ˆä»ç¼“å­˜è·å–
    const cacheKey = CACHE_KEYS.USER_PERMISSIONS.replace(
      '{userId}',
      userId
    ).replace('{tenantId}', tenantId);
    const cached = await this.cacheService.get(cacheKey);
    if (cached) {
      return cached;
    }

    // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
    const permissions = await this.permissionRepository.findUserPermissions(
      userId,
      tenantId
    );

    // å†™å…¥ç¼“å­˜
    await this.cacheService.set(
      cacheKey,
      permissions,
      CACHE_CONFIG.USER_PERMISSIONS_TTL
    );

    return permissions;
  }

  async hasPermission(
    userId: string,
    tenantId: string,
    resource: string,
    action: string
  ): Promise<boolean> {
    const permissions = await this.getUserPermissions(userId, tenantId);
    return permissions.some(
      (p) => p.resource === resource && p.action === action
    );
  }
}
```

## ğŸ”§ éƒ¨ç½²æ¶æ„ä¸ç›‘æ§è®¾è®¡

### æŠ€æœ¯é€‰å‹

#### 5.1 åç«¯æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: NestJS (TypeScript)
- **æ•°æ®åº“**: PostgreSQL + MongoDB
- **ç¼“å­˜**: Redis
- **æœç´¢å¼•æ“**: Elasticsearch

#### 5.2 æ¶æ„æ¨¡å¼
- **Clean Architecture**: åˆ†å±‚æ¶æ„
- **DDD**: é¢†åŸŸé©±åŠ¨è®¾è®¡
- **CQRS**: å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»
- **Event Sourcing**: äº‹ä»¶æº¯æº

#### 5.3 éƒ¨ç½²æ–¹å¼
- **å®¹å™¨åŒ–**: Docker + Docker Compose
- **CI/CD**: GitHub Actions
- **ç›‘æ§**: Prometheus + Grafana
- **æ—¥å¿—**: ELK Stack

### å®¹å™¨åŒ–éƒ¨ç½²

#### Docker é…ç½®

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

# å®‰è£…pnpm
RUN npm install -g pnpm

# å¤åˆ¶packageæ–‡ä»¶
COPY package.json pnpm-lock.yaml ./

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN pnpm build

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨åº”ç”¨
CMD ["pnpm", "start:prod"]
```

#### Docker Compose é…ç½®

```yaml
version: '3.8'

services:
  saas-api:
    build: .
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@postgres:5432/saas
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    networks:
      - saas-network

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=saas
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - saas-network

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    networks:
      - saas-network



volumes:
  postgres_data:
  redis_data:

networks:
  saas-network:
    driver: bridge
```

### ç›‘æ§å’Œæ—¥å¿—

#### ç›‘æ§é…ç½®

```typescript
// ç›‘æ§æŒ‡æ ‡
interface Metrics {
  // ç”¨æˆ·ç›¸å…³æŒ‡æ ‡
  activeUsers: number;
  newUsersPerDay: number;
  userLoginRate: number;

  // æƒé™ç›¸å…³æŒ‡æ ‡
  permissionChecks: number;
  permissionCacheHitRate: number;
  permissionGrantRate: number;

  // ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
  apiResponseTime: number;
  databaseQueryTime: number;
  cacheHitRate: number;

  // é”™è¯¯æŒ‡æ ‡
  errorRate: number;
  authenticationFailures: number;
  authorizationFailures: number;
}

// ç›‘æ§æœåŠ¡
@Injectable()
export class MetricsService {
  constructor(private readonly prometheusService: PrometheusService) {}

  recordUserLogin(userId: string, tenantId: string): void {
    this.prometheusService
      .counter('user_logins_total', {
        userId,
        tenantId,
      })
      .inc();
  }

  recordPermissionCheck(
    userId: string,
    resource: string,
    action: string,
    granted: boolean
  ): void {
    this.prometheusService
      .counter('permission_checks_total', {
        userId,
        resource,
        action,
        granted: granted.toString(),
      })
      .inc();
  }

  recordApiResponseTime(method: string, path: string, duration: number): void {
    this.prometheusService
      .histogram('api_response_time_seconds', {
        method,
        path,
      })
      .observe(duration);
  }
}
```

#### æ—¥å¿—é…ç½®

```typescript
// æ—¥å¿—é…ç½®
const loggerConfig = {
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' }),
  ],
};

// ç»“æ„åŒ–æ—¥å¿—
interface LogContext {
  userId?: string;
  tenantId?: string;
  organizationId?: string;
  requestId?: string;
  action?: string;
  resource?: string;
}

// æ—¥å¿—æœåŠ¡
@Injectable()
export class LoggerService {
  private logger = winston.createLogger(loggerConfig);

  logUserAction(
    level: string,
    message: string,
    context: LogContext,
    error?: Error
  ): void {
    this.logger.log(level, message, {
      ...context,
      timestamp: new Date().toISOString(),
      error: error?.stack,
    });
  }

  logSecurityEvent(event: string, context: LogContext, details: any): void {
    this.logger.warn('Security Event', {
      event,
      ...context,
      details,
      timestamp: new Date().toISOString(),
    });
  }
}
```

## ğŸ“‹ æµ‹è¯•ç­–ç•¥ä¸æ¶æ„

### å¼€å‘è·¯çº¿å›¾

#### 6.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„ï¼ˆ2-3å‘¨ï¼‰
- æ­å»ºåŸºç¡€é¡¹ç›®ç»“æ„
- å®ç°Sharedæ¨¡å—
- è®¾è®¡æ•°æ®æ¨¡å‹
- æ­å»ºåŸºç¡€è®¾æ–½

#### 6.2 ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¨¡å—ï¼ˆ4-6å‘¨ï¼‰
- å®ç°User Managementæ¨¡å—
- å®ç°Platform Managementæ¨¡å—
- å®ç°Tenant Managementæ¨¡å—
- å®ç°IAMæ¨¡å—

#### 6.3 ç¬¬ä¸‰é˜¶æ®µï¼šæ‰©å±•æ¨¡å—ï¼ˆ3-4å‘¨ï¼‰
- å®ç°Organization Managementæ¨¡å—
- å®ç°Department Managementæ¨¡å—
- å®ç°æ¨¡å—é—´é›†æˆ
- å®Œå–„APIæ¥å£

#### 6.4 ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–å®Œå–„ï¼ˆ2-3å‘¨ï¼‰
- æ€§èƒ½ä¼˜åŒ–
- å®‰å…¨åŠ å›º
- æµ‹è¯•å®Œå–„
- æ–‡æ¡£å®Œå–„

### é£é™©è¯„ä¼°ä¸åº”å¯¹

#### 6.5 æŠ€æœ¯é£é™©
- **é£é™©**: æ¶æ„å¤æ‚åº¦å¢åŠ 
- **åº”å¯¹**: é‡‡ç”¨æˆç†Ÿçš„æŠ€æœ¯æ ˆå’Œæ¶æ„æ¨¡å¼

#### 6.6 å¼€å‘é£é™©
- **é£é™©**: å¼€å‘å‘¨æœŸå»¶é•¿
- **åº”å¯¹**: åˆ†é˜¶æ®µå¼€å‘ï¼Œä¼˜å…ˆå®ç°æ ¸å¿ƒåŠŸèƒ½

#### 6.7 é›†æˆé£é™©
- **é£é™©**: æ¨¡å—é—´é›†æˆå¤æ‚
- **åº”å¯¹**: è®¾è®¡æ¸…æ™°çš„æ¥å£å¥‘çº¦ï¼Œåšå¥½é›†æˆæµ‹è¯•

### æµ‹è¯•åˆ†å±‚

#### å•å…ƒæµ‹è¯•

```typescript
// ç”¨æˆ·å®ä½“æµ‹è¯•
describe('User Entity', () => {
  let user: User;

  beforeEach(() => {
    user = new User('user-123', 'testuser', 'test@example.com');
  });

  it('should create user with valid data', () => {
    expect(user.getId()).toBe('user-123');
    expect(user.getUsername()).toBe('testuser');
    expect(user.getEmail()).toBe('test@example.com');
  });

  it('should validate email format', () => {
    expect(() => {
      user.changeEmail('invalid-email');
    }).toThrow(InvalidEmailException);
  });

  it('should allow valid email change', () => {
    user.changeEmail('newemail@example.com');
    expect(user.getEmail()).toBe('newemail@example.com');
  });
});

// æƒé™æœåŠ¡æµ‹è¯•
describe('PermissionService', () => {
  let permissionService: PermissionService;
  let mockUserRepository: jest.Mocked<UserRepository>;
  let mockPermissionRepository: jest.Mocked<PermissionRepository>;

  beforeEach(() => {
    mockUserRepository = createMockUserRepository();
    mockPermissionRepository = createMockPermissionRepository();
    permissionService = new PermissionService(
      mockUserRepository,
      mockPermissionRepository
    );
  });

  it('should check user permission correctly', async () => {
    const userId = 'user-123';
    const resource = 'user';
    const action = 'read';

    mockPermissionRepository.findUserPermissions.mockResolvedValue([
      { resource: 'user', action: 'read' },
    ]);

    const hasPermission = await permissionService.hasPermission(
      userId,
      resource,
      action
    );
    expect(hasPermission).toBe(true);
  });
});
```

#### é›†æˆæµ‹è¯•

```typescript
// APIé›†æˆæµ‹è¯•
describe('User API Integration', () => {
  let app: INestApplication;
  let userService: UserService;

  beforeAll(async () => {
    const moduleFixture = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    userService = moduleFixture.get<UserService>(UserService);
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  it('should create user via API', async () => {
    const createUserDto = {
      username: 'testuser',
      email: 'test@example.com',
      password: 'password123',
    };

    const response = await request(app.getHttpServer())
      .post('/api/users')
      .send(createUserDto)
      .expect(201);

    expect(response.body).toHaveProperty('id');
    expect(response.body.username).toBe(createUserDto.username);
  });
});
```

#### ç«¯åˆ°ç«¯æµ‹è¯•

```typescript
// ç”¨æˆ·æ³¨å†Œæµç¨‹E2Eæµ‹è¯•
describe('User Registration E2E', () => {
  let browser: Browser;
  let page: Page;

  beforeAll(async () => {
    browser = await puppeteer.launch();
    page = await browser.newPage();
  });

  afterAll(async () => {
    await browser.close();
  });

  it('should complete user registration flow', async () => {
    // è®¿é—®æ³¨å†Œé¡µé¢
    await page.goto('http://localhost:3000/register');

    // å¡«å†™æ³¨å†Œä¿¡æ¯
    await page.type('#username', 'testuser');
    await page.type('#email', 'test@example.com');
    await page.type('#password', 'password123');
    await page.type('#confirmPassword', 'password123');

    // æäº¤æ³¨å†Œ
    await page.click('#registerButton');

    // éªŒè¯æ³¨å†ŒæˆåŠŸ
    await page.waitForSelector('.success-message');
    const successMessage = await page.$eval(
      '.success-message',
      (el) => el.textContent
    );
    expect(successMessage).toContain('æ³¨å†ŒæˆåŠŸ');
  });
});
```

## ğŸ”„ æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²ä¸æµ‹è¯•è‡ªåŠ¨åŒ–

### CI/CD æµæ°´çº¿

#### GitHub Actions é…ç½®

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install -g pnpm && pnpm install

      - name: Run linting
        run: pnpm lint

      - name: Run unit tests
        run: pnpm test:unit
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test

      - name: Run integration tests
        run: pnpm test:integration
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
          REDIS_URL: redis://localhost:6379

      - name: Run E2E tests
        run: pnpm test:e2e
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
          REDIS_URL: redis://localhost:6379

  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install -g pnpm && pnpm install

      - name: Build application
        run: pnpm build

      - name: Build Docker image
        run: docker build -t saas-api:${{ github.sha }} .

      - name: Push to registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker tag saas-api:${{ github.sha }} ${{ secrets.DOCKER_REGISTRY }}/saas-api:${{ github.sha }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/saas-api:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to production
        run: |
          # éƒ¨ç½²è„šæœ¬
          echo "Deploying to production..."
```

## ğŸ“š å¼€å‘æŒ‡å—ä¸æœ€ä½³å®è·µ

### æ€»ç»“

#### æ¶æ„è°ƒæ•´æˆæœ

æ ¹æ® `saas-platform-domain-architecture.md` çš„æ¶æ„è®¾è®¡ï¼ŒIAMæ¨¡å—è¿›è¡Œäº†é‡å¤§è°ƒæ•´ï¼š

1. **èŒè´£é‡æ–°å®šä½**: IAMæ¨¡å—ä»æ··åˆä¸šåŠ¡å®ä½“ç®¡ç†é‡æ–°å®šä½ä¸ºä¸“æ³¨äºèº«ä»½è®¤è¯ã€æˆæƒã€è§’è‰²ã€æƒé™å’Œå®¡è®¡çš„æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
2. **æ¨¡å—è¾¹ç•Œæ¸…æ™°**: ç”¨æˆ·ç®¡ç†ã€å¹³å°ç®¡ç†ã€ç§Ÿæˆ·ç®¡ç†ã€ç»„ç»‡ç®¡ç†ã€éƒ¨é—¨ç®¡ç†ä½œä¸ºç‹¬ç«‹æ¨¡å—ï¼Œå„è‡ªè´Ÿè´£è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘
3. **æœåŠ¡åŒ–å®šä½**: IAMæ¨¡å—ä½œä¸ºå…¬å…±æœåŠ¡æä¾›è€…ï¼Œä¸ºæ‰€æœ‰ç®¡ç†æ¨¡å—æä¾›ç»Ÿä¸€çš„è®¤è¯æˆæƒæœåŠ¡
4. **é«˜å†…èšä½è€¦åˆ**: æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼Œæ¨¡å—é—´ä¾èµ–å…³ç³»æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•

#### æ–°çš„IAMæ¨¡å—æ¶æ„

```
IAMæ¨¡å—æ ¸å¿ƒåŠŸèƒ½ï¼š
â”œâ”€â”€ Auth (è®¤è¯) - èº«ä»½è®¤è¯ã€å¤šå› å­è®¤è¯ã€å•ç‚¹ç™»å½•
â”œâ”€â”€ Role (è§’è‰²) - è§’è‰²å®šä¹‰ã€è§’è‰²åˆ†é…ã€è§’è‰²ç»§æ‰¿
â”œâ”€â”€ Permission (æƒé™) - æƒé™å®šä¹‰ã€æƒé™åˆ†é…ã€æƒé™éªŒè¯
â”œâ”€â”€ Session (ä¼šè¯) - ä¼šè¯ç®¡ç†ã€ä¼šè¯éªŒè¯ã€ä¼šè¯å®‰å…¨ã€ä¼šè¯è¶…æ—¶ç®¡ç†ã€å¹¶å‘ä¼šè¯æ§åˆ¶
â””â”€â”€ Audit (å®¡è®¡) - å®¡è®¡æ—¥å¿—ã€åˆè§„æ£€æŸ¥ã€å®‰å…¨ç›‘æ§
```

#### æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

1. **èŒè´£æ¸…æ™°**: æ¯ä¸ªæ¨¡å—éƒ½æœ‰æ˜ç¡®çš„ä¸šåŠ¡è¾¹ç•Œï¼Œä¸è¶Šç•Œç®¡ç†å…¶ä»–æ¨¡å—èŒè´£
2. **é«˜å†…èšä½è€¦åˆ**: æ¨¡å—å†…éƒ¨é«˜å†…èšï¼Œæ¨¡å—é—´ä½è€¦åˆï¼Œä¾¿äºå›¢é˜Ÿåä½œ
3. **å¯å¤ç”¨æ€§**: IAMæ¨¡å—ä½œä¸ºå…¬å…±æœåŠ¡ï¼Œå¯ä»¥è¢«å¤šä¸ªä¸šåŠ¡åœºæ™¯å¤ç”¨
4. **å¯æ‰©å±•æ€§**: æ¯ä¸ªæ¨¡å—å¯ä»¥ç‹¬ç«‹æ¼”è¿›å’Œæ‰©å±•ï¼Œä¸å½±å“å…¶ä»–æ¨¡å—
5. **å›¢é˜Ÿåä½œå‹å¥½**: ä¸åŒå›¢é˜Ÿå¯ä»¥ä¸“æ³¨ä¸åŒæ¨¡å—ï¼Œæé«˜å¼€å‘æ•ˆç‡

#### å®æ–½å»ºè®®

1. **ç«‹å³åœæ­¢å½“å‰å¼€å‘**: é¿å…åœ¨é”™è¯¯æ¶æ„ä¸Šç»§ç»­æŠ•å…¥
2. **é‡æ–°è®¾è®¡æ¶æ„**: åŸºäºæ–°çš„é¢†åŸŸåˆ’åˆ†é‡æ–°è®¾è®¡
3. **åˆ†é˜¶æ®µå®æ–½**: æŒ‰ç…§å¼€å‘è·¯çº¿å›¾åˆ†é˜¶æ®µå®æ–½
4. **æŒç»­ä¼˜åŒ–**: åœ¨å®æ–½è¿‡ç¨‹ä¸­æŒç»­ä¼˜åŒ–æ¶æ„è®¾è®¡

#### é¢„æœŸæ•ˆæœ

1. **æ¶æ„æ¸…æ™°**: æ¨¡å—èŒè´£æ˜ç¡®ï¼Œè¾¹ç•Œæ¸…æ™°
2. **ç»´æŠ¤ç®€å•**: æ¨¡å—é—´è€¦åˆä½ï¼Œç»´æŠ¤æˆæœ¬ä½
3. **æ‰©å±•å®¹æ˜“**: æ–°åŠŸèƒ½å¯ä»¥ç‹¬ç«‹å¼€å‘ï¼Œä¸å½±å“ç°æœ‰æ¨¡å—
4. **å›¢é˜Ÿé«˜æ•ˆ**: ä¸åŒå›¢é˜Ÿå¯ä»¥å¹¶è¡Œå¼€å‘ï¼Œæé«˜å¼€å‘æ•ˆç‡

---

**æ–‡æ¡£ç»“æŸ**

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†é‡æ–°è®¾è®¡åçš„SAASå¹³å°æŠ€æœ¯æ¶æ„ï¼Œæ•´åˆäº†é¢†åŸŸæ¶æ„è®¾è®¡çš„ä¸»è¦å†…å®¹ï¼Œä¸ºç³»ç»Ÿå¼€å‘æä¾›äº†å®Œæ•´çš„æŠ€æœ¯æŒ‡å¯¼ã€‚åœ¨æ–°çš„æ¶æ„ä¸‹ï¼Œå„æ¨¡å—èŒè´£æ¸…æ™°ï¼Œè¾¹ç•Œæ˜ç¡®ï¼Œä¾¿äºå›¢é˜Ÿåä½œå’Œç³»ç»Ÿç»´æŠ¤ã€‚åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„æŠ€æœ¯å®ç°å’Œä¸šåŠ¡è°ƒæ•´å¯¹æ–‡æ¡£è¿›è¡Œç›¸åº”çš„æ›´æ–°å’Œç»´æŠ¤ã€‚

### å‚è€ƒæ–‡æ¡£

1. **ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£**: SAASå¹³å°ä¸šåŠ¡éœ€æ±‚åˆ†ææ–‡æ¡£
2. **æ•°æ®éš”ç¦»æ–‡æ¡£**: æ•°æ®éš”ç¦»ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ–‡æ¡£ï¼ˆå·²æ•´åˆï¼‰
3. **æ•°æ®åº“è®¾è®¡æ–‡æ¡£**: æ•°æ®åº“è¡¨ç»“æ„è¯¦ç»†è®¾è®¡
4. **API æ–‡æ¡£**: REST API æ¥å£è¯¦ç»†æ–‡æ¡£
5. **éƒ¨ç½²æ–‡æ¡£**: ç³»ç»Ÿéƒ¨ç½²å’Œè¿ç»´æŒ‡å—
6. **æµ‹è¯•æ–‡æ¡£**: æµ‹è¯•ç­–ç•¥å’Œæµ‹è¯•ç”¨ä¾‹
7. **é¢†åŸŸæ¶æ„æ–‡æ¡£**: saas-platform-domain-architecture.md

## ğŸ“‹ æ€»ç»“

### æ•°æ®éš”ç¦»ä¸è®¿é—®æ§åˆ¶æ•´åˆå®Œæˆ

æœ¬æ–‡æ¡£å·²æˆåŠŸæ•´åˆäº†`data-isolation-and-access-control.md`çš„ä¸»è¦å†…å®¹ï¼Œä¸ºSAASå¹³å°æä¾›äº†å®Œæ•´çš„æ•°æ®éš”ç¦»ä¸è®¿é—®æ§åˆ¶è®¾è®¡ã€‚

#### æ•´åˆå†…å®¹åŒ…æ‹¬

1. **æ•°æ®éš”ç¦»ç­–ç•¥è¯¦è§£**
   - 6ä¸ªæ•°æ®éš”ç¦»çº§åˆ«ï¼šå¹³å°ã€ç§Ÿæˆ·ã€ç»„ç»‡ã€éƒ¨é—¨ã€å­éƒ¨é—¨ã€ç”¨æˆ·
   - 2ä¸ªéšç§çº§åˆ«ï¼šå¯å…±äº«ã€å—ä¿æŠ¤
   - è¯¦ç»†çš„ä¸šåŠ¡éœ€æ±‚åˆ†æå’Œæ•°æ®åˆ†ç±»

2. **å®ä½“åŸºç±»è®¾è®¡**
   - `PlatformAwareEntity`ï¼šå¹³å°æ„ŸçŸ¥å®ä½“åŸºç±»
   - `DataIsolationAwareEntity`ï¼šæ•°æ®éš”ç¦»æ„ŸçŸ¥å®ä½“åŸºç±»
   - å®Œæ•´çš„è®¿é—®æ§åˆ¶æ–¹æ³•å’Œæ–­è¨€æœºåˆ¶

3. **å…¬å…±æ•°æ®è®¿é—®æœºåˆ¶**
   - ç§Ÿæˆ·çº§å…¬å…±æ•°æ®è®¿é—®æ§åˆ¶
   - ç»„ç»‡çº§å…¬å…±æ•°æ®è®¿é—®æ§åˆ¶
   - çµæ´»çš„å…±äº«ç­–ç•¥è®¾è®¡

4. **å®ç°ç¤ºä¾‹ä¸æœ€ä½³å®è·µ**
   - ä»“å‚¨å±‚ã€åº”ç”¨å±‚ã€æ§åˆ¶å™¨å±‚å®ç°ç¤ºä¾‹
   - å®Œæ•´çš„æµ‹è¯•ç­–ç•¥å’Œæµ‹è¯•ç”¨ä¾‹
   - æ€§èƒ½ä¼˜åŒ–å’Œå®‰å…¨è€ƒè™‘

#### æ¶æ„ä¼˜åŠ¿

- **å®Œæ•´çš„æ•°æ®åˆ†ç±»æ”¯æŒ**ï¼šæ”¯æŒ6ä¸ªéš”ç¦»çº§åˆ«å’Œ2ä¸ªéšç§çº§åˆ«
- **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„TypeScriptç±»å‹æ”¯æŒå’Œç¼–è¯‘æ—¶æ£€æŸ¥
- **å¯æ‰©å±•æ€§**ï¼šåŸºç±»è®¾è®¡å’Œç­–ç•¥æ¨¡å¼ï¼Œæ˜“äºæ‰©å±•æ–°å®ä½“ç±»å‹
- **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰APIå…¼å®¹æ€§ï¼Œæ”¯æŒæ¸è¿›å¼è¿ç§»

#### åº”ç”¨ä»·å€¼

è¿™ç§å®Œæ•´çš„æ•°æ®éš”ç¦»ä¸è®¿é—®æ§åˆ¶æœºåˆ¶ä¸ºSAASå¹³å°æä¾›äº†ï¼š

1. **æ•°æ®å®‰å…¨ä¿éšœ**ï¼šå¤šå±‚æ¬¡çš„æ•°æ®éš”ç¦»ç¡®ä¿ç§Ÿæˆ·æ•°æ®å®‰å…¨
2. **çµæ´»å…±äº«æœºåˆ¶**ï¼šæ”¯æŒä¸åŒçº§åˆ«çš„æ•°æ®å…±äº«éœ€æ±‚
3. **å¯æ‰©å±•æ¶æ„**ï¼šæ˜“äºæ‰©å±•æ–°çš„éš”ç¦»çº§åˆ«å’Œè®¿é—®ç­–ç•¥
4. **å¼€å‘æ•ˆç‡**ï¼šç»Ÿä¸€çš„APIå’Œæ¨¡å¼æé«˜å¼€å‘æ•ˆç‡
5. **åˆè§„æ”¯æŒ**ï¼šæ»¡è¶³å„ç§æ•°æ®ä¿æŠ¤å’Œéšç§æ³•è§„è¦æ±‚

é€šè¿‡è¿™ç§å®Œæ•´çš„æ•°æ®éš”ç¦»ä¸è®¿é—®æ§åˆ¶æœºåˆ¶ï¼Œå¹³å°èƒ½å¤Ÿå®‰å…¨ã€çµæ´»åœ°å¤„ç†å„ç§å¤æ‚çš„æ•°æ®è®¿é—®åœºæ™¯ï¼Œä¸ºå¤šç§Ÿæˆ·SaaSåº”ç”¨æä¾›äº†åšå®çš„æ•°æ®å®‰å…¨åŸºç¡€ã€‚

---

**æ–‡æ¡£ç»“æŸ**

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†SAASå¹³å°çš„å®Œæ•´æŠ€æœ¯æ¶æ„ï¼ŒåŒ…æ‹¬ç³»ç»Ÿæ¶æ„è®¾è®¡ã€å®‰å…¨æ¶æ„ä¸æ•°æ®éš”ç¦»è®¾è®¡ã€éƒ¨ç½²æ¶æ„ä¸ç›‘æ§è®¾è®¡ã€æµ‹è¯•ç­–ç•¥ä¸æ¶æ„ã€æ¶æ„è®¾è®¡åŸåˆ™ä¸æœ€ä½³å®è·µã€å¼€å‘æŒ‡å—ä¸æœ€ä½³å®è·µç­‰å„ä¸ªæ–¹é¢ã€‚é€šè¿‡æ•´åˆæ•°æ®éš”ç¦»ä¸è®¿é—®æ§åˆ¶è®¾è®¡ï¼Œæ–‡æ¡£æ›´åŠ å®Œæ•´å’Œç»Ÿä¸€ï¼Œä¸ºç³»ç»Ÿå¼€å‘æä¾›äº†å…¨é¢çš„æŠ€æœ¯æŒ‡å¯¼ã€‚

### å‚è€ƒæ–‡æ¡£

1. **ä¸šåŠ¡éœ€æ±‚æ–‡æ¡£**: IAM ä¸šåŠ¡éœ€æ±‚åˆ†ææ–‡æ¡£
2. **æ•°æ®éš”ç¦»æ–‡æ¡£**: æ•°æ®éš”ç¦»ä¸è®¿é—®æ§åˆ¶è®¾è®¡æ–‡æ¡£
3. **æ•°æ®åº“è®¾è®¡æ–‡æ¡£**: æ•°æ®åº“è¡¨ç»“æ„è¯¦ç»†è®¾è®¡
4. **API æ–‡æ¡£**: REST API æ¥å£è¯¦ç»†æ–‡æ¡£
5. **éƒ¨ç½²æ–‡æ¡£**: ç³»ç»Ÿéƒ¨ç½²å’Œè¿ç»´æŒ‡å—
6. **æµ‹è¯•æ–‡æ¡£**: æµ‹è¯•ç­–ç•¥å’Œæµ‹è¯•ç”¨ä¾‹
7. **é¢†åŸŸæ¶æ„æ–‡æ¡£**: saas-platform-domain-architecture.md

### ä»£ç è§„èŒƒ

#### TypeScript é…ç½®

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "commonjs",
    "lib": ["ES2022"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "removeComments": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedIndexedAccess": true,
    "noImplicitOverride": true,
    "exactOptionalPropertyTypes": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "test"]
}
```

#### ESLint é…ç½®

```json
{
  "extends": [
    "@typescript-eslint/recommended",
    "@typescript-eslint/recommended-requiring-type-checking"
  ],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "project": "./tsconfig.json"
  },
  "plugins": ["@typescript-eslint"],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/explicit-function-return-type": "warn",
    "@typescript-eslint/no-explicit-any": "error",
    "@typescript-eslint/prefer-const": "error",
    "@typescript-eslint/no-var-requires": "error"
  }
}
```

### API è®¾è®¡è§„èŒƒ

#### RESTful API è®¾è®¡

```typescript
// ç”¨æˆ·å‘½ä»¤APIï¼ˆå†™æ“ä½œï¼‰
@Controller('api/users')
export class UserCommandController {
  constructor(
    private readonly createUserUseCase: CreateUserUseCase,
    private readonly changeUserEmailUseCase: ChangeUserEmailUseCase,
    private readonly joinTenantUseCase: JoinTenantUseCase,
    private readonly leaveTenantUseCase: LeaveTenantUseCase
  ) {}

  @Post()
  @UseGuards(AuthGuard)
  async createUser(
    @Body() createUserDto: CreateUserDto,
    @Request() req
  ): Promise<{ success: boolean; userId: string }> {
    const request = new CreateUserRequest(
      createUserDto.username,
      createUserDto.email,
      createUserDto.password,
      createUserDto.tenantId,
      req.user.id
    );
    return this.createUserUseCase.execute(request);
  }

  @Put(':id/email')
  @UseGuards(AuthGuard)
  async changeUserEmail(
    @Param('id') id: string,
    @Body() changeEmailDto: ChangeUserEmailDto,
    @Request() req
  ): Promise<{ success: boolean }> {
    const request = new ChangeUserEmailRequest(
      id,
      changeEmailDto.newEmail,
      req.user.id
    );
    return this.changeUserEmailUseCase.execute(request);
  }

  @Post(':id/join-tenant')
  @UseGuards(AuthGuard)
  async joinTenant(
    @Param('id') id: string,
    @Body() joinTenantDto: JoinTenantDto,
    @Request() req
  ): Promise<{ success: boolean }> {
    const request = new JoinTenantRequest(
      id,
      joinTenantDto.tenantId,
      req.user.id
    );
    return this.joinTenantUseCase.execute(request);
  }

  @Post(':id/leave-tenant')
  @UseGuards(AuthGuard)
  async leaveTenant(
    @Param('id') id: string,
    @Request() req
  ): Promise<{ success: boolean }> {
    const request = new LeaveTenantRequest(id, req.user.id);
    return this.leaveTenantUseCase.execute(request);
  }
}

// ç”¨æˆ·æŸ¥è¯¢APIï¼ˆè¯»æ“ä½œï¼‰
@Controller('api/users')
export class UserQueryController {
  constructor(
    private readonly getUserUseCase: GetUserUseCase,
    private readonly getUsersUseCase: GetUsersUseCase,
    private readonly getUserPermissionsUseCase: GetUserPermissionsUseCase,
    private readonly getUserEventsUseCase: GetUserEventsUseCase
  ) {}

  @Get(':id')
  @UseGuards(AuthGuard)
  async getUser(
    @Param('id') id: string,
    @Request() req
  ): Promise<UserResponseDto> {
    const request = new GetUserRequest(id, req.user.id);
    const response = await this.getUserUseCase.execute(request);
    return response.user;
  }

  @Get()
  @UseGuards(AuthGuard)
  async getUsers(
    @Query() queryDto: GetUsersQueryDto,
    @Request() req
  ): Promise<PaginatedResponse<UserResponseDto>> {
    const request = new GetUsersRequest(
      queryDto.tenantId,
      queryDto.page,
      queryDto.size,
      req.user.id
    );
    const response = await this.getUsersUseCase.execute(request);
    return response.users;
  }

  @Get(':id/permissions')
  @UseGuards(AuthGuard)
  async getUserPermissions(
    @Param('id') id: string,
    @Request() req
  ): Promise<PermissionResponseDto[]> {
    const request = new GetUserPermissionsRequest(id, req.user.id);
    const response = await this.getUserPermissionsUseCase.execute(request);
    return response.permissions;
  }

  @Get(':id/events')
  @UseGuards(AuthGuard)
  async getUserEvents(
    @Param('id') id: string,
    @Query() queryDto: GetUserEventsQueryDto,
    @Request() req
  ): Promise<PaginatedResponse<DomainEventDto>> {
    const request = new GetUserEventsRequest(
      id,
      queryDto.from,
      queryDto.to,
      queryDto.page,
      queryDto.size,
      req.user.id
    );
    const response = await this.getUserEventsUseCase.execute(request);
    return response.events;
  }
}

// GraphQL Resolvers
@Resolver('User')
export class UserResolver {
  constructor(
    private readonly getUserUseCase: GetUserUseCase,
    private readonly getUsersUseCase: GetUsersUseCase,
    private readonly getUserPermissionsUseCase: GetUserPermissionsUseCase,
    private readonly getUserOrganizationsUseCase: GetUserOrganizationsUseCase,
    private readonly getUserAuditLogsUseCase: GetUserAuditLogsUseCase,
    private readonly context: GraphQLContext
  ) {}

  @Query()
  async user(@Args('id') id: string): Promise<UserResponseDto> {
    const request = new GetUserRequest(id, this.context.currentUserId);
    const response = await this.getUserUseCase.execute(request);
    return response.user;
  }

  @Query()
  async users(
    @Args('tenantId') tenantId: string,
    @Args('page') page: number = 1,
    @Args('size') size: number = 20
  ): Promise<PaginatedResponse<UserResponseDto>> {
    const request = new GetUsersRequest(
      tenantId,
      page,
      size,
      this.context.currentUserId
    );
    const response = await this.getUsersUseCase.execute(request);
    return response.users;
  }

  @ResolveField()
  async permissions(@Parent() user: UserResponseDto): Promise<PermissionResponseDto[]> {
    const request = new GetUserPermissionsRequest(user.id, this.context.currentUserId);
    const response = await this.getUserPermissionsUseCase.execute(request);
    return response.permissions;
  }

  @ResolveField()
  async organizations(@Parent() user: UserResponseDto): Promise<OrganizationResponseDto[]> {
    const request = new GetUserOrganizationsRequest(user.id, this.context.currentUserId);
    const response = await this.getUserOrganizationsUseCase.execute(request);
    return response.organizations;
  }

  @ResolveField()
  async auditLogs(
    @Parent() user: UserResponseDto,
    @Args('limit') limit: number = 10
  ): Promise<AuditLogResponseDto[]> {
    const request = new GetUserAuditLogsRequest(user.id, limit, this.context.currentUserId);
    const response = await this.getUserAuditLogsUseCase.execute(request);
    return response.auditLogs;
  }
}

// GraphQL Schema
export const userSchema = gql`
  type User {
    id: ID!
    username: String!
    email: String!
    status: String!
    tenantId: ID
    createdAt: DateTime!
    updatedAt: DateTime!
    permissions: [Permission!]!
    organizations: [Organization!]!
    auditLogs(limit: Int = 10): [AuditLog!]!
  }

  type Permission {
    id: ID!
    name: String!
    code: String!
    resource: String!
    action: String!
  }

  type Organization {
    id: ID!
    name: String!
    code: String!
    departments: [Department!]!
  }

  type Department {
    id: ID!
    name: String!
    code: String!
    level: Int!
  }

  type AuditLog {
    id: ID!
    action: String!
    resourceType: String!
    resourceId: String!
    timestamp: DateTime!
  }

  type PaginatedUsers {
    data: [User!]!
    total: Int!
    page: Int!
    size: Int!
    totalPages: Int!
  }

  type Query {
    user(id: ID!): User
    users(tenantId: ID!, page: Int = 1, size: Int = 20): PaginatedUsers
  }

  scalar DateTime
`;

## ğŸ—ï¸ æ¶æ„è®¾è®¡åŸåˆ™ä¸æœ€ä½³å®è·µ

### æ¶æ„ä¼˜åŠ¿æ€»ç»“

#### 7.1 æ¶æ„ä¼˜åŠ¿
1. **èŒè´£æ¸…æ™°**: æ¯ä¸ªæ¨¡å—éƒ½æœ‰æ˜ç¡®çš„ä¸šåŠ¡è¾¹ç•Œ
2. **é«˜å†…èšä½è€¦åˆ**: æ¨¡å—å†…éƒ¨é«˜å†…èšï¼Œæ¨¡å—é—´ä½è€¦åˆ
3. **å¯å¤ç”¨æ€§**: åŸºç¡€æ¨¡å—å¯ä»¥è¢«å¤šä¸ªä¸šåŠ¡åœºæ™¯å¤ç”¨
4. **å¯æ‰©å±•æ€§**: æ¯ä¸ªæ¨¡å—å¯ä»¥ç‹¬ç«‹æ¼”è¿›å’Œæ‰©å±•
5. **å›¢é˜Ÿåä½œå‹å¥½**: ä¸åŒå›¢é˜Ÿå¯ä»¥ä¸“æ³¨ä¸åŒæ¨¡å—

#### 7.2 å®æ–½å»ºè®®
1. **ç«‹å³åœæ­¢å½“å‰å¼€å‘**: é¿å…åœ¨é”™è¯¯æ¶æ„ä¸Šç»§ç»­æŠ•å…¥
2. **é‡æ–°è®¾è®¡æ¶æ„**: åŸºäºæ–°çš„é¢†åŸŸåˆ’åˆ†é‡æ–°è®¾è®¡
3. **åˆ†é˜¶æ®µå®æ–½**: æŒ‰ç…§å¼€å‘è·¯çº¿å›¾åˆ†é˜¶æ®µå®æ–½
4. **æŒç»­ä¼˜åŒ–**: åœ¨å®æ–½è¿‡ç¨‹ä¸­æŒç»­ä¼˜åŒ–æ¶æ„è®¾è®¡

#### 7.3 é¢„æœŸæ•ˆæœ
1. **æ¶æ„æ¸…æ™°**: æ¨¡å—èŒè´£æ˜ç¡®ï¼Œè¾¹ç•Œæ¸…æ™°
2. **ç»´æŠ¤ç®€å•**: æ¨¡å—é—´è€¦åˆä½ï¼Œç»´æŠ¤æˆæœ¬ä½
3. **æ‰©å±•å®¹æ˜“**: æ–°åŠŸèƒ½å¯ä»¥ç‹¬ç«‹å¼€å‘ï¼Œä¸å½±å“ç°æœ‰æ¨¡å—
4. **å›¢é˜Ÿé«˜æ•ˆ**: ä¸åŒå›¢é˜Ÿå¯ä»¥å¹¶è¡Œå¼€å‘ï¼Œæé«˜å¼€å‘æ•ˆç‡

### Clean Architecture åˆ†å±‚åŸåˆ™

```
ä¾èµ–æ–¹å‘ (Dependency Direction)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Presentation Layer              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Controllers â”‚  â”‚  Resolvers  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Application Layer              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Use Cases  â”‚  â”‚  Handlers   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Data Access  â”‚  â”‚ Validators  â”‚  â”‚
â”‚  â”‚  Control    â”‚  â”‚             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Domain Layer                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Aggregates  â”‚  â”‚  Entities   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Data Isolationâ”‚ â”‚ Value Objs  â”‚  â”‚
â”‚  â”‚   Aware     â”‚  â”‚             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Infrastructure Layer            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Repositoriesâ”‚  â”‚   Services  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®åŸåˆ™**ï¼š
- å¤–å±‚åªèƒ½ä¾èµ–å†…å±‚
- å†…å±‚ä¸èƒ½ä¾èµ–å¤–å±‚
- Use Case æ˜¯ä¸šåŠ¡é€»è¾‘çš„ç»Ÿä¸€å…¥å£
- èšåˆæ ¹ç®¡ç†ä¸šåŠ¡è§„åˆ™å’Œä¸€è‡´æ€§
- å®ä½“å’Œå€¼å¯¹è±¡åˆ†ç¦»ï¼ŒèŒè´£æ¸…æ™°

### é¢†åŸŸæ¨¡å‹åˆ†å±‚è®¾è®¡

```
é¢†åŸŸæ¨¡å‹åˆ†å±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Aggregate (èšåˆæ ¹)         â”‚  â† ä¸šåŠ¡è§„åˆ™ã€ä¸€è‡´æ€§è¾¹ç•Œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Entity (å®ä½“)             â”‚  â† ä¸šåŠ¡å®ä½“ã€æ ‡è¯†
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   PlatformAwareEntity          â”‚ â”‚  â† å¹³å°æ„ŸçŸ¥å®ä½“åŸºç±»
â”‚  â”‚   DataIsolationAwareEntity     â”‚ â”‚  â† æ•°æ®éš”ç¦»æ„ŸçŸ¥å®ä½“åŸºç±»
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Value Object (å€¼å¯¹è±¡)        â”‚  â† ä¸å¯å˜å¯¹è±¡ã€ä¸šåŠ¡æ¦‚å¿µ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸šåŠ¡é€»è¾‘æµç¨‹

```
ç”¨æˆ·åˆ›å»ºæµç¨‹ï¼š
1. Controller â†’ Use Case â†’ Command â†’ Handler â†’ Aggregate â†’ Entity â†’ Event Store
2. Use Case è´Ÿè´£ä¸šåŠ¡é€»è¾‘ç¼–æ’å’ŒéªŒè¯
3. Aggregate è´Ÿè´£ä¸šåŠ¡è§„åˆ™å’Œä¸€è‡´æ€§
4. Entity è´Ÿè´£ä¸šåŠ¡å®ä½“çŠ¶æ€ç®¡ç†
5. Value Object è´Ÿè´£ä¸šåŠ¡æ¦‚å¿µå°è£…
6. DataIsolationAwareEntity è´Ÿè´£æ•°æ®éš”ç¦»å’Œè®¿é—®æ§åˆ¶

æ•°æ®è®¿é—®æ§åˆ¶æµç¨‹ï¼š
1. æƒé™æ£€æŸ¥ â†’ æ•°æ®éš”ç¦»æ£€æŸ¥ â†’ éšç§çº§åˆ«æ£€æŸ¥ â†’ è®¿é—®æˆæƒ
2. åŸºäºéš”ç¦»çº§åˆ«å’Œéšç§çº§åˆ«çš„ç»†ç²’åº¦è®¿é—®æ§åˆ¶
3. æ”¯æŒè·¨å±‚çº§çš„æ•°æ®è®¿é—®æ§åˆ¶
4. ç”¨æˆ·çº§æ•°æ®æ”¯æŒè·¨å±‚çº§å­˜åœ¨
```

##### 4.14.5 APIæ¥å£è®¾è®¡

```typescript
// æ•°æ®è®¿é—®æ§åˆ¶APIæ§åˆ¶å™¨
@Controller('api/data-access')
@UseGuards(AuthGuard)
export class DataAccessController {
  constructor(
    private readonly dataAccessControlService: DataAccessControlService,
    private readonly personalDocumentService: PersonalDocumentService,
    private readonly departmentProjectService: DepartmentProjectService,
    private readonly organizationPolicyService: OrganizationPolicyService
  ) {}

  /**
   * è·å–ç”¨æˆ·å¯ä»¥è®¿é—®çš„ä¸ªäººæ•°æ®
   */
  @Get('personal-documents')
  async getPersonalDocuments(
    @Query() queryDto: GetPersonalDocumentsQueryDto,
    @Request() req
  ): Promise<PaginatedResponse<PersonalDocumentDto>> {
    const { ownerId, page, size } = queryDto;
    return this.dataAccessControlService.getAccessiblePersonalData(
      req.user.id,
      ownerId,
      page,
      size
    );
  }

  /**
   * è·å–ç”¨æˆ·å¯ä»¥è®¿é—®çš„éƒ¨é—¨æ•°æ®
   */
  @Get('department-projects')
  async getDepartmentProjects(
    @Query() queryDto: GetDepartmentProjectsQueryDto,
    @Request() req
  ): Promise<PaginatedResponse<DepartmentProjectDto>> {
    const { departmentId, page, size } = queryDto;
    return this.dataAccessControlService.getAccessibleDepartmentData(
      req.user.id,
      departmentId,
      page,
      size
    );
  }

  /**
   * è·å–ç”¨æˆ·å¯ä»¥è®¿é—®çš„ç»„ç»‡æ•°æ®
   */
  @Get('organization-policies')
  async getOrganizationPolicies(
    @Query() queryDto: GetOrganizationPoliciesQueryDto,
    @Request() req
  ): Promise<PaginatedResponse<OrganizationPolicyDto>> {
    const { organizationId, page, size } = queryDto;
    return this.dataAccessControlService.getAccessibleOrganizationData(
      req.user.id,
      organizationId,
      page,
      size
    );
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šç”¨æˆ·
   */
  @Post('share/user')
  async shareWithUser(
    @Body() shareDto: ShareWithUserDto,
    @Request() req
  ): Promise<{ success: boolean }> {
    const { entityId, entityType, targetUserId } = shareDto;
    const entity = await this.getEntityById(entityId, entityType);
    
    await this.dataAccessControlService.shareDataWithUser(
      req.user.id,
      entity,
      targetUserId
    );

    return { success: true };
  }

  /**
   * å…±äº«æ•°æ®ç»™æŒ‡å®šéƒ¨é—¨
   */
  @Post('share/department')
  async shareWithDepartment(
    @Body() shareDto: ShareWithDepartmentDto,
    @Request() req
  ): Promise<{ success: boolean }> {
    const { entityId, entityType, departmentId } = shareDto;
    const entity = await this.getEntityById(entityId, entityType);
    
    await this.dataAccessControlService.shareDataWithDepartment(
      req.user.id,
      entity,
      departmentId
    );

    return { success: true };
  }

  /**
   * æ’¤é”€æ•°æ®è®¿é—®æƒé™
   */
  @Delete('revoke')
  async revokeAccess(
    @Body() revokeDto: RevokeAccessDto,
    @Request() req
  ): Promise<{ success: boolean }> {
    const { entityId, entityType, targetType, targetId } = revokeDto;
    const entity = await this.getEntityById(entityId, entityType);
    
    await this.dataAccessControlService.revokeDataAccess(
      req.user.id,
      entity,
      targetType,
      targetId
    );

    return { success: true };
  }

  /**
   * è·å–æ•°æ®è®¿é—®æƒé™ä¿¡æ¯
   */
  @Get(':entityId/permissions')
  async getDataAccessPermissions(
    @Param('entityId') entityId: string,
    @Query('entityType') entityType: string
  ): Promise<DataAccessPermissionsDto> {
    return this.dataAccessControlService.getDataAccessPermissions(entityId);
  }

  private async getEntityById(
    entityId: string,
    entityType: string
  ): Promise<DataAccessControlledEntity> {
    switch (entityType) {
      case 'PersonalDocument':
        return this.personalDocumentService.findById(entityId);
      case 'DepartmentProject':
        return this.departmentProjectService.findById(entityId);
      case 'OrganizationPolicy':
        return this.organizationPolicyService.findById(entityId);
      default:
        throw new BadRequestException(`Unsupported entity type: ${entityType}`);
    }
  }
}

// ä¸ªäººæ–‡æ¡£APIæ§åˆ¶å™¨
@Controller('api/personal-documents')
@UseGuards(AuthGuard)
export class PersonalDocumentController {
  constructor(
    private readonly personalDocumentService: PersonalDocumentService,
    private readonly dataAccessControlService: DataAccessControlService
  ) {}

  /**
   * åˆ›å»ºä¸ªäººæ–‡æ¡£
   */
  @Post()
  async createPersonalDocument(
    @Body() createDto: CreatePersonalDocumentDto,
    @Request() req
  ): Promise<PersonalDocumentDto> {
    const document = await this.personalDocumentService.create(
      req.user.tenantId,
      req.user.id,
      createDto.title,
      createDto.content,
      req.user.organizationId,
      req.user.departmentIds,
      createDto.tags
    );

    return this.personalDocumentService.toDto(document);
  }

  /**
   * æ›´æ–°ä¸ªäººæ–‡æ¡£
   */
  @Put(':id')
  async updatePersonalDocument(
    @Param('id') id: string,
    @Body() updateDto: UpdatePersonalDocumentDto,
    @Request() req
  ): Promise<PersonalDocumentDto> {
    // æ£€æŸ¥è®¿é—®æƒé™
    const document = await this.personalDocumentService.findById(id);
    if (!(await this.dataAccessControlService.checkDataAccess(req.user.id, document))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™è®¿é—®æ­¤æ–‡æ¡£');
    }

    const updatedDocument = await this.personalDocumentService.update(
      id,
      updateDto.title,
      updateDto.content,
      updateDto.tags
    );

    return this.personalDocumentService.toDto(updatedDocument);
  }

  /**
   * åˆ é™¤ä¸ªäººæ–‡æ¡£
   */
  @Delete(':id')
  async deletePersonalDocument(
    @Param('id') id: string,
    @Request() req
  ): Promise<{ success: boolean }> {
    // æ£€æŸ¥è®¿é—®æƒé™
    const document = await this.personalDocumentService.findById(id);
    if (!(await this.dataAccessControlService.checkDataAccess(req.user.id, document))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™è®¿é—®æ­¤æ–‡æ¡£');
    }

    await this.personalDocumentService.delete(id);
    return { success: true };
  }
}

// éƒ¨é—¨é¡¹ç›®APIæ§åˆ¶å™¨
@Controller('api/department-projects')
@UseGuards(AuthGuard)
export class DepartmentProjectController {
  constructor(
    private readonly departmentProjectService: DepartmentProjectService,
    private readonly dataAccessControlService: DataAccessControlService
  ) {}

  /**
   * åˆ›å»ºéƒ¨é—¨é¡¹ç›®
   */
  @Post()
  async createDepartmentProject(
    @Body() createDto: CreateDepartmentProjectDto,
    @Request() req
  ): Promise<DepartmentProjectDto> {
    const project = await this.departmentProjectService.create(
      req.user.tenantId,
      req.user.organizationId,
      req.user.departmentIds,
      req.user.id,
      createDto.name,
      createDto.description
    );

    return this.departmentProjectService.toDto(project);
  }

  /**
   * æ›´æ–°éƒ¨é—¨é¡¹ç›®
   */
  @Put(':id')
  async updateDepartmentProject(
    @Param('id') id: string,
    @Body() updateDto: UpdateDepartmentProjectDto,
    @Request() req
  ): Promise<DepartmentProjectDto> {
    // æ£€æŸ¥è®¿é—®æƒé™
    const project = await this.departmentProjectService.findById(id);
    if (!(await this.dataAccessControlService.checkDataAccess(req.user.id, project))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡¹ç›®');
    }

    const updatedProject = await this.departmentProjectService.update(
      id,
      updateDto.name,
      updateDto.description,
      updateDto.status,
      updateDto.endDate
    );

    return this.departmentProjectService.toDto(updatedProject);
  }

  /**
   * æ·»åŠ é¡¹ç›®å›¢é˜Ÿæˆå‘˜
   */
  @Post(':id/team-members')
  async addTeamMember(
    @Param('id') id: string,
    @Body() addMemberDto: AddTeamMemberDto,
    @Request() req
  ): Promise<{ success: boolean }> {
    // æ£€æŸ¥è®¿é—®æƒé™
    const project = await this.departmentProjectService.findById(id);
    if (!(await this.dataAccessControlService.checkDataAccess(req.user.id, project))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡¹ç›®');
    }

    await this.departmentProjectService.addTeamMember(id, addMemberDto.userId);
    return { success: true };
  }

  /**
   * æ‰©å±•é¡¹ç›®åˆ°å…¶ä»–éƒ¨é—¨
   */
  @Post(':id/extend-departments')
  async extendToDepartments(
    @Param('id') id: string,
    @Body() extendDto: ExtendToDepartmentsDto,
    @Request() req
  ): Promise<{ success: boolean }> {
    // æ£€æŸ¥è®¿é—®æƒé™
    const project = await this.departmentProjectService.findById(id);
    if (!(await this.dataAccessControlService.checkDataAccess(req.user.id, project))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡¹ç›®');
    }

    await this.departmentProjectService.extendToDepartments(id, extendDto.departmentIds);
    return { success: true };
  }
}

// ç»„ç»‡æ”¿ç­–APIæ§åˆ¶å™¨
@Controller('api/organization-policies')
@UseGuards(AuthGuard)
export class OrganizationPolicyController {
  constructor(
    private readonly organizationPolicyService: OrganizationPolicyService,
    private readonly dataAccessControlService: DataAccessControlService
  ) {}

  /**
   * åˆ›å»ºç»„ç»‡æ”¿ç­–
   */
  @Post()
  async createOrganizationPolicy(
    @Body() createDto: CreateOrganizationPolicyDto,
    @Request() req
  ): Promise<OrganizationPolicyDto> {
    const policy = await this.organizationPolicyService.create(
      req.user.tenantId,
      req.user.organizationId,
      req.user.id,
      createDto.name,
      createDto.content,
      createDto.category
    );

    return this.organizationPolicyService.toDto(policy);
  }

  /**
   * æäº¤æ”¿ç­–å®¡æ‰¹
   */
  @Post(':id/submit-approval')
  async submitForApproval(
    @Param('id') id: string,
    @Request() req
  ): Promise<{ success: boolean }> {
    // æ£€æŸ¥è®¿é—®æƒé™
    const policy = await this.organizationPolicyService.findById(id);
    if (!(await this.dataAccessControlService.checkDataAccess(req.user.id, policy))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™è®¿é—®æ­¤æ”¿ç­–');
    }

    await this.organizationPolicyService.submitForApproval(id);
    return { success: true };
  }

  /**
   * å®¡æ‰¹æ”¿ç­–
   */
  @Post(':id/approve')
  async approvePolicy(
    @Param('id') id: string,
    @Request() req
  ): Promise<{ success: boolean }> {
    // æ£€æŸ¥è®¿é—®æƒé™
    const policy = await this.organizationPolicyService.findById(id);
    if (!(await this.dataAccessControlService.checkDataAccess(req.user.id, policy))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™è®¿é—®æ­¤æ”¿ç­–');
    }

    await this.organizationPolicyService.approve(id, req.user.id);
    return { success: true };
  }

  /**
   * å‘å¸ƒæ”¿ç­–åˆ°ç§Ÿæˆ·çº§
   */
  @Post(':id/publish-tenant')
  async publishToTenant(
    @Param('id') id: string,
    @Request() req
  ): Promise<{ success: boolean }> {
    // æ£€æŸ¥è®¿é—®æƒé™
    const policy = await this.organizationPolicyService.findById(id);
    if (!(await this.dataAccessControlService.checkDataAccess(req.user.id, policy))) {
      throw new AccessDeniedException('æ²¡æœ‰æƒé™è®¿é—®æ­¤æ”¿ç­–');
    }

    await this.organizationPolicyService.publishToTenant(id);
    return { success: true };
  }
}
```

##### 4.14.6 DTOå®šä¹‰

##### 4.14.7 æµ‹è¯•ç­–ç•¥

```typescript
// æ•°æ®è®¿é—®æ§åˆ¶æœåŠ¡æµ‹è¯•
describe('DataAccessControlService', () => {
  let service: DataAccessControlService;
  let mockUserRepository: jest.Mocked<UserRepository>;
  let mockCacheService: jest.Mocked<CacheService>;

  beforeEach(() => {
    mockUserRepository = createMockUserRepository();
    mockCacheService = createMockCacheService();
    service = new DataAccessControlService(
      mockUserRepository,
      mockOrganizationRepository,
      mockDepartmentRepository,
      mockCacheService
    );
  });

  describe('checkDataAccess', () => {
    it('should allow access for data owner', async () => {
      const userId = 'user-123';
      const ownerId = 'user-123';
      const targetEntity = createMockPersonalDocument(ownerId);

      const result = await service.checkDataAccess(userId, targetEntity);
      expect(result).toBe(true);
    });

    it('should allow access for shared user', async () => {
      const userId = 'user-456';
      const ownerId = 'user-123';
      const targetEntity = createMockPersonalDocument(ownerId);
      targetEntity.shareWithUser(new Uuid(userId));

      const result = await service.checkDataAccess(userId, targetEntity);
      expect(result).toBe(true);
    });

    it('should allow access for department member', async () => {
      const userId = 'user-456';
      const ownerId = 'user-123';
      const departmentId = 'dept-789';
      const targetEntity = createMockDepartmentProject(ownerId, departmentId);
      const user = createMockUser(userId, departmentId);

      mockUserRepository.findById.mockResolvedValue(user);

      const result = await service.checkDataAccess(userId, targetEntity);
      expect(result).toBe(true);
    });

    it('should deny access for unauthorized user', async () => {
      const userId = 'user-456';
      const ownerId = 'user-123';
      const targetEntity = createMockPersonalDocument(ownerId);

      const result = await service.checkDataAccess(userId, targetEntity);
      expect(result).toBe(false);
    });
  });

  describe('getAccessiblePersonalData', () => {
    it('should return user own documents', async () => {
      const userId = 'user-123';
      const user = createMockUser(userId);
      mockUserRepository.findById.mockResolvedValue(user);

      const result = await service.getAccessiblePersonalData(userId);
      expect(result.data).toHaveLength(1);
      expect(result.data[0].ownerId).toBe(userId);
    });

    it('should return shared documents', async () => {
      const userId = 'user-456';
      const user = createMockUser(userId);
      mockUserRepository.findById.mockResolvedValue(user);

      const result = await service.getAccessiblePersonalData(userId);
      expect(result.data).toHaveLength(1);
      expect(result.data[0].sharedWithUsers).toContain(userId);
    });
  });

  describe('shareDataWithUser', () => {
    it('should share data with user successfully', async () => {
      const userId = 'user-123';
      const targetUserId = 'user-456';
      const targetEntity = createMockPersonalDocument(userId);

      await service.shareDataWithUser(userId, targetEntity, targetUserId);

      expect(targetEntity.sharedWithUsers).toContainEqual(new Uuid(targetUserId));
    });

    it('should throw error when user has no permission to share', async () => {
      const userId = 'user-123';
      const targetUserId = 'user-456';
      const targetEntity = createMockPersonalDocument('user-789'); // Different owner

      await expect(
        service.shareDataWithUser(userId, targetEntity, targetUserId)
      ).rejects.toThrow(AccessDeniedException);
    });
  });
});

// ä¸ªäººæ–‡æ¡£å®ä½“æµ‹è¯•
describe('PersonalDocument', () => {
  let document: PersonalDocument;
  const ownerId = new Uuid('user-123');
  const tenantId = new Uuid('tenant-456');

  beforeEach(() => {
    document = new PersonalDocument(
      tenantId,
      ownerId,
      'Test Document',
      'Test Content'
    );
  });

  it('should create document with private access scope', () => {
    expect(document.dataAccessScope).toBe(DataAccessScope.PRIVATE);
    expect(document.dataOwnershipType).toBe(DataOwnershipType.PERSONAL);
  });

  it('should allow owner access', () => {
    const owner = createMockUser(ownerId.toString());
    expect(document.canAccess(owner)).toBe(true);
  });

  it('should deny non-owner access by default', () => {
    const nonOwner = createMockUser('user-789');
    expect(document.canAccess(nonOwner)).toBe(false);
  });

  it('should allow shared user access', () => {
    const sharedUserId = new Uuid('user-789');
    document.shareWithUser(sharedUserId);
    
    const sharedUser = createMockUser(sharedUserId.toString());
    expect(document.canAccess(sharedUser)).toBe(true);
  });

  it('should allow department access after sharing', () => {
    const departmentId = new Uuid('dept-789');
    document.shareWithDepartment(departmentId);
    
    const departmentMember = createMockUser('user-789', undefined, [departmentId]);
    expect(document.canAccess(departmentMember)).toBe(true);
  });

  it('should allow organization access after sharing', () => {
    const organizationId = new Uuid('org-789');
    document.shareWithOrganization(organizationId);
    
    const orgMember = createMockUser('user-789', organizationId);
    expect(document.canAccess(orgMember)).toBe(true);
  });

  it('should change access scope when publishing to tenant', () => {
    document.publishToTenant();
    
    expect(document.dataAccessScope).toBe(DataAccessScope.TENANT);
    expect(document.dataOwnershipType).toBe(DataOwnershipType.TENANT);
  });
});

// éƒ¨é—¨é¡¹ç›®å®ä½“æµ‹è¯•
describe('DepartmentProject', () => {
  let project: DepartmentProject;
  const ownerId = new Uuid('user-123');
  const tenantId = new Uuid('tenant-456');
  const organizationId = new Uuid('org-789');
  const departmentIds = [new Uuid('dept-123')];

  beforeEach(() => {
    project = new DepartmentProject(
      tenantId,
      organizationId,
      departmentIds,
      ownerId,
      'Test Project',
      'Test Description'
    );
  });

  it('should create project with department access scope', () => {
    expect(project.dataAccessScope).toBe(DataAccessScope.DEPARTMENT);
    expect(project.dataOwnershipType).toBe(DataOwnershipType.DEPARTMENT);
  });

  it('should allow department member access', () => {
    const departmentMember = createMockUser('user-456', organizationId, departmentIds);
    expect(project.canAccess(departmentMember)).toBe(true);
  });

  it('should deny non-department member access', () => {
    const nonMember = createMockUser('user-789', organizationId, [new Uuid('dept-456')]);
    expect(project.canAccess(nonMember)).toBe(false);
  });

  it('should add team member successfully', () => {
    const newMemberId = new Uuid('user-789');
    project.addTeamMember(newMemberId);
    
    expect(project.teamMembers).toContainEqual(newMemberId);
  });

  it('should extend to additional departments', () => {
    const newDepartmentIds = [new Uuid('dept-456'), new Uuid('dept-789')];
    project.extendToDepartments(newDepartmentIds);
    
    expect(project.departmentIds).toContainEqual(newDepartmentIds[0]);
    expect(project.departmentIds).toContainEqual(newDepartmentIds[1]);
  });

  it('should change to organization scope when extending', () => {
    project.extendToOrganization();
    
    expect(project.dataAccessScope).toBe(DataAccessScope.ORGANIZATION);
    expect(project.dataOwnershipType).toBe(DataOwnershipType.ORGANIZATION);
  });
});

// ç»„ç»‡æ”¿ç­–å®ä½“æµ‹è¯•
describe('OrganizationPolicy', () => {
  let policy: OrganizationPolicy;
  const ownerId = new Uuid('user-123');
  const tenantId = new Uuid('tenant-456');
  const organizationId = new Uuid('org-789');

  beforeEach(() => {
    policy = new OrganizationPolicy(
      tenantId,
      organizationId,
      ownerId,
      'Test Policy',
      'Test Content',
      PolicyCategory.HR
    );
  });

  it('should create policy with organization access scope', () => {
    expect(policy.dataAccessScope).toBe(DataAccessScope.ORGANIZATION);
    expect(policy.dataOwnershipType).toBe(DataOwnershipType.ORGANIZATION);
  });

  it('should allow organization member access', () => {
    const orgMember = createMockUser('user-456', organizationId);
    expect(policy.canAccess(orgMember)).toBe(true);
  });

  it('should deny non-organization member access', () => {
    const nonMember = createMockUser('user-789', new Uuid('org-456'));
    expect(policy.canAccess(nonMember)).toBe(false);
  });

  it('should change status when submitting for approval', () => {
    policy.submitForApproval();
    
    expect(policy.approvalStatus).toBe(ApprovalStatus.PENDING);
  });

  it('should change status when approved', () => {
    const approverId = new Uuid('user-456');
    policy.approve(approverId);
    
    expect(policy.approvalStatus).toBe(ApprovalStatus.APPROVED);
    expect(policy.approvedBy).toEqual(approverId);
    expect(policy.approvedAt).toBeDefined();
  });

  it('should change status when rejected', () => {
    policy.reject('Invalid content');
    
    expect(policy.approvalStatus).toBe(ApprovalStatus.REJECTED);
  });

  it('should change to tenant scope when publishing', () => {
    policy.publishToTenant();
    
    expect(policy.dataAccessScope).toBe(DataAccessScope.TENANT);
    expect(policy.dataOwnershipType).toBe(DataOwnershipType.TENANT);
  });
});

// è¾…åŠ©å‡½æ•°
function createMockUser(
  id: string,
  organizationId?: Uuid,
  departmentIds: Uuid[] = []
): DataIsolationAwareEntity {
  return {
    id: new Uuid(id),
    tenantId: new Uuid('tenant-123'),
    organizationId,
    departmentIds,
    canAccess: jest.fn().mockReturnValue(true),
  } as any;
}

function createMockPersonalDocument(ownerId: string): PersonalDocument {
  return new PersonalDocument(
    new Uuid('tenant-123'),
    new Uuid(ownerId),
    'Test Document',
    'Test Content'
  );
}

function createMockDepartmentProject(
  ownerId: string,
  departmentId: string
): DepartmentProject {
  return new DepartmentProject(
    new Uuid('tenant-123'),
    new Uuid('org-123'),
    [new Uuid(departmentId)],
    new Uuid(ownerId),
    'Test Project',
    'Test Description'
  );
}

function createMockUserRepository(): jest.Mocked<UserRepository> {
  return {
    findById: jest.fn(),
  } as any;
}

function createMockCacheService(): jest.Mocked<CacheService> {
  return {
    get: jest.fn(),
    set: jest.fn(),
  } as any;
}
```

##### 4.14.8 æœ€ä½³å®è·µæ€»ç»“

#### æ•°æ®è®¿é—®æ§åˆ¶è®¾è®¡åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**: ç”¨æˆ·é»˜è®¤åªèƒ½è®¿é—®è‡ªå·±åˆ›å»ºçš„æ•°æ®
2. **æ˜¾å¼æˆæƒåŸåˆ™**: æ•°æ®å…±äº«éœ€è¦æ˜ç¡®çš„æˆæƒæ“ä½œ
3. **æƒé™ç»§æ‰¿åŸåˆ™**: é«˜çº§åˆ«æƒé™åŒ…å«ä½çº§åˆ«æƒé™
4. **å®¡è®¡è¿½è¸ªåŸåˆ™**: æ‰€æœ‰æƒé™å˜æ›´éƒ½è¦è®°å½•å®¡è®¡æ—¥å¿—

#### å®ç°è¦ç‚¹

1. **å®ä½“è®¾è®¡**: æ‰€æœ‰ä¸šåŠ¡å®ä½“éƒ½ç»§æ‰¿è‡ª `DataAccessControlledEntity`
2. **æƒé™æ£€æŸ¥**: åœ¨APIå±‚ç»Ÿä¸€è¿›è¡Œæƒé™æ£€æŸ¥
3. **ç¼“å­˜ç­–ç•¥**: ç”¨æˆ·æƒé™ä¿¡æ¯ç¼“å­˜5åˆ†é’Ÿï¼Œæé«˜æ€§èƒ½
4. **äº‹åŠ¡å¤„ç†**: æƒé™å˜æ›´å’Œæ•°æ®æ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­å¤„ç†

#### æ‰©å±•æ€§è€ƒè™‘

1. **æ–°å®ä½“ç±»å‹**: åªéœ€ç»§æ‰¿ `DataAccessControlledEntity` å³å¯
2. **æ–°æƒé™æ¨¡å‹**: å¯ä»¥åœ¨åŸºç±»ä¸­æ·»åŠ æ–°çš„æƒé™æ£€æŸ¥æ–¹æ³•
3. **æ–°å…±äº«ç­–ç•¥**: æ”¯æŒè‡ªå®šä¹‰çš„å…±äº«è§„åˆ™å’Œæ¡ä»¶

#### æ€§èƒ½ä¼˜åŒ–

1. **ç´¢å¼•è®¾è®¡**: ä¸ºæƒé™ç›¸å…³å­—æ®µåˆ›å»ºå¤åˆç´¢å¼•
2. **æŸ¥è¯¢ä¼˜åŒ–**: ä½¿ç”¨æ¡ä»¶æŸ¥è¯¢å‡å°‘æ•°æ®ä¼ è¾“
3. **ç¼“å­˜ç­–ç•¥**: åˆç†ä½¿ç”¨Redisç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢

#### å®‰å…¨è€ƒè™‘

1. **æƒé™éªŒè¯**: æ¯æ¬¡æ•°æ®è®¿é—®éƒ½è¦éªŒè¯æƒé™
2. **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰æƒé™å˜æ›´å’Œè®¿é—®æ“ä½œ
3. **æ•°æ®éš”ç¦»**: ç¡®ä¿ä¸åŒç§Ÿæˆ·é—´æ•°æ®å®Œå…¨éš”ç¦»

```typescript
// æŸ¥è¯¢DTO
export class GetPersonalDocumentsQueryDto {
  @IsOptional()
  @IsUUID()
  ownerId?: string;

  @IsOptional()
  @IsNumber()
  @Min(1)
  page?: number = 1;

  @IsOptional()
  @IsNumber()
  @Min(1)
  @Max(100)
  size?: number = 20;
}

export class GetDepartmentProjectsQueryDto {
  @IsOptional()
  @IsUUID()
  departmentId?: string;

  @IsOptional()
  @IsNumber()
  @Min(1)
  page?: number = 1;

  @IsOptional()
  @IsNumber()
  @Min(1)
  @Max(100)
  size?: number = 20;
}

export class GetOrganizationPoliciesQueryDto {
  @IsOptional()
  @IsUUID()
  organizationId?: string;

  @IsOptional()
  @IsNumber()
  @Min(1)
  page?: number = 1;

  @IsOptional()
  @IsNumber()
  @Min(1)
  @Max(100)
  size?: number = 20;
}

// å…±äº«DTO
export class ShareWithUserDto {
  @IsUUID()
  entityId: string;

  @IsString()
  entityType: string;

  @IsUUID()
  targetUserId: string;
}

export class ShareWithDepartmentDto {
  @IsUUID()
  entityId: string;

  @IsString()
  entityType: string;

  @IsUUID()
  departmentId: string;
}

export class RevokeAccessDto {
  @IsUUID()
  entityId: string;

  @IsString()
  entityType: string;

  @IsIn(['USER', 'DEPARTMENT', 'ORGANIZATION'])
  targetType: string;

  @IsUUID()
  targetId: string;
}

// åˆ›å»ºDTO
export class CreatePersonalDocumentDto {
  @IsString()
  @IsNotEmpty()
  title: string;

  @IsString()
  @IsNotEmpty()
  content: string;

  @IsOptional()
  @IsArray()
  @IsString({ each: true })
  tags?: string[];
}

export class UpdatePersonalDocumentDto {
  @IsOptional()
  @IsString()
  @IsNotEmpty()
  title?: string;

  @IsOptional()
  @IsString()
  @IsNotEmpty()
  content?: string;

  @IsOptional()
  @IsArray()
  @IsString({ each: true })
  tags?: string[];
}

export class CreateDepartmentProjectDto {
  @IsString()
  @IsNotEmpty()
  name: string;

  @IsString()
  @IsNotEmpty()
  description: string;
}

export class UpdateDepartmentProjectDto {
  @IsOptional()
  @IsString()
  @IsNotEmpty()
  name?: string;

  @IsOptional()
  @IsString()
  @IsNotEmpty()
  description?: string;

  @IsOptional()
  @IsIn(['planning', 'in_progress', 'completed', 'on_hold', 'cancelled'])
  status?: string;

  @IsOptional()
  @IsDateString()
  endDate?: string;
}

export class AddTeamMemberDto {
  @IsUUID()
  userId: string;
}

export class ExtendToDepartmentsDto {
  @IsArray()
  @IsUUID('4', { each: true })
  departmentIds: string[];
}

export class CreateOrganizationPolicyDto {
  @IsString()
  @IsNotEmpty()
  name: string;

  @IsString()
  @IsNotEmpty()
  content: string;

  @IsIn(['hr', 'finance', 'it', 'security', 'compliance', 'operations'])
  category: string;
}

// å“åº”DTO
export class PersonalDocumentDto {
  id: string;
  title: string;
  content: string;
  tags: string[];
  ownerId: string;
  organizationId?: string;
  departmentIds: string[];
  dataOwnershipType: string;
  dataAccessScope: string;
  createdAt: Date;
  updatedAt: Date;
}

export class DepartmentProjectDto {
  id: string;
  name: string;
  description: string;
  status: string;
  startDate: Date;
  endDate?: Date;
  teamMembers: string[];
  ownerId: string;
  organizationId: string;
  departmentIds: string[];
  dataOwnershipType: string;
  dataAccessScope: string;
  createdAt: Date;
  updatedAt: Date;
}

export class OrganizationPolicyDto {
  id: string;
  name: string;
  content: string;
  category: string;
  version: string;
  effectiveDate: Date;
  expiryDate?: Date;
  approvalStatus: string;
  approvedBy?: string;
  approvedAt?: Date;
  ownerId: string;
  organizationId: string;
  dataOwnershipType: string;
  dataAccessScope: string;
  createdAt: Date;
  updatedAt: Date;
}

export class DataAccessPermissionsDto {
  ownerId: string;
  dataOwnershipType: string;
  dataAccessScope: string;
  sharedWithUsers: string[];
  sharedWithDepartments: string[];
  sharedWithOrganizations: string[];
}
```

## ğŸ¯ API è®¾è®¡ç­–ç•¥ä¸GraphQLé›†æˆ

### RESTful API vs GraphQL åˆ†å·¥

#### RESTful API èŒè´£ï¼ˆå‘½ä»¤ç«¯ï¼‰
- **ç”¨æˆ·ç®¡ç†**: `POST /api/users` - åˆ›å»ºç”¨æˆ·
- **è®¤è¯æ“ä½œ**: `POST /api/auth/login` - ç”¨æˆ·ç™»å½•
- **æƒé™ç®¡ç†**: `POST /api/permissions/grant` - æˆäºˆæƒé™
- **ç»„ç»‡ç®¡ç†**: `POST /api/organizations` - åˆ›å»ºç»„ç»‡

#### GraphQL èŒè´£ï¼ˆæŸ¥è¯¢ç«¯ï¼‰
- **å¤æ‚æŸ¥è¯¢**: ç”¨æˆ·åŠå…¶å…³è”æ•°æ®ï¼ˆæƒé™ã€ç»„ç»‡ã€å®¡è®¡æ—¥å¿—ï¼‰
- **çµæ´»æŸ¥è¯¢**: æ ¹æ®å‰ç«¯éœ€æ±‚åŠ¨æ€è·å–æ•°æ®
- **æ‰¹é‡æŸ¥è¯¢**: å‡å°‘ç½‘ç»œè¯·æ±‚ï¼Œæå‡å‰ç«¯æ€§èƒ½
- **å®æ—¶æ•°æ®**: é€šè¿‡ WebSocket è®¢é˜…æ•°æ®å˜æ›´

### ä½¿ç”¨åœºæ™¯å¯¹æ¯”

| åœºæ™¯ | RESTful API | GraphQL |
|------|-------------|---------|
| **ç”¨æˆ·æ³¨å†Œ** | âœ… é€‚åˆ | âŒ ä¸é€‚åˆ |
| **ç”¨æˆ·ç™»å½•** | âœ… é€‚åˆ | âŒ ä¸é€‚åˆ |
| **è·å–ç”¨æˆ·è¯¦æƒ…** | âš ï¸ éœ€è¦å¤šæ¬¡è¯·æ±‚ | âœ… ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ® |
| **æƒé™æ£€æŸ¥** | âš ï¸ éœ€è¦é¢å¤–è¯·æ±‚ | âœ… åŒ…å«åœ¨ç”¨æˆ·æŸ¥è¯¢ä¸­ |
| **ç»„ç»‡æ¶æ„æŸ¥è¯¢** | âš ï¸ éœ€è¦å¤šä¸ªç«¯ç‚¹ | âœ… åµŒå¥—æŸ¥è¯¢ |
| **å®¡è®¡æ—¥å¿—æŸ¥è¯¢** | âš ï¸ éœ€è¦åˆ†é¡µå¤„ç† | âœ… æ”¯æŒå¤æ‚è¿‡æ»¤ |

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

```typescript
// GraphQL æŸ¥è¯¢ä¼˜åŒ–
@Injectable()
export class GraphQLDataLoader {
  constructor(private readonly queryBus: QueryBus) {}

  // æ‰¹é‡åŠ è½½ç”¨æˆ·æƒé™
  async loadUserPermissions(userIds: string[]): Promise<Map<string, Permission[]>> {
    const query = new BatchGetUserPermissionsQuery(userIds);
    const permissions = await this.queryBus.execute(query);

    const result = new Map();
    permissions.forEach(permission => {
      const userPermissions = result.get(permission.userId) || [];
      userPermissions.push(permission);
      result.set(permission.userId, userPermissions);
    });

    return result;
  }

  // æ‰¹é‡åŠ è½½ç»„ç»‡ä¿¡æ¯
  async loadOrganizations(orgIds: string[]): Promise<Map<string, Organization>> {
    const query = new BatchGetOrganizationsQuery(orgIds);
    const organizations = await this.queryBus.execute(query);

    return new Map(organizations.map(org => [org.id, org]));
  }
}
````

// è®¤è¯ API
@Controller('api/auth')
export class AuthController {
constructor(private readonly authService: AuthService) {}

@Post('login')
async login(@Body() loginDto: LoginDto): Promise<LoginResponseDto> {
return this.authService.login(loginDto);
}

@Post('logout')
@UseGuards(AuthGuard)
async logout(@Request() req): Promise<void> {
return this.authService.logout(req.user.id, req.sessionId);
}

@Post('refresh')
async refreshToken(
@Body() refreshDto: RefreshTokenDto
): Promise<LoginResponseDto> {
return this.authService.refreshToken(refreshDto.refreshToken);
}

@Post('mfa/setup')
@UseGuards(AuthGuard)
async setupMFA(
@Body() mfaSetupDto: MFASetupDto
): Promise<MFASetupResponseDto> {
return this.authService.setupMFA(req.user.id, mfaSetupDto);
}

@Post('mfa/verify')
async verifyMFA(
@Body() mfaVerifyDto: MFAVerifyDto
): Promise<LoginResponseDto> {
return this.authService.verifyMFA(mfaVerifyDto);
}

@Post('password/reset/request')
async requestPasswordReset(
@Body() resetRequestDto: PasswordResetRequestDto
): Promise<void> {
return this.authService.requestPasswordReset(resetRequestDto.email);
}

@Post('password/reset/confirm')
async confirmPasswordReset(
@Body() resetConfirmDto: PasswordResetConfirmDto
): Promise<void> {
return this.authService.confirmPasswordReset(resetConfirmDto);
}

@Post('email/verify/request')
@UseGuards(AuthGuard)
async requestEmailVerification(@Request() req): Promise<void> {
return this.authService.requestEmailVerification(req.user.id);
}

@Post('email/verify/confirm')
async confirmEmailVerification(
@Body() emailVerifyDto: EmailVerificationDto
): Promise<void> {
return this.authService.confirmEmailVerification(emailVerifyDto);
}
}

// DTO å®šä¹‰
export class CreateUserDto {
@IsString()
@IsNotEmpty()
username: string;

@IsEmail()
email: string;

@IsString()
@MinLength(8)
password: string;

@IsString()
@IsOptional()
firstName?: string;

@IsString()
@IsOptional()
lastName?: string;
}

// Use Case è¯·æ±‚/å“åº” DTO
export class CreateUserRequest {
constructor(
public readonly username: string,
public readonly email: string,
public readonly password: string,
public readonly tenantId?: string,
public readonly currentUserId: string
) {}
}

export class CreateUserResponse {
constructor(
public readonly userId: string,
public readonly success: boolean
) {}
}

export class ChangeUserEmailRequest {
constructor(
public readonly userId: string,
public readonly newEmail: string,
public readonly currentUserId: string
) {}
}

export class ChangeUserEmailResponse {
constructor(
public readonly success: boolean
) {}
}

export class JoinTenantRequest {
constructor(
public readonly userId: string,
public readonly tenantId: string,
public readonly currentUserId: string
) {}
}

export class JoinTenantResponse {
constructor(
public readonly success: boolean
) {}
}

export class LeaveTenantRequest {
constructor(
public readonly userId: string,
public readonly currentUserId: string
) {}
}

export class LeaveTenantResponse {
constructor(
public readonly success: boolean
) {}
}

export class GetUserRequest {
constructor(
public readonly userId: string,
public readonly currentUserId: string
) {}
}

export class GetUserResponse {
constructor(
public readonly user: UserResponseDto,
public readonly success: boolean
) {}
}

export class GetUsersRequest {
constructor(
public readonly tenantId: string,
public readonly page: number,
public readonly size: number,
public readonly currentUserId: string
) {}
}

export class GetUsersResponse {
constructor(
public readonly users: PaginatedResponse<UserResponseDto>,
public readonly success: boolean
) {}
}

export class GetUserPermissionsRequest {
constructor(
public readonly userId: string,
public readonly currentUserId: string
) {}
}

export class GetUserPermissionsResponse {
constructor(
public readonly permissions: PermissionResponseDto[],
public readonly success: boolean
) {}
}

export class GetUserEventsRequest {
constructor(
public readonly userId: string,
public readonly from?: string,
public readonly to?: string,
public readonly page: number,
public readonly size: number,
public readonly currentUserId: string
) {}
}

export class GetUserEventsResponse {
constructor(
public readonly events: PaginatedResponse<DomainEventDto>,
public readonly success: boolean
) {}
}

export class UserResponseDto {
id: string;
username: string;
email: string;
firstName?: string;
lastName?: string;
status: string;
tenantId?: string;
createdAt: Date;
updatedAt: Date;
}

// CQRS ç›¸å…³ DTO
export class ChangeUserEmailDto {
@IsEmail()
newEmail: string;
}

export class JoinTenantDto {
@IsUUID()
tenantId: string;
}

export class GetUsersQueryDto {
@IsUUID()
tenantId: string;

@IsNumber()
@Min(1)
page: number = 1;

@IsNumber()
@Min(1)
@Max(100)
size: number = 20;
}

export class GetUserEventsQueryDto {
@IsDateString()
@IsOptional()
from?: string;

@IsDateString()
@IsOptional()
to?: string;

@IsNumber()
@Min(1)
page: number = 1;

@IsNumber()
@Min(1)
@Max(100)
size: number = 20;
}

export class PaginatedResponse<T> {
data: T[];
total: number;
page: number;
size: number;
totalPages: number;
}

export class DomainEventDto {
eventId: string;
aggregateId: string;
aggregateType: string;
eventType: string;
eventData: any;
metadata: any;
timestamp: Date;
version: number;
}

// è®¤è¯ç›¸å…³ DTO
export class LoginDto {
@IsString()
@IsNotEmpty()
username: string;

@IsString()
@IsNotEmpty()
password: string;

@IsString()
@IsOptional()
mfaCode?: string;

@IsString()
@IsOptional()
tenantId?: string;
}

export class LoginResponseDto {
accessToken: string;
refreshToken: string;
expiresIn: number;
tokenType: string;
user: {
id: string;
username: string;
email: string;
tenantId?: string;
orgIds: string[];
deptIds: string[];
roles: string[];
permissions: string[];
};
}

export class RefreshTokenDto {
@IsString()
@IsNotEmpty()
refreshToken: string;
}

export class MFASetupDto {
@IsString()
@IsIn(['TOTP', 'SMS', 'EMAIL'])
type: string;

@IsString()
@IsOptional()
phoneNumber?: string;
}

export class MFASetupResponseDto {
secretKey?: string;
qrCode?: string;
backupCodes: string[];
}

export class MFAVerifyDto {
@IsString()
@IsNotEmpty()
username: string;

@IsString()
@IsNotEmpty()
password: string;

@IsString()
@IsNotEmpty()
mfaCode: string;

@IsString()
@IsOptional()
tenantId?: string;
}

export class PasswordResetRequestDto {
@IsEmail()
email: string;
}

export class PasswordResetConfirmDto {
@IsString()
@IsNotEmpty()
token: string;

@IsString()
@MinLength(8)
newPassword: string;

@IsString()
@MinLength(8)
confirmPassword: string;
}

export class EmailVerificationDto {
@IsString()
@IsNotEmpty()
token: string;
}
```

### é”™è¯¯å¤„ç†è§„èŒƒ

#### å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨

```typescript
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  constructor(private readonly logger: LoggerService) {}

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();

    let status = 500;
    let message = 'Internal server error';
    let code = 'INTERNAL_ERROR';
    let details: Record<string, unknown> = {};

    if (exception instanceof BusinessException) {
      status = exception.statusCode;
      message = exception.message;
      code = exception.code;
      details = exception.details || {};
    } else if (exception instanceof ValidationException) {
      status = 400;
      message = 'Validation failed';
      code = 'VALIDATION_ERROR';
      details = { errors: exception.errors };
    } else if (exception instanceof Error) {
      message = exception.message;
      code = 'UNKNOWN_ERROR';
    }

    // è®°å½•å¼‚å¸¸æ—¥å¿—
    this.logger.logUserAction(
      'error',
      `Exception occurred: ${message}`,
      {
        userId: request.user?.id,
        tenantId: request.headers['x-tenant-id'],
        path: request.url,
        method: request.method,
      },
      exception as Error
    );

    // è¿”å›ç»Ÿä¸€é”™è¯¯å“åº”
    response.status(status).json({
      success: false,
      error: {
        code,
        message,
        details,
        timestamp: new Date().toISOString(),
        path: request.url,
        requestId: request.headers['x-request-id'],
      },
    });
  }
}
````

## ğŸ“ é™„å½•

### æŠ€æœ¯æœ¯è¯­è¡¨

| æœ¯è¯­           | è‹±æ–‡                                     | å®šä¹‰                 |
| -------------- | ---------------------------------------- | -------------------- |
| IAM            | Identity and Access Management           | èº«ä»½ä¸è®¿é—®ç®¡ç†       |
| DDD            | Domain-Driven Design                     | é¢†åŸŸé©±åŠ¨è®¾è®¡         |
| CQRS           | Command Query Responsibility Segregation | å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»     |
| Event Sourcing | Event Sourcing                           | äº‹ä»¶æº¯æº             |
| RBAC           | Role-Based Access Control                | åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶   |
| ABAC           | Attribute-Based Access Control           | åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶   |
| Data Isolation | Data Isolation                           | æ•°æ®éš”ç¦»             |
| Data Privacy   | Data Privacy                             | æ•°æ®éšç§             |
| JWT            | JSON Web Token                           | JSON ç½‘ç»œä»¤ç‰Œ        |
| TOTP           | Time-based One-Time Password             | åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç  |
| ORM            | Object-Relational Mapping                | å¯¹è±¡å…³ç³»æ˜ å°„         |
| API            | Application Programming Interface        | åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£     |

### å‚è€ƒæ–‡æ¡£
